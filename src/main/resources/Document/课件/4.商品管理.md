# 1. 商品管理（第一阶段）

商品功能比较复杂，表单也比较庞大，这里对商品的功能进行了简化，实际的商品业务要复杂得多。

## 1.1 添加商品

商品表单比较大，因此我们将添加功能单独抽取成一个菜单。

如果一次性将整个表单展示给用户，那体验上将会比较差，因此我们采用分步表单。

- 商品信息：填写商品的一些基本信息，如分类、品牌 、名称
- 商品营销：填写价格、积分、促销价格
- 商品详情：图片、轮播图、详情
- 商品关联：是否关联其他商品打包销售

### 1.1.1 后端

添加功能需要注意的是轮播图，轮播图因为涉及到多张图片，前端一般传递数组，因此后端需要一个Dto去接收

#### ShopProductDto

```java
package com.jg.pochi.pojo.dto;

import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;
import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2020/11/28 20:36
 * @Version 1.0
 */
@Data
public class ShopProductDto implements Serializable {

    /**
     * 商品ID
     */
    private Long id;

    /**
     * 商品名称
     */
    private String name;

    /**
     * 商品图片
     */
    private String pic;

    /**
     * 商品副标题
     */
    private String subTitle;

    /**
     * 价格
     */
    private BigDecimal price;

    /**
     * 库存
     */
    private Integer stock;

    /**
     * 库存预警值
     */
    private Integer lowStock;

    /**
     * 购买积分
     */
    private BigDecimal point;

    /**
     * 轮播图片
     */
    private List<String> albumPicList;

    /**
     * 商品描述
     */
    private String productComment;

    /**
     * 详情
     */
    private String productContent;

    /**
     * 商品分类ID
     */
    private Long categoryId;

    /**
     * 套装编号
     */
    private Long packCode;

    /**
     * 品牌ID
     */
    private Long brandId;

    /**
     * 品牌名称
     */
    private String brandName;

    /**
     * 运费
     */
    private BigDecimal transFee;

    /**
     * 规格
     */
    private String specs;

    /**
     * 是否上架
     */
    private Integer publishStatus;

    /**
     * 是否新品
     */
    private Integer newStatus;

    /**
     * 是否推荐
     */
    private Integer recommendStatus;

    /**
     * 排序
     */
    private Integer sort;

    /**
     * 促销价格
     */
    private BigDecimal promotionPrice;

}

```

#### ShopProduct

```java
package com.jg.pochi.pojo;

import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;

/**
 * @Author: 杨德石
 * @Date: 2020/11/28 20:36
 * @Version 1.0
 */
@Data
public class ShopProduct implements Serializable {

    /**
     * 商品ID
     */
    private Long id;

    /**
     * 商品名称
     */
    private String name;

    /**
     * 商品图片
     */
    private String pic;

    /**
     * 商品副标题
     */
    private String subTitle;

    /**
     * 价格
     */
    private BigDecimal price;

    /**
     * 销量
     */
    private Integer sale;

    /**
     * 评论数
     */
    private Integer commentNum;

    /**
     * 库存
     */
    private Integer stock;

    /**
     * 库存预警值
     */
    private Integer lowStock;

    /**
     * 购买积分
     */
    private BigDecimal point;

    /**
     * 轮播图片
     */
    private String albumPics;

    /**
     * 商品描述
     */
    private String productComment;

    /**
     * 详情
     */
    private String productContent;

    /**
     * 商品分类ID
     */
    private Long categoryId;

    /**
     * 套装编号
     */
    private Long packCode;

    /**
     * 品牌ID
     */
    private Long brandId;

    /**
     * 品牌名称
     * 优点：这里存储了品牌名称，那么在页面展示商品属于哪个品牌时，直接展示即可，不需要多连一张表耗费性能
     * 当一张表的某个字段可以确定基本上不可能被修改时 ，这个字段在设计数据库的时候就允许被冗余到其他表中
     */
    private String brandName;

    /**
     * 运费
     */
    private BigDecimal transFee;

    /**
     * 规格
     */
    private String specs;

    /**
     * 是否上架
     */
    private Integer publishStatus;

    /**
     * 是否新品
     */
    private Integer newStatus;

    /**
     * 是否推荐
     */
    private Integer recommendStatus;

    /**
     * 是否审核
     */
    private Integer verifyStatus;

    /**
     * 排序
     */
    private Integer sort;

    /**
     * 促销价格
     */
    private BigDecimal promotionPrice;

    /**
     * 创建时间
     */
    private String createTime;

    /**
     * 修改时间
     */
    private String updateTime;

    /**
     * 是否删除
     */
    private Integer deleted;

    /**
     * 创建人
     */
    private String createBy;

    /**
     * 修改人
     */
    private String updateBy;

}

```

#### ShopProductController-save

```java
package com.jg.pochi.controller;

import com.jg.pochi.common.Result;
import com.jg.pochi.pojo.dto.ShopProductDto;
import com.jg.pochi.service.ShopProductService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

/**
 * @Author: 杨德石
 * @Date: 2020/11/24 23:38
 * @Version 1.0
 */
@RestController
@RequestMapping("/product")
public class ShopProductController {

    @Autowired
    private ShopProductService shopProductService;

    /**
     * 添加商品
     * @param shopProductDto
     * @return
     */
    @RequestMapping(value = "/save", method = RequestMethod.POST)
    public Result<?> save(@RequestBody ShopProductDto shopProductDto) {
        shopProductService.save(shopProductDto);
        return new Result<>("添加成功");
    }


}

```



#### ShopProductService-save

```java
package com.jg.pochi.service;

import com.jg.pochi.pojo.dto.ShopProductDto;

/**
 * @Author: 杨德石
 * @Date: 2020/11/24 23:37
 * @Version 1.0
 */
public interface ShopProductService {

    /**
     * 添加商品
     * @param shopProductDto
     */
    void save(ShopProductDto shopProductDto);
}

```

#### ShopProductServiceImpl-save

商品表的设计有些特殊，这里存在了一个 **冗余字段** —— 品牌名称。这么设计违反了数据库的三大范式，看似不合理，实际是有好处的。

首先我们讨论一下冗余字段的优缺点。

* 优点：这里存了品牌名称，在页面需要展示商品属于哪个品牌时，直接展示即可，不需要多连一张表耗费性能。
* 缺点：扩展性差，一旦品牌表的名称进行了修改，所影响的商品表数据可能是几万条甚至十万、百万条。

我们思考一下，现实中品牌的名称是不可能被修改的。这就像一个公司一样，公司名称一旦被注册就不能修改，如果修改的话也只能注册一个新的公司。

关于品牌，我们再想一些实际的案例。

* 蒙牛老板牛根生，将蒙牛捐给国家之后，又创建了伊利这个品牌
* 2012年，淘宝商城正式 “更名” 为天猫。事实上是重新注册了一个名为 “天猫” 的商标，“淘宝商城” 商标现在依然可以查到。

结合现实我们发现，品牌一旦确定，几乎不能更换，因此在我们系统的设计中，也就不需要考虑品牌被更换的情况了（这里在品牌管理最好禁止修改名称）。因此我们将品牌名称存入商品表，这样就可以在查询商品信息的时候少关联一张表，从而提高性能。

简单来说就是一句话：**当一张表的某个字段可以确定不可能被修改时，这个字段在设计数据表的时候就允许冗余到其他表中**。

事实上我们后面学习订单功能的时候，也会见到冗余字段。

```java
package com.jg.pochi.service.impl;

import com.jg.pochi.mapper.ShopBrandMapper;
import com.jg.pochi.mapper.ShopProductMapper;
import com.jg.pochi.pojo.ShopBrand;
import com.jg.pochi.pojo.ShopProduct;
import com.jg.pochi.pojo.dto.ShopProductDto;
import com.jg.pochi.pojo.vo.SysUserVo;
import com.jg.pochi.service.ShopProductService;
import com.jg.pochi.utils.IdWorker;
import com.jg.pochi.utils.ShiroUtils;
import com.jg.pochi.utils.StringUtils;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.CollectionUtils;

/**
 * @Author: 杨德石
 * @Date: 2020/11/24 23:38
 * @Version 1.0
 */
@Service
public class ShopProductServiceImpl implements ShopProductService {

    @Autowired
    private IdWorker idWorker;
    @Autowired
    private ShopProductMapper shopProductMapper;
    @Autowired
    private ShopBrandMapper shopBrandMapper;

    @Override
    public void save(ShopProductDto shopProductDto) {
        // 转换成ShopProduct
        ShopProduct shopProduct = new ShopProduct();
        BeanUtils.copyProperties(shopProductDto, shopProduct);
        shopProduct.setId(idWorker.nextId());
        // 处理轮播图
        if(!CollectionUtils.isEmpty(shopProductDto.getAlbumPicList())) {
            // 转成一个字符串，使用 , 拼接
            shopProduct.setAlbumPics(StringUtils.join(shopProductDto.getAlbumPicList(), ","));
        }else {
            // 用商品图片代替
            shopProduct.setAlbumPics(shopProduct.getPic());
        }
        /*
            品牌名称
            一般来讲，任何场景下我们都不能信任前端所传递的参数
            我们只能接收前端传递的品牌ID，名称我们自己去表里查
            如果我们系统的安全性做的比较足的话
            那么前端参数被伪造的概率是相当低的
            这个时候我们就可以相信前端传的参数
            我们本次课程系统安全性较差，因此不相信前端的参数
         */
        ShopBrand brand = shopBrandMapper.get(shopProduct.getBrandId());
        shopProduct.setBrandName(brand.getName());
        // 创建人、修改人
        SysUserVo loginUser = ShiroUtils.getLoginUser();
        shopProduct.setCreateBy(loginUser.getUsername());
        shopProduct.setUpdateBy(loginUser.getUsername());
        shopProductMapper.save(shopProduct);
    }
}

```



#### ShopProductMapper-save

```java
package com.jg.pochi.mapper;

import com.jg.pochi.pojo.ShopProduct;
import org.springframework.stereotype.Component;

/**
 * @Author: 杨德石
 * @Date: 2020/11/8 13:46
 * @Version 1.0
 */
@Component
public interface ShopProductMapper {

    /**
     * 保存
     * @param shopProduct
     */
    void save(ShopProduct shopProduct);
}

```



#### ShopProductMapper.xml-save

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jg.pochi.mapper.ShopProductMapper">
    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.jg.pochi.pojo.ShopProduct">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="pic" property="pic"/>
        <result column="sub_title" property="subTitle"/>
        <result column="price" property="price"/>
        <result column="sale" property="sale"/>
        <result column="comment_num" property="commentNum"/>
        <result column="stock" property="stock"/>
        <result column="low_stock" property="lowStock"/>
        <result column="point" property="point"/>
        <result column="album_pics" property="albumPics"/>
        <result column="product_comment" property="productComment"/>
        <result column="product_content" property="productContent"/>
        <result column="category_id" property="categoryId"/>
        <result column="pack_code" property="packCode"/>
        <result column="brand_id" property="brandId"/>
        <result column="brand_name" property="brandName"/>
        <result column="trans_fee" property="transFee"/>
        <result column="specs" property="specs"/>
        <result column="publish_status" property="publishStatus"/>
        <result column="new_status" property="newStatus"/>
        <result column="recommend_status" property="recommendStatus"/>
        <result column="verify_status" property="verifyStatus"/>
        <result column="sort" property="sort"/>
        <result column="promotion_price" property="promotionPrice"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="creat_by" property="createBy"/>
        <result column="update_by" property="updateBy"/>
        <result column="deleted" property="deleted"/>
    </resultMap>
    <insert id="save">
        insert into shop_product(id, name, pic, sub_title, price, stock, low_stock, point,
                                 album_pics, product_comment, product_content, category_id, pack_code, brand_id,
                                 brand_name, trans_fee, specs, publish_status, new_status, recommend_status,
                                 sort, promotion_price, create_by, update_by)
        values (#{id}, #{name}, #{pic}, #{subTitle}, #{price}, #{stock}, #{lowStock}, #{point},
                #{albumPics}, #{productComment}, #{productContent}, #{categoryId}, #{packCode}, #{brandId},
                #{brandName}, #{transFee}, #{specs}, #{publishStatus}, #{newStatus}, #{recommendStatus},
                #{sort}, #{promotionPrice}, #{createBy}, #{updateBy})
    </insert>


</mapper>

```



### 1.1.2 前端

#### API

在 `api` 下创建 `shopProduct.js` ，加入添加接口的api

```js'
  save(shopPayOrder) { // 保存
    return request({
      url: `/${group_name}/save`,
      method: 'post',
      data: shopPayOrder
    })
  },
```

#### 页面编写

在 `views` 下创建 `product/product` 目录，在下面创建 `product-add.vue` 文件，并配置路由菜单。

```vue
<template>
  <div>
    <el-card class="product-card" shadow="never">
      <!-- 步骤条 -->
      <el-steps align-center :active="activeStep" finish-status="success">
        <el-step title="商品信息" />
        <el-step title="商品营销" />
        <el-step title="商品详情" />
        <el-step title="商品关联" />
      </el-steps>
      <!-- 步骤条结束 -->
      <!-- 商品表单 -->
      <el-form :model="shopProduct" class="form" label-width="80px" size="small">
        <!-- 商品详情 -->
        <div v-show="activeStep===0" class="product-info">
          <el-row :gutter="20">
            <el-col :span="12" :offset="0">
              <el-form-item label="商品分类">
                <el-cascader
                  v-model="activeCategory"
                  clearable
                  filterable
                  placeholder="选择分类"
                  style="width: 100%"
                  :options="categoryTree"
                  :props="{ expandTrigger: 'hover', value: 'id', label: 'name' }"
                  @change="changeCategory"
                />
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="商品品牌">
                <el-select v-model="shopProduct.brandId" style="width: 100%" placeholder="选择品牌" clearable filterable>
                  <el-option
                    v-for="item in brandList"
                    :key="item.id"
                    :label="item.name"
                    :value="item.id"
                  />
                </el-select>

              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="24" :offset="0">
              <el-form-item label="商品标题">
                <el-input v-model="shopProduct.name" placeholder="商品标题" clearable />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="24" :offset="0">
              <el-form-item label="副标题 ">
                <el-input v-model="shopProduct.subTitle" placeholder="副标题" clearable />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12" :offset="0">
              <el-form-item label="库存">
                <el-input-number v-model="shopProduct.stock" style="width: 100%" controls-position="right" :min="1" placeholder="库存" clearable />
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="警戒库存">
                <el-input-number v-model="shopProduct.lowStock" :max="shopProduct.stock" style="width: 100%" controls-position="right" :min="1" placeholder="警戒库存" clearable />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12" :offset="0">
              <el-form-item label="排序">
                <el-input-number v-model="shopProduct.sort" style="width: 100%" controls-position="right" :min="1" placeholder="排序" clearable />
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="规格">
                <el-input v-model="shopProduct.specs" placeholder="规格" clearable />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="24" :offset="0">
              <el-form-item label="商品描述">
                <el-input v-model="shopProduct.productComment" type="textarea" :rows="4" placeholder="商品描述" clearable />
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item>
            <el-button type="primary" @click="activeStep++">下一步，填写商品营销</el-button>
          </el-form-item>
        </div>
        <!-- 商品详情结束 -->
        <!-- 商品营销 -->
        <div v-show="activeStep === 1" class="product-info">
          <el-row :gutter="20">
            <el-col :span="24" :offset="0">
              <el-form-item label="价格">
                <el-input-number v-model="shopProduct.price" style="width: 100%" controls-position="right" placeholder="价格" clearable />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="24" :offset="0">
              <el-form-item label="上架">
                <el-switch
                  v-model="shopProduct.publishStatus"
                  :active-value="1"
                  :inactive-value="0"
                />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="24" :offset="0">
              <el-form-item label="新品">
                <el-switch
                  v-model="shopProduct.newStatus"
                  :active-value="1"
                  :inactive-value="0"
                />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="24" :offset="0">
              <el-form-item label="推荐">
                <el-switch
                  v-model="shopProduct.recommendStatus"
                  :active-value="1"
                  :inactive-value="0"
                />
              </el-form-item>
            </el-col>
          </el-row>

          <el-row :gutter="20">
            <el-col :span="12" :offset="0">
              <el-form-item label="积分">
                <el-input-number v-model="shopProduct.point" style="width: 100%" controls-position="right" placeholder="积分" clearable />
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="运费">
                <el-input-number v-model="shopProduct.transFee" style="width: 100%" controls-position="right" placeholder="运费" clearable />
              </el-form-item>
            </el-col>
          </el-row>

          <el-form-item>
            <el-button @click="activeStep--">上一步，填写商品信息</el-button>
            <el-button type="primary" @click="activeStep++">下一步，填写商品详情</el-button>
          </el-form-item>
        </div>
        <!-- 商品营销结束 -->
        <!-- 商品详情开始 -->
        <div v-show="activeStep === 2" class="product-info">
          <el-row :gutter="20">
            <el-col :span="24" :offset="0">
              <el-form-item label="商品图片">
                <el-upload
                  class="avatar-uploader"
                  :action="uploadUrl"
                  :show-file-list="false"
                  :data="{dir: 'product'}"
                  :headers="{Authorization: token}"
                  :on-success="handleAvatarSuccess"
                >
                  <img v-if="imageUrl" :src="imageUrl" class="avatar">
                  <i v-else class="el-icon-plus avatar-uploader-icon" />
                </el-upload>
                <div class="danger-text">
                  请上传封面图片，该图片用于 列表页展示
                </div>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="24" :offset="0">
              <el-form-item label="轮播图">
                <el-upload
                  class="avatar-uploader"
                  :action="uploadUrl"
                  list-type="picture-card"
                  :data="{dir: 'product'}"
                  :headers="{Authorization: token}"
                  :on-success="handleBannerSuccess"
                  :on-remove="handleRemove"
                >
                  <i class="el-icon-plus" />
                </el-upload>
                <div class="danger-text">
                  请上传商品详情轮播图，如果不上传，默认采用上面的图片展示
                </div>
              </el-form-item>
            </el-col>
          </el-row>

          <el-row :gutter="20">
            <el-col :span="24" :offset="0">
              <el-form-item label="商品详情">
                <div class="danger-text">
                  商品详情建议采用上传多图的方式。文字过多可能会影响加载效果
                </div>
                <tinymce v-model="shopProduct.productContent" :height="500" />
              </el-form-item>
            </el-col>
          </el-row>

          <el-form-item>
            <el-button @click="activeStep--">上一步，填写商品营销</el-button>
            <el-button type="primary" @click="activeStep++">下一步，填写商品关联</el-button>
          </el-form-item>
        </div>
        <!-- 商品详情结束 -->
        <!-- 商品关联 -->
        <div v-show="activeStep === 3" class="product-info">
          <el-form-item>
            <el-button @click="activeStep--">上一步，填写商品营销</el-button>
            <el-button type="primary" @click="add">提交</el-button>
          </el-form-item>
        </div>
        <!-- 商品关联结束 -->
      </el-form>
      <!-- 商品表单结束 -->

    </el-card>
  </div>
</template>

<script>
import categoryApi from '@/api/shop-product-category'
import brandApi from '@/api/shop-brand'
import productApi from '@/api/shop-product'
import Tinymce from '@/components/Tinymce'
import { mapGetters } from 'vuex'
export default {
  components: { Tinymce },
  data() {
    return {
      // 当前选中的步骤条
      activeStep: 0,
      // 表单对象
      shopProduct: {},
      // 当前选中的分类
      activeCategory: [],
      // 商品分类树
      categoryTree: [],
      // 品牌数组
      brandList: [],
      // 文件上传路径
      uploadUrl: process.env.VUE_APP_UPLOAD_URL,
      // 图片回显地址
      imageUrl: null,
      // 存放临时的轮播图
      albumPicList: []
    }
  },
  computed: {
    ...mapGetters([
      'token'
    ])
  },
  created() {
    this.getCatgortTree()
  },
  methods: {
    // 查询分类树
    getCatgortTree() {
      categoryApi.getTree().then(res => {
        this.categoryTree = res.data
      })
    },
    // 根据分类ID查询商品品牌列表
    getBrandByCategoryId() {
      brandApi.getByCategoryId(this.shopProduct.categoryId).then(res => {
        this.brandList = res.data
      })
    },
    // 选中的分类发生变化时触发
    changeCategory(item) {
      if (!item || !item[0]) {
        this.brandList = []
        this.$set(this.shopProduct, 'brandId', null)
        this.$set(this.shopProduct, 'categoryId', null)
        return
      }
      // 取出最后一个分类ID
      const leafCategory = item[item.length - 1]
      // 赋值给商品分类ID
      this.$set(this.shopProduct, 'categoryId', leafCategory)
      // 加载品牌
      this.getBrandByCategoryId()
    },
    // 上传图片成功后的回调
    handleAvatarSuccess(res, file) {
      this.$message.success(res.msg)
      this.imageUrl = res.data
      this.shopProduct.pic = this.imageUrl
    },
    // 删除轮播图触发
    handleRemove(file, fileList) {
      // 根据uid去删除
      this.albumPicList.splice(
        this.albumPicList.findIndex(e => e.uid === file.uid),
        1
      )
    },
    // 上传轮播图触发
    handleBannerSuccess(res, file) {
      this.albumPicList.push({
        uid: file.uid,
        url: res.data
      })
    },
    // 提交表单
    add() {
      const albumPicList = []
      this.albumPicList.forEach(e => albumPicList.push(e.url))
      this.shopProduct.albumPicList = albumPicList
      productApi.save(this.shopProduct).then(res => {
        this.$message.success(res.msg)
      })
    }
  }
}
</script>

<style scoped>
  .product-card {
    width: 800px;
    margin: auto;
    padding: 20px;
  }
  .form {
    margin-top: 50px;
  }
  .danger-text {
    color: red;
  }
</style>

<style>
  .avatar-uploader .el-upload {
    border: 1px dashed #d9d9d9;
    border-radius: 6px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }
  .avatar-uploader .el-upload:hover {
    border-color: #409EFF;
  }
  .avatar-uploader-icon {
    font-size: 28px;
    color: #8c939d;
    width: 178px;
    height: 300px;
    line-height: 300px;
    text-align: center;
  }
  .avatar {
    width: 178px;
    height: 300px;
    display: block;
  }
</style>

```

>  商品关联我们目前不知道是什么意思，就先不做它。
>
>  级联选择器默认传的是数组，没法重写，因此在提交时我们需要进行修改。

## 1.2 商品列表

商品列表功能相对添加就比较简单了，我们快速的把列表功能编写完毕。

### 1.2.1 后端

我们的轮播图是使用逗号分隔的，因此需要在后端进行拆分，提供给前端展示。

#### ShopProductVo

```java
package com.jg.pochi.pojo.vo;

import com.jg.pochi.pojo.ShopProductCategory;
import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;
import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2020/11/28 20:36
 * @Version 1.0
 */
@Data
public class ShopProductVo implements Serializable {

    /**
     * 商品ID
     */
    private Long id;

    /**
     * 商品名称
     */
    private String name;

    /**
     * 商品图片
     */
    private String pic;

    /**
     * 商品副标题
     */
    private String subTitle;

    /**
     * 价格
     */
    private BigDecimal price;

    /**
     * 销量
     */
    private Integer sale;

    /**
     * 评论数
     */
    private Integer commentNum;

    /**
     * 库存
     */
    private Integer stock;

    /**
     * 库存预警值
     */
    private Integer lowStock;

    /**
     * 购买积分
     */
    private BigDecimal point;

    /**
     * 轮播图片
     */
    private List<String> albumPicList;

    /**
     * 商品描述
     */
    private String productComment;

    /**
     * 详情
     */
    private String productContent;

    /**
     * 商品分类ID
     */
    private Long categoryId;

    /**
     * 商品分类
     */
    private ShopProductCategory category;

    /**
     * 套装编号
     */
    private Long packCode;

    /**
     * 品牌ID
     */
    private Long brandId;

    /**
     * 品牌名称
     * 优点：这里存储了品牌名称，那么在页面展示商品属于哪个品牌时，直接展示即可，不需要多连一张表耗费性能
     * 当一张表的某个字段可以确定基本上不可能被修改时 ，这个字段在设计数据库的时候就允许被冗余到其他表中
     */
    private String brandName;

    /**
     * 运费
     */
    private BigDecimal transFee;

    /**
     * 规格
     */
    private String specs;

    /**
     * 是否上架
     */
    private Integer publishStatus;

    /**
     * 是否新品
     */
    private Integer newStatus;

    /**
     * 是否推荐
     */
    private Integer recommendStatus;

    /**
     * 是否审核
     */
    private Integer verifyStatus;

    /**
     * 排序
     */
    private Integer sort;

    /**
     * 促销价格
     */
    private BigDecimal promotionPrice;

    /**
     * 创建时间
     */
    private String createTime;

    /**
     * 修改时间
     */
    private String updateTime;

    /**
     * 是否删除
     */
    private Integer deleted;

    /**
     * 创建人
     */
    private String createBy;

    /**
     * 修改人
     */
    private String updateBy;

}

```



#### ShopProductController-getByPage

```java
    /**
     * 分页查询
     * @param page
     * @return
     */
    @RequestMapping(value = "/getByPage", method = RequestMethod.POST)
    public Result<Page<ShopProductVo>> getByPage(@RequestBody Page<ShopProductVo> page) {
        page = shopProductService.getByPage(page);
        return new Result<>(page);
    }
```



#### ShopProductService-getByPage

```java

    /**
     * 分页查询
     * @param page
     * @return
     */
    Page<ShopProductVo> getByPage(Page<ShopProductVo> page);
```



#### ShopProductServiceImpl-getByPage

```java
    @Override
    public Page<ShopProductVo> getByPage(Page<ShopProductVo> page) {
        // 查询list和总条数
        List<ShopProduct> list = shopProductMapper.getByPage(page);
        Integer totalCount = shopProductMapper.countByPage(page);
        // ShopProduct的list转成vo的list
        List<ShopProductVo> productVoList = list.stream().map(e -> {
            ShopProductVo vo = new ShopProductVo();
            BeanUtils.copyProperties(e, vo);
            // 处理一下轮播图
            String albumPics = e.getAlbumPics();
            if (StringUtils.isNotBlank(albumPics)) {
                // 转成集合
                vo.setAlbumPicList(Arrays.asList(albumPics.split(",")));
            }
            return vo;
        }).collect(Collectors.toList());
        // 处理分类名称
        List<Long> categoryIds = productVoList.stream().map(ShopProductVo::getCategoryId).collect(Collectors.toList());
        List<ShopProductCategory> categoryList = shopProductCategoryMapper.getByIds(categoryIds);
        // 封装进去
        productVoList.forEach(e -> {
            ShopProductCategory category = categoryList.stream().filter(c -> c.getId().equals(e.getCategoryId())).findFirst().orElse(new ShopProductCategory());
            e.setCategory(category);
        });
        page.setList(productVoList);
        page.setTotalCount(totalCount);
        return page;
    }
```



#### ShopProductMapper-getByPage

```java
    /**
     * 分页查询
     *
     * @param page
     * @return
     */
    List<ShopProduct> getByPage(Page<ShopProductVo> page);

    /**
     * 查询总数
     *
     * @param page
     * @return
     */
    Integer countByPage(Page<ShopProductVo> page);
```



#### ShopProductMapper.xml-getByPage

```xml
    <select id="getByPage" resultMap="BaseResultMap">
        select id,
        name,
        pic,
        sub_title,
        price,
        sale,
        comment_num,
        stock,
        low_stock,
        point,
        album_pics,
        category_id,
        brand_id,
        brand_name,
        trans_fee,
        specs,
        publish_status,
        new_status,
        recommend_status,
        sort,
        promotion_price,
        create_time,
        update_time,
        create_by,
        update_by
        from shop_product
        where deleted = 0
        <if test="params.name!=null and params.name!=''">
            and name like concat('%', #{params.name},'%')
        </if>
        <if test="params.createBy!=null and params.createBy!=''">
            and create_by = #{params.createBy}
        </if>
        <if test="params.publishStatus!=null and params.publishStatus!=''">
            and publish_status = #{params.publishStatus}
        </if>
        <if test="params.newStatus!=null and params.newStatus!=''">
            and new_status = #{params.newStatus}
        </if>
        <if test="params.recommendStatus!=null and params.recommendStatus!=''">
            and recommend_status = #{params.recommendStatus}
        </if>
        <if test="params.brandId!=null and params.brandId!=''">
            and brand_id = #{params.brandId}
        </if>
        order by sort
        limit #{index}, #{pageSize}
    </select>
    <select id="countByPage" resultType="java.lang.Integer">
        select count(*)
        from shop_product
        where deleted = 0
        <if test="params.name!=null and params.name!=''">
            and name like concat('%', #{params.name},'%')
        </if>
        <if test="params.createBy!=null and params.createBy!=''">
            and create_by = #{params.createBy}
        </if>
        <if test="params.publishStatus!=null and params.publishStatus!=''">
            and publish_status = #{params.publishStatus}
        </if>
        <if test="params.newStatus!=null and params.newStatus!=''">
            and new_status = #{params.newStatus}
        </if>
        <if test="params.recommendStatus!=null and params.recommendStatus!=''">
            and recommend_status = #{params.recommendStatus}
        </if>
        <if test="params.brandId!=null and params.brandId!=''">
            and brand_id = #{params.brandId}
        </if>
    </select>
```



### 1.2.2 前端

相较于后端，商品列表的前端就稍微简单一些了，其实就是个列表展示的功能。

#### API

在 `shopProduct.js` 中加入内容

```js
getByPage(page) { // 分页查询
    return request({
      url: `/${group_name}/getByPage`,
      method: 'post',
      data: page
    })
  },
```

#### 页面编写

在 `views/product/product` 下创建 `product-list.vue`，并配置路由。

```vue
<template>
  <div>
    <!-- 搜索框 -->
    <div class="search-form">
      <el-form :model="page.params" :inline="true" size="small">
        <el-form-item>
          <el-input v-model="page.params.name" clearable placeholder="商品名称" />
        </el-form-item>
        <el-form-item>
          <el-input v-model="page.params.createBy" clearable placeholder="创建人" />
        </el-form-item>
        <el-form-item>
          <el-select v-model="page.params.publishStatus" placeholder="上架" clearable>
            <el-option label="上架" :value="1" />
            <el-option label="下架" :value="0" />
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-select v-model="page.params.newStatus" placeholder="新品" clearable>
            <el-option label="是" :value="1" />
            <el-option label="否" :value="0" />
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-select v-model="page.params.recommendStatus" placeholder="推荐" clearable>
            <el-option label="是" :value="1" />
            <el-option label="否" :value="0" />
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-select
            v-model="page.params.brandId"
            filterable
            remote
            :remote-method="getBrandList"
            placeholder="品牌"
            clearable
          >
            <el-option
              v-for="item in brandList"
              :key="item.id"
              :label="item.name"
              :value="item.id"
            />
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" icon="el-icon-search" @click="search">查询</el-button>
          <el-button type="warning" icon="el-icon-refresh" @click="page.params = {}">重置</el-button>
        </el-form-item>
      </el-form>
    </div>
    <!-- 搜索框结束 -->
    <!-- 操作按钮组 -->
    <div class="button-group">
      <el-button type="primary" size="small" icon="el-icon-plus" @click="toAdd">添加</el-button>
    </div>
    <!-- 操作按钮组结束 -->
    <div class="data-table">
      <el-table
        header-row-class-name="pochi-table-header"
        :data="dataPage.list"
        stripe
        style="width: 100%"
      >
        <el-table-column prop="name" label="标题" width="200px" />
        <el-table-column prop="pic" align="center" width="200px" label="图片">
          <template slot-scope="{row}">
            <el-image :src="row.pic" style="width: 200px; height: 250px" fit="fill" :preview-src-list="[row.pic]" />
          </template>
        </el-table-column>
        <el-table-column prop="albumPicList" align="center" label="轮播图" width="200px">
          <template slot-scope="{row}">
            <div class="carousel">
              <el-carousel height="250px" arrow="never" indicator-position="none">
                <el-carousel-item v-for="item in row.albumPicList" :key="item">
                  <el-image style="width: 200px; height: 250px" :src="item" fit="fill" />
                </el-carousel-item>
              </el-carousel>
            </div>
          </template>
        </el-table-column>
        <el-table-column prop="price" label="价格" width="80px" />
        <el-table-column prop="stock" label="库存" width="80px" />
        <el-table-column prop="lowStock" label="预警库存" width="100px" />
        <el-table-column prop="sale" label="销量" width="80px" />
        <el-table-column prop="commentNum" label="评论数" width="100px" />
        <el-table-column prop="point" label="购买积分" width="100px" />
        <el-table-column prop="category.name" label="分类" width="120px" />
        <el-table-column prop="brandName" label="品牌" width="120px" />
        <el-table-column prop="transFee" label="运费" width="100px" />
        <el-table-column prop="specs" label="规格" width="150px" />
        <el-table-column label="标签">
          <template slot-scope="{row}">
            <div class="switch-group">
              <div class="switch-item">上架：{{ row.publishStatus }}</div>
              <div class="switch-item">新品：{{ row.newStatus }}</div>
              <div class="switch-item">推荐：{{ row.recommendStatus }}</div>
            </div>
          </template>
        </el-table-column>
        <el-table-column prop="sort" label="排序" />
        <el-table-column prop="createTime" label="创建时间" width="160px" />
        <el-table-column prop="createBy" label="创建人" width="120px" />
        <el-table-column prop="updateTime" label="修改时间" width="160px" />
        <el-table-column prop="updateBy" label="修改人" width="120px" />
        <el-table-column label="操作" fixed="right" />
      </el-table>
    </div>
    <!-- 分页组件开始 -->
    <div class="pageable">
      <el-pagination
        :current-page="page.pageNumber"
        :page-sizes="[10, 20, 30, 50]"
        :page-size="10"
        background
        layout="total, sizes, prev, pager, next, jumper"
        :total="dataPage.totalCount"
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
      />
    </div>
    <!-- 分页组件结束 -->
  </div>
</template>

<script>
import brandApi from '@/api/shop-brand'
import productApi from '@/api/shop-product'
export default {
  data() {
    return {
      // 分页对象
      page: {
        // 搜索对象
        params: {},
        // 当前页
        pageNumber: 1,
        // 每页条数
        pageSize: 10
      },
      // 品牌列表
      brandList: [],
      // 数据分页对象
      dataPage: {}
    }
  },
  created() {
    this.getByPage()
  },
  methods: {
    // 查询品牌
    getBrandList(name) {
      brandApi.getByName(name).then((res) => {
        this.brandList = res.data
      })
    },
    // 搜索
    search() {
      this.page.pageNumber = 1
      this.getByPage()
    },
    // 跳转到添加页
    toAdd() {
      this.$router.push('/product/add')
    },
    // 分页查询
    getByPage() {
      productApi.getByPage(this.page).then(res => {
        this.dataPage = res.data
      })
    },
    // 每页条数发生改变
    handleSizeChange(val) {
      this.page.pageSize = val
      this.getByPage()
    },
    // 当前页发生改变
    handleCurrentChange(val) {
      this.page.pageNumber = val
      this.getByPage()
    }
  }
}
</script>

<style>
</style>

```

## 1.3 商品修改

商品修改功能就比较简单了，就是添加功能复制过来稍微修改就行。我们快速过一遍。

这里需要注意的一点是，分类的回显功能。

分类选择器采用的是级联选择器，选中的是一个数组，从父级到子级的id都需要，因此我们需要将这个id都查出来。目前没什么高性能做法，只能一个一个查。因此我们需要在Vo里再提供一个categoryIds用于回显

### 1.3.1 后端-回显

#### ShopProductVo

```java
package com.jg.pochi.pojo.vo;

import com.jg.pochi.pojo.ShopProductCategory;
import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;
import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2020/11/28 20:36
 * @Version 1.0
 */
@Data
public class ShopProductVo implements Serializable {

    /**
     * 商品ID
     */
    private Long id;

    /**
     * 商品名称
     */
    private String name;

    /**
     * 商品图片
     */
    private String pic;

    /**
     * 商品副标题
     */
    private String subTitle;

    /**
     * 价格
     */
    private BigDecimal price;

    /**
     * 销量
     */
    private Integer sale;

    /**
     * 评论数
     */
    private Integer commentNum;

    /**
     * 库存
     */
    private Integer stock;

    /**
     * 库存预警值
     */
    private Integer lowStock;

    /**
     * 购买积分
     */
    private BigDecimal point;

    /**
     * 轮播图片
     */
    private List<String> albumPicList;

    /**
     * 商品描述
     */
    private String productComment;

    /**
     * 详情
     */
    private String productContent;

    /**
     * 商品分类ID
     */
    private Long categoryId;

    /**
     * 分类ID集合
     */
    private List<Long> categoryIds;

    /**
     * 商品分类
     */
    private ShopProductCategory category;

    /**
     * 套装编号
     */
    private Long packCode;

    /**
     * 品牌ID
     */
    private Long brandId;

    /**
     * 品牌名称
     * 优点：这里存储了品牌名称，那么在页面展示商品属于哪个品牌时，直接展示即可，不需要多连一张表耗费性能
     * 当一张表的某个字段可以确定基本上不可能被修改时 ，这个字段在设计数据库的时候就允许被冗余到其他表中
     */
    private String brandName;

    /**
     * 运费
     */
    private BigDecimal transFee;

    /**
     * 规格
     */
    private String specs;

    /**
     * 是否上架
     */
    private Integer publishStatus;

    /**
     * 是否新品
     */
    private Integer newStatus;

    /**
     * 是否推荐
     */
    private Integer recommendStatus;

    /**
     * 是否审核
     */
    private Integer verifyStatus;

    /**
     * 排序
     */
    private Integer sort;

    /**
     * 促销价格
     */
    private BigDecimal promotionPrice;

    /**
     * 创建时间
     */
    private String createTime;

    /**
     * 修改时间
     */
    private String updateTime;

    /**
     * 是否删除
     */
    private Integer deleted;

    /**
     * 创建人
     */
    private String createBy;

    /**
     * 修改人
     */
    private String updateBy;

}

```

#### ShopProductController-getUpdate

```java
    /**
     * 查询回显数据
     *
     * @param id
     * @return
     */
    @RequestMapping(value = "/getUpdate/{id}", method = RequestMethod.GET)
    public Result<ShopProductVo> getUpdate(@PathVariable Long id) {
        ShopProductVo vo = shopProductService.getUpdate(id);
        return new Result<>(vo);
    }
```

#### ShopProductService-getUpdate

```java
    /**
     * 查询回显
     * @param id
     * @return
     */
    ShopProductVo getUpdate(Long id);
```

#### ShopProductServiceImpl-getUpdate

```java
    @Override
    public ShopProductVo getUpdate(Long id) {
        // 根据id查询
        ShopProduct product = shopProductMapper.getById(id);
        // 转换成VO
        ShopProductVo shopProductVo = new ShopProductVo();
        BeanUtils.copyProperties(product, shopProductVo);
        // 处理轮播图
        if (StringUtils.isNotBlank(product.getAlbumPics())) {
            shopProductVo.setAlbumPicList(Arrays.asList(product.getAlbumPics().split(",")));
        }
        // 处理categoryIds
        // 拿到子节点id
        Long categoryId = product.getCategoryId();
        Deque<Long> deque = new ArrayDeque<>(4);
        while (categoryId != null && !categoryId.equals(CoreConstant.DEFAULT_PARENT_ID)) {
            // 根据子节点ID查询分类
            ShopProductCategory category = shopProductCategoryMapper.get(categoryId);
            if (category != null) {
                // 入列
                deque.offer(category.getId());
                categoryId = category.getParentId();
            }else {
                break;
            }
        }
        // 封装到vo里
        shopProductVo.setCategoryIds(new ArrayList<>(deque));
        return shopProductVo;
    }

```

### 1.3.2 后端-更新

更新就跟添加类似了，没什么难度。

#### ShopProductController-update

```java
    /**
     * 修改商品
     *
     * @param shopProductDto
     * @return
     */
    @RequestMapping(value = "/update", method = RequestMethod.PUT)
    public Result<?> update(@RequestBody ShopProductDto shopProductDto) {
        shopProductService.update(shopProductDto);
        return new Result<>("修改成功");
    }

    /**
     * 删除
     *
     * @param id
     * @return
     */
    @RequestMapping(value = "/delete/{id}", method = RequestMethod.DELETE)
    public Result<?> delete(@PathVariable Long id) {
        shopProductService.delete(id);
        return new Result<>("删除成功");
    }

    /**
     * 上架
     *
     * @param id
     * @return
     */
    @RequestMapping(value = "/publish/{id}", method = RequestMethod.PUT)
    public Result<?> publish(@PathVariable Long id) {
        shopProductService.publish(id);
        return new Result<>("已上架");
    }

    /**
     * 下架
     *
     * @param id
     * @return
     */
    @RequestMapping(value = "/unPublish/{id}", method = RequestMethod.PUT)
    public Result<?> unPublish(@PathVariable Long id) {
        shopProductService.unPublish(id);
        return new Result<>("已下架");
    }

    /**
     * 新品
     *
     * @param id
     * @return
     */
    @RequestMapping(value = "/news/{id}", method = RequestMethod.PUT)
    public Result<?> news(@PathVariable Long id) {
        shopProductService.news(id);
        return new Result<>("修改成功");
    }

    /**
     * 非新品
     *
     * @param id
     * @return
     */
    @RequestMapping(value = "/old/{id}", method = RequestMethod.PUT)
    public Result<?> old(@PathVariable Long id) {
        shopProductService.old(id);
        return new Result<>("修改成功");
    }

    /**
     * 推荐
     *
     * @param id
     * @return
     */
    @RequestMapping(value = "/recommend/{id}", method = RequestMethod.PUT)
    public Result<?> recommend(@PathVariable Long id) {
        shopProductService.recommend(id);
        return new Result<>("推荐成功");
    }

    /**
     * 不推荐
     *
     * @param id
     * @return
     */
    @RequestMapping(value = "/unRecommend/{id}", method = RequestMethod.PUT)
    public Result<?> unRecommend(@PathVariable Long id) {
        shopProductService.unRecommend(id);
        return new Result<>("修改成功");
    }

```

#### ShopProductService-update

````java
    /**
     * 修改
     * @param shopProductDto
     */
    void update(ShopProductDto shopProductDto);

    /**
     * 删除
     * @param id
     */
    void delete(Long id);

    /**
     * 上架
     * @param id
     */
    void publish(Long id);

    /**
     * 下架
     * @param id
     */
    void unPublish(Long id);

    /**
     * 新品
     * @param id
     */
    void news(Long id);

    /**
     * 取消新品
     * @param id
     */
    void old(Long id);

    /**
     * 推荐
     * @param id
     */
    void recommend(Long id);

    /**
     * 取消推荐
     * @param id
     */
    void unRecommend(Long id);
````

#### ShopProductServiceImpl-update

```java
    @Override
    public void update(ShopProductDto shopProductDto) {
        ShopProduct shopProduct = new ShopProduct();
        BeanUtils.copyProperties(shopProductDto, shopProduct);
        // 处理轮播图
        List<String> albumPicList = shopProductDto.getAlbumPicList();
        if(CollectionUtils.isEmpty(albumPicList)) {
            shopProduct.setAlbumPics(shopProduct.getPic());
        }else {
            shopProduct.setAlbumPics(StringUtils.join(albumPicList, ","));
        }
        ShopBrand brand = shopBrandMapper.get(shopProduct.getBrandId());
        shopProduct.setBrandName(brand.getName());
        // 副标题如果为空，就设置为标题
        if (StringUtils.isBlank(shopProduct.getSubTitle())) {
            shopProduct.setSubTitle(shopProduct.getName());
        }
        // 创建人、修改人
        SysUserVo loginUser = ShiroUtils.getLoginUser();
        shopProduct.setUpdateBy(loginUser.getUsername());
        shopProductMapper.update(shopProduct);
    }

    @Override
    public void delete(Long id) {
        shopProductMapper.delete(id);
    }

    @Override
    public void publish(Long id) {
        ShopProduct product = shopProductMapper.getById(id);
        product.setPublishStatus(StateEnums.ENABLED.getCode());
        shopProductMapper.updatePublish(product);
    }

    @Override
    public void unPublish(Long id) {
        ShopProduct product = shopProductMapper.getById(id);
        product.setPublishStatus(StateEnums.NOT_ENABLE.getCode());
        shopProductMapper.updatePublish(product);
    }

    @Override
    public void news(Long id) {
        ShopProduct product = shopProductMapper.getById(id);
        product.setNewStatus(StateEnums.ENABLED.getCode());
        shopProductMapper.updateNewStatus(product);
    }

    @Override
    public void old(Long id) {
        ShopProduct product = shopProductMapper.getById(id);
        product.setNewStatus(StateEnums.NOT_ENABLE.getCode());
        shopProductMapper.updateNewStatus(product);
    }

    @Override
    public void recommend(Long id) {
        ShopProduct product = shopProductMapper.getById(id);
        product.setRecommendStatus(StateEnums.ENABLED.getCode());
        shopProductMapper.updateRecommend(product);
    }

    @Override
    public void unRecommend(Long id) {
        ShopProduct product = shopProductMapper.getById(id);
        product.setRecommendStatus(StateEnums.NOT_ENABLE.getCode());
        shopProductMapper.updateRecommend(product);
    }
```

### 1.3.3 前端

前端我们基本可以复制添加的页面。

复制添加页面，重命名为 `product-update.vue`，并配置路由。需要注意的是，这里配置的路由要加上id，比如配置 `product-update/:id`，这样才能正常传参。

#### API

在API里加上如下内容

```js
  /**
   * 修改
   */
  update(sysUser) {
    return request({
      url: `/${groupName}/update`,
      method: 'put',
      data: sysUser
    })
  },
  /**
   * 查询回显数据
   * @param {*} id
   */
  getUpdate(id) {
    return request({
      url: `/${groupName}/getUpdate/${id}`,
      method: 'get'
    })
  },
  /**
   * 删除
   * @param {*} id
   */
  delete(id) {
    return request({
      url: `/${groupName}/delete/${id}`,
      method: 'delete'
    })
  },
  /**
   * 上架
   */
  publish(id) {
    return request({
      url: `/${groupName}/publish/${id}`,
      method: 'put'
    })
  },
  /**
   * 下架
   */
  unPublish(id) {
    return request({
      url: `/${groupName}/unPublish/${id}`,
      method: 'put'
    })
  }
```

#### 页面编写

```vue
<template>
  <div>

    <el-card class="product-card" shadow="never">
      <!-- 步骤条 -->
      <el-steps align-center :active="activeStep" finish-status="success">
        <el-step title="商品信息" />
        <el-step title="商品营销" />
        <el-step title="商品详情" />
        <el-step title="商品关联" />
      </el-steps>
      <!-- 步骤条结束 -->
      <!-- 商品表单 -->
      <el-form :model="shopProduct" class="form" label-width="80px" size="small">
        <!-- 商品详情 -->
        <div v-show="activeStep===0" class="product-info">
          <el-row :gutter="20">
            <el-col :span="12" :offset="0">
              <el-form-item label="商品分类">
                <el-cascader
                  v-model="shopProduct.categoryIds"
                  clearable
                  filterable
                  placeholder="选择分类"
                  style="width: 100%"
                  :options="categoryTree"
                  :props="{ expandTrigger: 'hover', value: 'id', label: 'name' }"
                  @change="changeCategory"
                />
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="商品品牌">
                <el-select v-model="shopProduct.brandId" style="width: 100%" placeholder="选择品牌" clearable filterable>
                  <el-option
                    v-for="item in brandList"
                    :key="item.id"
                    :label="item.name"
                    :value="item.id"
                  />
                </el-select>

              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="24" :offset="0">
              <el-form-item label="商品标题">
                <el-input v-model="shopProduct.name" placeholder="商品标题" clearable />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="24" :offset="0">
              <el-form-item label="副标题 ">
                <el-input v-model="shopProduct.subTitle" placeholder="副标题" clearable />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12" :offset="0">
              <el-form-item label="库存">
                <el-input-number v-model="shopProduct.stock" style="width: 100%" controls-position="right" :min="1" placeholder="库存" clearable />
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="警戒库存">
                <el-input-number v-model="shopProduct.lowStock" :max="shopProduct.stock" style="width: 100%" controls-position="right" :min="1" placeholder="警戒库存" clearable />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="12" :offset="0">
              <el-form-item label="排序">
                <el-input-number v-model="shopProduct.sort" style="width: 100%" controls-position="right" :min="1" placeholder="排序" clearable />
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="规格">
                <el-input v-model="shopProduct.specs" placeholder="规格" clearable />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="24" :offset="0">
              <el-form-item label="商品描述">
                <el-input v-model="shopProduct.productComment" type="textarea" :rows="4" placeholder="商品描述" clearable />
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item>
            <el-button type="primary" @click="activeStep++">下一步，填写商品营销</el-button>
          </el-form-item>
        </div>
        <!-- 商品详情结束 -->
        <!-- 商品营销 -->
        <div v-show="activeStep === 1" class="product-info">
          <el-row :gutter="20">
            <el-col :span="24" :offset="0">
              <el-form-item label="价格">
                <el-input-number v-model="shopProduct.price" style="width: 100%" controls-position="right" placeholder="价格" clearable />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="24" :offset="0">
              <el-form-item label="上架">
                <el-switch
                  v-model="shopProduct.publishStatus"
                  :active-value="1"
                  :inactive-value="0"
                />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="24" :offset="0">
              <el-form-item label="新品">
                <el-switch
                  v-model="shopProduct.newStatus"
                  :active-value="1"
                  :inactive-value="0"
                />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="24" :offset="0">
              <el-form-item label="推荐">
                <el-switch
                  v-model="shopProduct.recommendStatus"
                  :active-value="1"
                  :inactive-value="0"
                />
              </el-form-item>
            </el-col>
          </el-row>

          <el-row :gutter="20">
            <el-col :span="12" :offset="0">
              <el-form-item label="积分">
                <el-input-number v-model="shopProduct.point" style="width: 100%" controls-position="right" placeholder="积分" clearable />
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="运费">
                <el-input-number v-model="shopProduct.transFee" style="width: 100%" controls-position="right" placeholder="运费" clearable />
              </el-form-item>
            </el-col>
          </el-row>

          <el-form-item>
            <el-button @click="activeStep--">上一步，填写商品信息</el-button>
            <el-button type="primary" @click="activeStep++">下一步，填写商品详情</el-button>
          </el-form-item>
        </div>
        <!-- 商品营销结束 -->
        <!-- 商品详情开始 -->
        <div v-show="activeStep === 2" class="product-info">
          <el-row :gutter="20">
            <el-col :span="24" :offset="0">
              <el-form-item label="商品图片">
                <el-upload
                  class="avatar-uploader"
                  :action="uploadUrl"
                  :show-file-list="false"
                  :data="{dir: 'product'}"
                  :headers="{Authorization: token}"
                  :on-success="handleAvatarSuccess"
                >
                  <img v-if="imageUrl" :src="imageUrl" class="avatar">
                  <i v-else class="el-icon-plus avatar-uploader-icon" />
                </el-upload>
                <div class="danger-text">
                  请上传封面图片，该图片用于 列表页展示
                </div>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row :gutter="20">
            <el-col :span="24" :offset="0">
              <el-form-item label="轮播图">
                <el-upload
                  class="avatar-uploader"
                  :action="uploadUrl"
                  list-type="picture-card"
                  :data="{dir: 'product'}"
                  :file-list="albumPicList"
                  :headers="{Authorization: token}"
                  :on-success="handleBannerSuccess"
                  :on-remove="handleRemove"
                >
                  <i class="el-icon-plus" />
                </el-upload>
                <div class="danger-text">
                  请上传商品详情轮播图，如果不上传，默认采用上面的图片展示
                </div>
              </el-form-item>
            </el-col>
          </el-row>

          <el-row :gutter="20">
            <el-col :span="24" :offset="0">
              <el-form-item label="商品详情">
                <div class="danger-text">
                  商品详情建议采用上传多图的方式。文字过多可能会影响加载效果
                </div>
                <tinymce ref="content" v-model="shopProduct.productContent" :height="500" />
              </el-form-item>
            </el-col>
          </el-row>

          <el-form-item>
            <el-button @click="activeStep--">上一步，填写商品营销</el-button>
            <el-button type="primary" @click="activeStep++">下一步，填写商品关联</el-button>
          </el-form-item>
        </div>
        <!-- 商品详情结束 -->
        <!-- 商品关联 -->
        <div v-show="activeStep === 3" class="product-info">
          <el-form-item>
            <el-button @click="activeStep--">上一步，填写商品营销</el-button>
            <el-button type="primary" @click="update">提交</el-button>
          </el-form-item>
        </div>
        <!-- 商品关联结束 -->
      </el-form>
      <!-- 商品表单结束 -->

    </el-card>
  </div>
</template>

<script>
import categoryApi from '@/api/shop-product-category'
import brandApi from '@/api/shop-brand'
import productApi from '@/api/shop-product'
import Tinymce from '@/components/Tinymce'
import { mapGetters } from 'vuex'
export default {
  components: { Tinymce },
  data() {
    return {
      // 当前选中的步骤条
      activeStep: 0,
      // 表单对象
      shopProduct: {},
      // 商品分类树
      categoryTree: [],
      // 品牌数组
      brandList: [],
      // 文件上传路径
      uploadUrl: process.env.VUE_APP_UPLOAD_URL,
      // 图片回显地址
      imageUrl: null,
      // 存放临时的轮播图
      albumPicList: []
    }
  },
  computed: {
    ...mapGetters([
      'token'
    ])
  },
  created() {
    // 加载商品信息
    const id = this.$route.params.id
    this.getCatgortTree()
    this.getUpdate(id)
  },
  methods: {
    // 根据id查询回显
    getUpdate(id) {
      productApi.getUpdate(id).then(res => {
        this.shopProduct = res.data
        if (this.shopProduct.pic) {
          this.imageUrl = this.shopProduct.pic
        }
        // 回显轮播图
        const albumPicList = this.shopProduct.albumPicList
        if (albumPicList && albumPicList[0]) {
          albumPicList.forEach(e => this.albumPicList.push({ url: e }))
        }
        this.changeCategory(this.shopProduct.categoryIds)
        // 如果在对话框中，可能会报content是undefined的错误
        // 这个时候，只需要使用 nextTick就可以了
        // 在这里面就可以保证这段代码一定在组件创建完毕后执行
        // 这就意味着，content一定存在
        this.$nextTick(() => {
          // 回显富文本
          this.$refs.content.setContent(this.shopProduct.productContent)
        })
      })
    },
    // 查询分类树
    getCatgortTree() {
      categoryApi.getTree().then(res => {
        this.categoryTree = res.data
      })
    },
    // 根据分类ID查询商品品牌列表
    getBrandByCategoryId() {
      brandApi.getByCategoryId(this.shopProduct.categoryId).then(res => {
        this.brandList = res.data
      })
    },
    // 选中的分类发生变化时触发
    changeCategory(item) {
      if (!item || !item[0]) {
        this.brandList = []
        this.$set(this.shopProduct, 'brandId', null)
        this.$set(this.shopProduct, 'categoryId', null)
        return
      }
      // 取出最后一个分类ID
      const leafCategory = item[item.length - 1]
      // 赋值给商品分类ID
      this.$set(this.shopProduct, 'categoryId', leafCategory)
      // 加载品牌
      this.getBrandByCategoryId()
    },
    // 上传图片成功后的回调
    handleAvatarSuccess(res, file) {
      this.$message.success(res.msg)
      this.imageUrl = res.data
      this.shopProduct.pic = this.imageUrl
    },
    // 删除轮播图触发
    handleRemove(file, fileList) {
      // 根据uid去删除
      this.albumPicList.splice(
        this.albumPicList.findIndex(e => e.uid === file.uid),
        1
      )
    },
    // 上传轮播图触发
    handleBannerSuccess(res, file) {
      this.albumPicList.push({
        uid: file.uid,
        url: res.data
      })
    },
    // 提交表单
    update() {
      const albumPicList = []
      this.albumPicList.forEach(e => albumPicList.push(e.url))
      this.shopProduct.albumPicList = albumPicList
      productApi.update(this.shopProduct).then(res => {
        this.$message.success(res.msg)
        this.$router.push('/product/list')
      })
    }
  }
}
</script>

<style scoped>
  .product-card {
    width: 800px;
    margin: auto;
    padding: 20px;
  }
  .form {
    margin-top: 50px;
  }
  .danger-text {
    color: red;
  }
</style>

<style>
  .avatar-uploader .el-upload {
    border: 1px dashed #d9d9d9;
    border-radius: 6px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }
  .avatar-uploader .el-upload:hover {
    border-color: #409EFF;
  }
  .avatar-uploader-icon {
    font-size: 28px;
    color: #8c939d;
    width: 178px;
    height: 300px;
    line-height: 300px;
    text-align: center;
  }
  .avatar {
    width: 178px;
    height: 300px;
    display: block;
  }
</style>

```

到这里，我们商品管理第一阶段就开发完毕了

# 2. 套装管理

一个大型的电商系统，往往都会为每个商品拆分 `sku`。sku即存货单元，也叫最小库存单位、销售属性等。sku会影响到商品的库存和价格，比如我要买一部手机，在选择规格的页面有以下规格

| 容量 | 16G    | 64G    | 128G   |
| ---- | ------ | ------ | ------ |
| 颜色 | 土豪金 | 高端银 | 原谅绿 |

上面的规格中，sku一共有3*3=9个。简单来说就是9个不同的属性搭配。搭配不同，价格也不同，相应的库存数也就不同，价格和库存会根据sku而变化。

从上面的介绍中大家不难发现，sku的计算其实就是 `笛卡尔积`。当商品规格参数越来越多时，即使每个规格只有一二十个待选项，所形成的 sku 也是相当庞大的，可能有几千条、上万条。如此庞大的复杂度，在需求预测、库存计划、配送等方面都带来了巨大的挑战。

sku的泛滥会增加各方面的成本，这些成本不仅仅是技术上的，人力、物力、调度等方面都是成本，我们本次课程采用较为简单的方式去开发sku模块。

我们采用套装的思维，每个sku都视为一个商品，将多个商品打包到一个套装中。用户选择规格时，实际上就是**从该商品所在套装中选择其他的商品**，这样可以减少复杂度。事实上，这个套装功能就是上面商品管理的**商品关联**，我们开发完套装功能之后，再回去将商品关联补上。

## 2.1 后端

### 2.1.1 ShopPack

```java
package com.jg.pochi.pojo;

import lombok.Data;

import java.io.Serializable;

/**
 * @Author: 杨德石
 * @Date: 2020/12/2 22:08
 * @Version 1.0
 */
@Data
public class ShopPack implements Serializable {

    /**
     * 编号，雪花算法
     */
    private Long id;

    /**
     * 套装名称
     */
    private String name;

    /**
     * 商品数
     */
    private Integer productCount;
    /**
     * 创建时间
     */
    private String createTime;
    /**
     * 创建人
     */
    private String createBy;

}

```

### 2.1.2 ShopPackDto

我们在选择套装时，需要传多个商品编号，因此我们需要提供一个DTO用于接收商品编号

```java
package com.jg.pochi.pojo.dto;

import com.jg.pochi.pojo.ShopProduct;
import lombok.Data;

import java.io.Serializable;
import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2020/12/2 22:08
 * @Version 1.0
 */
@Data
public class ShopPackDto implements Serializable {

    /**
     * 编号，雪花算法
     */
    private Long id;

    /**
     * 套装名称
     */
    private String name;

    /**
     * 商品列表
     */
    private List<ShopProduct> productList;

}

```

### 2.1.3 ShopPackController

```java
package com.jg.pochi.controller;

import com.jg.pochi.common.Page;
import com.jg.pochi.common.Result;
import com.jg.pochi.pojo.ShopPack;
import com.jg.pochi.pojo.dto.ShopPackDto;
import com.jg.pochi.service.ShopPackService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

/**
 * @Author: 杨德石
 * @Date: 2020/12/2 22:19
 * @Version 1.0
 */
@RestController
@RequestMapping("/shopPack")
public class ShopPackController {

    @Autowired
    private ShopPackService shopPackService;

    /**
     * 添加
     * @param shopPackDto
     * @return
     */
    @RequestMapping(value = "/save", method = RequestMethod.POST)
    public Result<?> save(@RequestBody ShopPackDto shopPackDto) {
        shopPackService.save(shopPackDto);
        return new Result<>("添加成功");
    }

    /**
     * 修改
     * @param shopPackDto
     * @return
     */
    @RequestMapping(value = "/update", method = RequestMethod.PUT)
    public Result<?> update(@RequestBody ShopPackDto shopPackDto) {
        shopPackService.update(shopPackDto);
        return new Result<>("修改成功");
    }

    /**
     * 根据id查询
     * @param id
     * @return
     */
    @RequestMapping(value = "/get/{id}", method = RequestMethod.GET)
    public Result<ShopPackDto> get(@PathVariable Long id) {
        ShopPackDto packDto = shopPackService.getById(id);
        return new Result<>(packDto);
    }

    /**
     * 根据id删除
     * @param id
     * @return
     */
    @RequestMapping(value = "/delete/{id}", method = RequestMethod.DELETE)
    public Result<?> delete(@PathVariable Long id) {
        shopPackService.delete(id);
        return new Result<>("删除成功");
    }

    /**
     * 分页查询
     * @param page
     * @return
     */
    @RequestMapping(value = "/getByPage", method = RequestMethod.POST)
    public Result<Page<ShopPack>> getByPage(@RequestBody Page<ShopPack> page) {
        page = shopPackService.getByPage(page);
        return new Result<>(page);
    }

}

```

### 2.1.4 ShopPackService

```java
package com.jg.pochi.service;

import com.jg.pochi.common.Page;
import com.jg.pochi.pojo.ShopPack;
import com.jg.pochi.pojo.dto.ShopPackDto;

/**
 * @Author: 杨德石
 * @Date: 2020/12/2 22:17
 * @Version 1.0
 */
public interface ShopPackService {
    /**
     * 添加
     * @param shopPackDto
     */
    void save(ShopPackDto shopPackDto);

    /**
     * 修改
     * @param shopPackDto
     */
    void update(ShopPackDto shopPackDto);

    /**
     * 根据 id查询
     * @param id
     * @return
     */
    ShopPackDto getById(Long id);

    /**
     * 根据id删除
     * @param id
     */
    void delete(Long id);

    /**
     * 分页查询
     * @param page
     * @return
     */
    Page<ShopPack> getByPage(Page<ShopPack> page);
}

```

### 2.1.5 ShopPackServiceImpl

```java
package com.jg.pochi.service.impl;

import com.jg.pochi.common.Page;
import com.jg.pochi.mapper.ShopPackMapper;
import com.jg.pochi.mapper.ShopProductMapper;
import com.jg.pochi.mapper.ShopProductPackMapper;
import com.jg.pochi.pojo.ShopPack;
import com.jg.pochi.pojo.ShopProduct;
import com.jg.pochi.pojo.ShopProductPack;
import com.jg.pochi.pojo.dto.ShopPackDto;
import com.jg.pochi.pojo.vo.SysUserVo;
import com.jg.pochi.service.ShopPackService;
import com.jg.pochi.utils.IdWorker;
import com.jg.pochi.utils.ShiroUtils;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.CollectionUtils;

import java.util.List;
import java.util.stream.Collectors;

/**
 * @Author: 杨德石
 * @Date: 2020/12/2 22:17
 * @Version 1.0
 */
@Service
public class ShopPackServiceImpl implements ShopPackService {

    @Autowired
    private ShopPackMapper shopPackMapper;
    @Autowired
    private IdWorker idWorker;
    @Autowired
    private ShopProductMapper shopProductMapper;
    @Autowired
    private ShopProductPackMapper shopProductPackMapper;

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void save(ShopPackDto shopPackDto) {
        // 拷贝属性
        ShopPack shopPack = new ShopPack();
        BeanUtils.copyProperties(shopPackDto, shopPack);
        // ShopPack入库
        SysUserVo loginUser = ShiroUtils.getLoginUser();
        shopPack.setCreateBy(loginUser.getUsername());
        long packCode = idWorker.nextId();
        shopPack.setId(packCode);
        int productCount = 0;
        List<ShopProduct> productList = shopPackDto.getProductList();
        if (!CollectionUtils.isEmpty(productList)) {
            productCount = shopPackDto.getProductList().size();
        }
        shopPack.setProductCount(productCount);
        // 保存
        shopPackMapper.save(shopPack);
        if (!CollectionUtils.isEmpty(productList)) {
            // 保存商品套装关联表
            List<Long> productIds = productList.stream().map(ShopProduct::getId).collect(Collectors.toList());
            List<ShopProduct> products = shopProductMapper.getByIds(productIds);
            // 构造ShopProductPack
            List<ShopProductPack> packList = products.stream().map(e -> {
                ShopProductPack shopProductPack = new ShopProductPack();
                shopProductPack.setProductId(e.getId());
                shopProductPack.setPackCode(packCode);
                shopProductPack.setPrice(e.getPrice());
                shopProductPack.setStock(e.getStock());
                shopProductPack.setLowStock(e.getLowStock());
                shopProductPack.setSpecName(e.getSpecs());
                shopProductPack.setProductName(e.getName());
                return shopProductPack;
            }).collect(Collectors.toList());
            shopProductPackMapper.saveBatch(packList);
        }
    }

    @Override
    public void update(ShopPackDto shopPackDto) {
        long packCode = shopPackDto.getId();
        // 拷贝属性
        ShopPack shopPack = new ShopPack();
        BeanUtils.copyProperties(shopPackDto, shopPack);
        int productCount = 0;
        List<ShopProduct> productList = shopPackDto.getProductList();
        if (!CollectionUtils.isEmpty(productList)) {
            productCount = shopPackDto.getProductList().size();
        }
        shopPack.setProductCount(productCount);
        // 修改
        shopPackMapper.update(shopPack);
        // 删除关联表数据
        shopProductPackMapper.deleteByPackCode(packCode);
        if (!CollectionUtils.isEmpty(productList)) {
            // 保存商品套装关联表
            List<Long> productIds = productList.stream().map(ShopProduct::getId).collect(Collectors.toList());
            List<ShopProduct> products = shopProductMapper.getByIds(productIds);
            // 构造ShopProductPack
            List<ShopProductPack> packList = products.stream().map(e -> {
                ShopProductPack shopProductPack = new ShopProductPack();
                shopProductPack.setProductId(e.getId());
                shopProductPack.setPackCode(packCode);
                shopProductPack.setPrice(e.getPrice());
                shopProductPack.setStock(e.getStock());
                shopProductPack.setLowStock(e.getLowStock());
                shopProductPack.setSpecName(e.getSpecs());
                shopProductPack.setProductName(e.getName());
                return shopProductPack;
            }).collect(Collectors.toList());
            shopProductPackMapper.saveBatch(packList);
        }
    }

    @Override
    public ShopPackDto getById(Long id) {
        ShopPack pack = shopPackMapper.get(id);
        ShopPackDto shopPackDto = new ShopPackDto();
        BeanUtils.copyProperties(pack, shopPackDto);
        // 根据id查询套装
        List<ShopProductPack> packList = shopProductPackMapper.getByPackCode(id);
        if(!CollectionUtils.isEmpty(packList)) {
            List<Long> productIds = packList.stream().map(ShopProductPack::getProductId).collect(Collectors.toList());
            List<ShopProduct> productList = shopProductMapper.getByIds(productIds);
            shopPackDto.setProductList(productList);
        }
        return shopPackDto;
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void delete(Long id) {
        shopPackMapper.delete(id);
        shopProductPackMapper.deleteByPackCode(id);
    }

    @Override
    public Page<ShopPack> getByPage(Page<ShopPack> page) {
        List<ShopPack> list = shopPackMapper.getByPage(page);
        Integer totalCount = shopPackMapper.countByPage(page);
        page.setList(list);
        page.setTotalCount(totalCount);
        return page;
    }
}

```

### 2.1.6 ShopPackMapper

```java
package com.jg.pochi.mapper;

import com.jg.pochi.common.Page;
import com.jg.pochi.pojo.ShopPack;
import org.springframework.stereotype.Component;

import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2020/11/8 13:46
 * @Version 1.0
 */
@Component
public interface ShopPackMapper {

    /**
     * 保存
     * @param shopPack
     */
    void save(ShopPack shopPack);

    /**
     * 修改
     * @param shopPack
     */
    void update(ShopPack shopPack);

    /**
     * 根据id查询
     * @param id
     * @return
     */
    ShopPack get(Long id);

    /**
     * 根据id删除
     * @param id
     */
    void delete(Long id);

    /**
     * 分页查询
     * @param page
     * @return
     */
    List<ShopPack> getByPage(Page<ShopPack> page);

    /**
     * 查询总数
     * @param page
     * @return
     */
    Integer countByPage(Page<ShopPack> page);
}

```

### 2.1.7 ShopPackMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jg.pochi.mapper.ShopPackMapper">
    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.jg.pochi.pojo.ShopPack">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="product_count" property="productCount"/>
        <result column="create_time" property="createTime"/>
        <result column="create_by" property="createBy"/>
    </resultMap>
    <insert id="save">
        insert into shop_pack(id, name, product_count, create_time, create_by)
        VALUES (#{id}, #{name}, #{productCount}, #{createTime}, #{createBy})
    </insert>
    <update id="update">
        update shop_pack
        <set>
            <if test="name!=null and name!=''">
                name = #{name},
            </if>
            <if test="productCount!=null">
                product_count = #{productCount}
            </if>
        </set>
        where id = #{id}
    </update>
    <delete id="delete">
        delete
        from shop_pack
        where id = #{id}
    </delete>
    <select id="get" resultMap="BaseResultMap">
        select id, name
        from shop_pack
        where id = #{id}
    </select>
    <select id="getByPage" resultMap="BaseResultMap">
        select id, name, product_count, create_time, create_by
        from shop_pack
        limit #{index}, #{pageSize}
    </select>
    <select id="countByPage" resultType="java.lang.Integer">
        select count(*)
        from shop_pack
    </select>


</mapper>

```

### 2.1.8 ShopProductPack

```java
package com.jg.pochi.pojo;

import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;

/**
 * @Author: 杨德石
 * @Date: 2020/12/2 22:11
 * @Version 1.0
 */
@Data
public class ShopProductPack implements Serializable {

    /**
     * 编号，自增
     */
    private Long id;

    /**
     * 商品编号
     */
    private Long productId;

    /**
     * 套装编号
     */
    private Long packCode;

    /**
     * 价格
     */
    private BigDecimal price;

    /**
     * 库存
     */
    private Integer stock;

    /**
     * 警戒库存
     */
    private Integer lowStock;

    /**
     * 规格
     */
    private String specName;

    /**
     * 销量
     */
    private Integer sale;

    /**
     * 商品名称
     */
    private String productName;

}

```

### 2.1.9 ShopProductPackMapper

```java
package com.jg.pochi.mapper;

import com.jg.pochi.pojo.ShopProductPack;
import org.springframework.stereotype.Component;

import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2020/11/8 13:46
 * @Version 1.0
 */
@Component
public interface ShopProductPackMapper {

    /**
     * 批量保存
     * @param packList
     */
    void saveBatch(List<ShopProductPack> packList);

    /**
     * 根据套装编号删除
     * @param packCode
     */
    void deleteByPackCode(long packCode);

    /**
     * 根据套装编号查询
     * @param id
     * @return
     */
    List<ShopProductPack> getByPackCode(Long id);
}

```

### 2.1.10 ShopProductPackMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jg.pochi.mapper.ShopProductPackMapper">
    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.jg.pochi.pojo.ShopProductPack">
        <id column="id" property="id"/>
        <result column="product_id" property="productId"/>
        <result column="pack_code" property="packCode"/>
        <result column="price" property="price"/>
        <result column="stock" property="stock"/>
        <result column="low_stock" property="lowStock"/>
        <result column="spec_name" property="specName"/>
        <result column="sale" property="sale"/>
        <result column="product_name" property="productName"/>
    </resultMap>
    <insert id="saveBatch">
        insert into shop_product_pack(id, product_id, pack_code, price, stock, low_stock, spec_name, sale, product_name)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
            #{item.id}, #{item.productId}, #{item.packCode}, #{item.price}, #{item.stock}, #{item.lowStock},
            #{item.specName}, #{item.sale}, #{item.productName}
            )
        </foreach>
    </insert>
    <delete id="deleteByPackCode">
        delete
        from shop_product_pack
        where pack_code = #{packCode}
    </delete>
    <select id="getByPackCode" resultMap="BaseResultMap">
        select id,
               product_id,
               pack_code
        from shop_product_pack
        where pack_code = #{packCode}
    </select>


</mapper>

```



## 2.2 前端

### 2.2.1 API

在 `api` 下创建 `shopPack.js`，内容如下。

```js
import request from '@/utils/request'
const groupName = 'shopPack'
export default {
  /**
   * 添加
   */
  save(sysUser) {
    return request({
      url: `/${groupName}/save`,
      method: 'post',
      data: sysUser
    })
  },
  /**
   * 分页查询
   * @param {分页查询} page
   */
  getByPage(page) { // 分页查询
    return request({
      url: `/${groupName}/getByPage`,
      method: 'post',
      data: page
    })
  },
  /**
   * 修改
   */
  update(sysUser) {
    return request({
      url: `/${groupName}/update`,
      method: 'put',
      data: sysUser
    })
  },
  /**
   * 删除
   * @param {*} id
   */
  delete(id) {
    return request({
      url: `/${groupName}/delete/${id}`,
      method: 'delete'
    })
  },
  /**
   * 根据id查询
   * @param {*} id
   */
  get(id) {
    return request({
      url: `/${groupName}/get/${id}`,
      method: 'get'
    })
  }
}

```

### 2.2.2 页面编写

在 `views/product` 下创建 `pack` 文件夹，在这个文件夹下编写前端代码。

#### pack-list

```vue
<template>
  <div>
    <!-- 操作按钮组 -->
    <div class="button-group">
      <el-button type="primary" size="small" icon="el-icon-plus" @click="toAdd">添加</el-button>
    </div>
    <!-- 操作按钮组结束 -->
    <!-- 数据表格 -->
    <div class="data-table">
      <el-table
        header-row-class-name="pochi-table-header"
        :data="dataPage.list"
        stripe
        style="width: 100%"
      >
        <el-table-column prop="id" label="套装编号" width="180px" />
        <el-table-column prop="name" label="套装名称" />
        <el-table-column prop="productCount" label="商品数" width="80px" />
        <el-table-column prop="createTime" label="创建时间" width="160px" />
        <el-table-column prop="createBy" label="创建人" width="120px" />
        <el-table-column label="操作" width="180px">
          <template slot-scope="{row}">
            <el-button type="text" icon="el-icon-document" @click="toInfo(row.id)">商品清单</el-button>
            <el-dropdown class="handle-button">
              <span class="el-dropdown-link">
                操作<i class="el-icon-arrow-down el-icon--right" />
              </span>
              <el-dropdown-menu slot="dropdown">
                <el-dropdown-item>
                  <el-button type="text" icon="el-icon-edit" @click="toUpdate(row.id)">修改</el-button>
                </el-dropdown-item>
                <el-dropdown-item v-permission="['sys:user:delete']" @click.native="toDelete(row.id)">
                  <el-button type="text" icon="el-icon-delete">删除</el-button>
                </el-dropdown-item>
              </el-dropdown-menu>
            </el-dropdown>
          </template>
        </el-table-column>
      </el-table>
    </div>
    <!-- 数据表格结束 -->
    <!-- 分页组件开始 -->
    <div class="pageable">
      <el-pagination
        :current-page="page.pageNumber"
        :page-sizes="[10, 20, 30, 50]"
        :page-size="10"
        background
        layout="total, sizes, prev, pager, next, jumper"
        :total="dataPage.totalCount"
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
      />
    </div>
    <!-- 分页组件结束 -->
    <!-- 添加弹窗 -->
    <el-dialog
      title="添加套装"
      :visible.sync="addDialog"
      width="40%"
    >
      <pack-add @close="closeDialog" @after="getByPage" />
    </el-dialog>
    <!-- 添加弹窗结束 -->
    <!-- 修改弹窗 -->
    <el-dialog
      title="修改套装"
      :visible.sync="updateDialog"
      width="40%"
    >
      <pack-update :active-id="activeId" @close="closeDialog" @after="getByPage" />
    </el-dialog>
    <!-- 修改弹窗结束 -->
    <!-- 商品清单 -->
    <el-dialog
      title="商品清单"
      :visible.sync="infoDialog"
      width="70%"
    >
      <product-detail :active-id="activeId" />
    </el-dialog>
    <!-- 商品清单结束 -->
  </div>
</template>

<script>
import packApi from '@/api/shop-pack.js'
import PackAdd from './pack-add.vue'
import PackUpdate from './pack-update.vue'
import ProductDetail from './product-detail.vue'
export default {
  components: {
    PackAdd,
    PackUpdate,
    ProductDetail
  },
  data() {
    return {
      // 分页对象
      page: {
        // 当前页
        pageNumber: 1,
        // 每页条数
        pageSize: 10
      },
      // 数据对象
      dataPage: {},
      // 添加弹窗
      addDialog: false,
      // 修改弹窗
      updateDialog: false,
      // 商品清单弹窗
      infoDialog: false,
      // 当前点击的套装ID
      activeId: null
    }
  },
  created() {
    this.getByPage()
  },
  methods: {
    // 添加
    toAdd() {
      this.addDialog = true
    },
    // 分页查询
    getByPage() {
      packApi.getByPage(this.page).then(res => {
        this.dataPage = res.data
      })
    },
    // 每页条数发生改变
    handleSizeChange(val) {
      this.page.pageSize = val
      this.getByPage()
    },
    // 当前页发生改变
    handleCurrentChange(val) {
      this.page.pageNumber = val
      this.getByPage()
    },
    // 商品清单
    toInfo(id) {
      this.activeId = id
      this.infoDialog = true
    },
    // 删除
    toDelete(id) {
      this.$confirm('是否删除该套装?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'error'
      }).then(() => {
        packApi.delete(id).then(res => {
          this.$message.success(res.msg)
          this.getByPage()
        })
      })
    },
    // 修改
    toUpdate(id) {
      this.activeId = id
      this.updateDialog = true
    },
    // 关闭所有弹窗
    closeDialog() {
      this.addDialog = false
      this.updateDialog = false
      this.infoDialog = false
    }
  }
}
</script>

<style>
</style>

```

#### pack-product-select

套装添加功能。只有一个名称是需要填写的。除此以外，我们还需要另外一个弹窗，用来查找没有进入到套装的商品。

```vue
<template>
  <div>
    <!-- 搜索框 -->
    <div class="search-form">
      <el-form :model="page.params" :inline="true" size="small">
        <el-form-item>
          <el-input v-model="page.params.name" clearable placeholder="商品名称" />
        </el-form-item>
        <el-form-item>
          <el-select v-model="page.params.publishStatus" placeholder="上架" clearable>
            <el-option label="上架" :value="1" />
            <el-option label="下架" :value="0" />
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-select v-model="page.params.newStatus" placeholder="新品" clearable>
            <el-option label="是" :value="1" />
            <el-option label="否" :value="0" />
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-select v-model="page.params.recommendStatus" placeholder="推荐" clearable>
            <el-option label="是" :value="1" />
            <el-option label="否" :value="0" />
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-select
            v-model="page.params.brandId"
            filterable
            remote
            :remote-method="getBrandList"
            placeholder="品牌"
            clearable
          >
            <el-option
              v-for="item in brandList"
              :key="item.id"
              :label="item.name"
              :value="item.id"
            />
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" icon="el-icon-search" @click="search">查询</el-button>
          <el-button type="success" icon="el-icon-search" @click="handleSelect">选中</el-button>
        </el-form-item>
      </el-form>
    </div>
    <!-- 搜索框结束 -->
    <div class="data-table">
      <el-table
        ref="selectTable"
        header-row-class-name="pochi-table-header"
        :data="dataPage.list"
        stripe
        style="width: 100%"
        @selection-change="handleSelectionChange"
      >
        <el-table-column
          type="selection"
          width="55"
        />
        <el-table-column prop="name" label="标题" />
        <el-table-column prop="price" label="价格" />
        <el-table-column prop="stock" label="库存" />
        <el-table-column prop="sale" label="销量" />
        <el-table-column prop="category.name" label="分类" />
        <el-table-column prop="brandName" label="品牌" />
        <el-table-column label="标签">
          <template slot-scope="{row}">
            <div class="switch-group">
              <div class="switch-item">
                <span>上架：</span>
                <span>
                  <el-tag v-if="row.publishStatus===1" type="success">是</el-tag>
                  <el-tag v-else type="info">否</el-tag>
                </span>
              </div>
              <div class="switch-item">
                <span>新品：</span>
                <span>
                  <el-tag v-if="row.newStatus===1" type="success">是</el-tag>
                  <el-tag v-else type="info">否</el-tag>
                </span>
              </div>
              <div class="switch-item">
                <span>推荐：</span>
                <span>
                  <el-tag v-if="row.recommendStatus===1" type="success">是</el-tag>
                  <el-tag v-else type="info">否</el-tag>
                </span>
              </div>
            </div>
          </template>
        </el-table-column>
      </el-table>
    </div>
    <!-- 分页组件开始 -->
    <div class="pageable">
      <el-pagination
        :current-page="page.pageNumber"
        :page-sizes="[10, 20, 30, 50]"
        :page-size="10"
        background
        layout="total, sizes, prev, pager, next, jumper"
        :total="dataPage.totalCount"
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
      />
    </div>
    <!-- 分页组件结束 -->
  </div>
</template>

<script>
import brandApi from '@/api/shop-brand'
import productApi from '@/api/shop-product'
export default {
  props: {
    // 默认选中
    defaultSelect: {
      type: Array,
      default: null
    }
  },
  data() {
    return {
      // 分页对象
      page: {
        // 搜索对象
        params: {},
        // 当前页
        pageNumber: 1,
        // 每页条数
        pageSize: 10
      },
      // 品牌列表
      brandList: [],
      // 数据分页对象
      dataPage: {
        // 表格数据
        list: []
      },
      // 当前选中行的数据
      selectVal: []
    }
  },
  watch: {
    defaultSelect: {
      immediate: true,
      handler: function(newVal, oldVal) {
        this.setSelect()
      }
    }
  },
  created() {
    this.getByPage()
  },
  methods: {
    // 选中
    handleSelect() {
      this.$emit('selectSubmit', this.selectVal)
    },
    // 回显选中状态
    setSelect() {
      // 取消选择状态
      this.$nextTick(() => {
        this.$refs.selectTable.clearSelection()
        if (this.defaultSelect && this.defaultSelect[0]) {
          this.defaultSelect.forEach(e => {
          // 找到e在dataPage.list中的位置
            const index = this.dataPage.list.findIndex(item => item.id === e.id)
            // 设置回显，第二个参数如果不设置，可能会导致数据被取消选中
            this.$refs.selectTable.toggleRowSelection(this.dataPage.list[index], true)
          })
        }
      })
    },
    // 选中触发
    handleSelectionChange(val) {
      this.selectVal = val
    },
    // 查询品牌
    getBrandList(name) {
      brandApi.getByName(name).then((res) => {
        this.brandList = res.data
      })
    },
    // 搜索
    search() {
      this.page.pageNumber = 1
      this.getByPage()
    },
    // 分页查询
    getByPage() {
      productApi.getByPage(this.page).then(res => {
        this.dataPage = res.data
        this.setSelect()
      })
    },
    // 每页条数发生改变
    handleSizeChange(val) {
      this.page.pageSize = val
      this.getByPage()
    },
    // 当前页发生改变
    handleCurrentChange(val) {
      this.page.pageNumber = val
      this.getByPage()
    }
  }
}
</script>

<style>
</style>

```

#### pack-add

```vue
<template>
  <div>
    <el-form :model="shopPack" label-width="80px" size="small">
      <el-form-item label="套装名称">
        <el-input v-model="shopPack.name" clearable placeholder="套装名称" />
      </el-form-item>
      <el-form-item label="套装商品">
        <el-button type="primary" @click="selectProduct">选择商品</el-button>
      </el-form-item>
      <el-form-item>
        <el-table
          header-row-class-name="pochi-table-header"
          :data="shopPack.productList"
          stripe
          border
          style="width: 100%"
        >
          <el-table-column prop="name" label="名称" />
          <el-table-column prop="price" label="价格" />
          <el-table-column prop="stock" label="库存" />
          <el-table-column prop="brandName" label="品牌" />
          <el-table-column label="操作">
            <template slot-scope="{row}">
              <el-button type="text" icon="el-icon-delete" @click="deleteProduct(row.id)">删除</el-button>
            </template>
          </el-table-column>
        </el-table>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="add">添加</el-button>
      </el-form-item>
    </el-form>
    <!-- 商品选择弹窗 -->
    <el-dialog
      append-to-body
      title="选择商品"
      :visible.sync="selectDialog"
      width="70%"
    >
      <select-product :default-select="shopPack.productList" @selectSubmit="selectSubmit" />
    </el-dialog>

    <!-- 商品选择弹窗结束 -->
  </div>
</template>

<script>
import selectProduct from './select-product'
import packApi from '@/api/shop-pack'
export default {
  components: {
    selectProduct
  },
  data() {
    return {
      // 表单对象
      shopPack: {
        // 用户选中的商品列表
        productList: []
      },
      // 商品选择弹窗
      selectDialog: false
    }
  },
  methods: {
    // 添加
    add() {
      packApi.save(this.shopPack).then(res => {
        this.$message.success(res.msg)
        this.$emit('close')
        this.$emit('after')
      })
    },
    // 选择商品
    selectProduct() {
      this.selectDialog = true
    },
    // 提交选中商品触发
    selectSubmit(val) {
      this.selectDialog = false
      this.shopPack.productList = val
    },
    // 删除选中的商品
    deleteProduct(id) {
      this.shopPack.productList.splice(
        this.shopPack.productList.findIndex(e => e.id === id),
        1
      )
    }
  }
}
</script>

<style>
</style>

```

#### pack-update

```vue
<template>
  <div>
    <el-form :model="shopPack" label-width="80px" size="small">
      <el-form-item label="套装名称">
        <el-input v-model="shopPack.name" clearable placeholder="套装名称" />
      </el-form-item>
      <el-form-item label="套装商品">
        <el-button type="primary" @click="selectProduct">选择商品</el-button>
      </el-form-item>
      <el-form-item>
        <el-table
          header-row-class-name="pochi-table-header"
          :data="shopPack.productList"
          stripe
          border
          style="width: 100%"
        >
          <el-table-column prop="name" label="名称" />
          <el-table-column prop="price" label="价格" />
          <el-table-column prop="stock" label="库存" />
          <el-table-column prop="brandName" label="品牌" />
          <el-table-column label="操作">
            <template slot-scope="{row}">
              <el-button type="text" icon="el-icon-delete" @click="deleteProduct(row.id)">删除</el-button>
            </template>
          </el-table-column>
        </el-table>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="update">修改</el-button>
      </el-form-item>
    </el-form>
    <!-- 商品选择弹窗 -->
    <el-dialog
      append-to-body
      title="选择商品"
      :visible.sync="selectDialog"
      width="70%"
    >
      <select-product :default-select="shopPack.productList" @selectSubmit="selectSubmit" />
    </el-dialog>

    <!-- 商品选择弹窗结束 -->
  </div>
</template>

<script>
import selectProduct from './select-product'
import packApi from '@/api/shop-pack'
export default {
  components: {
    selectProduct
  },
  props: {
    // 当前套装编号
    activeId: {
      type: String,
      default: null
    }
  },
  data() {
    return {
      // 表单对象
      shopPack: {
        // 用户选中的商品列表
        productList: []
      },
      // 商品选择弹窗
      selectDialog: false
    }
  },
  watch: {
    activeId: {
      immediate: true,
      handler: function(newVal, oldVal) {
        this.getById(newVal)
      }
    }
  },
  methods: {
    // 添加
    update() {
      packApi.update(this.shopPack).then(res => {
        this.$message.success(res.msg)
        this.$emit('close')
        this.$emit('after')
      })
    },
    getById(id) {
      packApi.get(id).then(res => {
        this.shopPack = res.data
      })
    },
    // 选择商品
    selectProduct() {
      this.selectDialog = true
    },
    // 提交选中商品触发
    selectSubmit(val) {
      this.selectDialog = false
      this.shopPack.productList = val
    },
    // 删除选中的商品
    deleteProduct(id) {
      this.shopPack.productList.splice(
        this.shopPack.productList.findIndex(e => e.id === id),
        1
      )
    }
  }
}
</script>

<style>
</style>

```

#### product-detail

```vue
<template>
  <div>
    <!-- 操作按钮组结束 -->
    <div class="data-table">
      <el-table
        header-row-class-name="pochi-table-header"
        :data="list"
        stripe
        style="width: 100%"
      >
        <el-table-column prop="name" label="标题" />
        <el-table-column prop="price" label="价格" />
        <el-table-column prop="sale" label="销量" />
        <el-table-column prop="stock" label="库存" />
        <el-table-column prop="lowStock" label="预警库存" />
        <el-table-column prop="brandName" label="品牌" />
        <el-table-column prop="specs" label="规格" />
      </el-table>
    </div>
  </div>
</template>

<script>
import productApi from '@/api/shop-product'
export default {
  props: {
    activeId: {
      type: String,
      default: null
    }
  },
  data() {
    return {
      // 商品清单
      list: []
    }
  },
  watch: {
    activeId: {
      immediate: true,
      handler: function(newVal) {
        this.getByPackCode(newVal)
      }
    }
  },
  methods: {
    // 根据套装编号查询
    getByPackCode(id) {
      productApi.getProductDetailList(id).then(res => {
        this.list = res.data
      })
    }
  }
}
</script>

<style>

</style>

```



# 3. 商品关联

前面我们做完了套装功能，下面该回来把商品的套装功能加上了。

商品关联的功能主要有两块。一是选择对应的套装，直接将商品加入套装。二是批量选择商品，给这些商品打包。

## 3.1 后端

在 `ProductDto` 中，我们需要接收套装参数和商品列表参数

### 3.1.1 ShopProductDto

```java
package com.jg.pochi.pojo.dto;

import com.jg.pochi.pojo.ShopPack;
import com.jg.pochi.pojo.ShopProduct;
import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;
import java.util.List;

/**
 * <p>
 * 商品表实体类
 * </p>
 *
 * @author 杨德石
 * @date 2020-09-22 17:43:33
 * @Version 1.0
 */
@Data
public class ShopProductDto implements Serializable {

    private Long id;

    /**
     * 商品名称
     */
    private String name;

    /**
     * 商品图片
     */
    private String pic;

    /**
     * 副标题
     */
    private String subTitle;

    /**
     * 价格
     */
    private BigDecimal price;

    /**
     * 库存
     */
    private Integer stock;

    /**
     * 库存预警值
     */
    private Integer lowStock;

    /**
     * 轮播图图片，至少1张
     */
    private List<String> albumPicList;

    /**
     * 详情
     */
    private String productContent;

    private String specs;
    private BigDecimal point;

    /**
     * 商品分类id
     */
    private Long categoryId;

    /**
     * 套装编号
     */
    private Long packCode;

    /**
     * 品牌id
     */
    private Long brandId;

    /**
     * 品牌名称
     */
    private String brandName;

    /**
     * 运费
     */
    private BigDecimal transFee;

    /**
     * 是否上架，1是0否
     */
    private Integer publishStatus;

    /**
     * 是否新品，1是0否
     */
    private Integer newStatus;

    /**
     * 是否推荐，1是0否
     */
    private Integer recommendStatus;

    /**
     * 是否审核，1通过，0未审核，-1不通过
     */
    private Integer verifyStatus;

    /**
     * 排序
     */
    private Integer sort;

    /**
     * 促销价格
     */
    private BigDecimal promotionPrice;

    private String productComment;

    private List<ShopProduct> productList;

    private ShopPack shopPack;

}

```

### 3.1.2 ShopProductServiceImpl

这里应该是我们目前遇到的最复杂的业务逻辑了。

* 用户选择了关联套装和关联商品
  * 该商品没有加入其它套装：将该商品和选择的商品都加入到套装中。
  * 该商品加入了其它套装：将该商品和选择的商品都加入到套装中，并减少原套装的商品数。
* 用户没同时选择关联套装和关联商品
  * 用户选择了关联套装
    * 该商品没套装：将该商品加入到选择的套装中
    * 该商品有套装：将该商品加入到选择的套装中，并减少原套装的商品数。
  * 用户选择了关联商品
    * 该商品没套装：将该商品和选择的商品打包成一个套装
    * 该商品有套装：将该商品和选择的商品打包成一个套装，并减少原套装的商品数。

分析完了逻辑，我们开始编写代码

```java
package com.jg.pochi.service.impl;

import com.jg.pochi.common.Page;
import com.jg.pochi.constant.CoreConstant;
import com.jg.pochi.enums.StateEnums;
import com.jg.pochi.mapper.ShopBrandMapper;
import com.jg.pochi.mapper.ShopPackMapper;
import com.jg.pochi.mapper.ShopProductCategoryMapper;
import com.jg.pochi.mapper.ShopProductMapper;
import com.jg.pochi.mapper.ShopProductPackMapper;
import com.jg.pochi.pojo.ShopBrand;
import com.jg.pochi.pojo.ShopPack;
import com.jg.pochi.pojo.ShopProduct;
import com.jg.pochi.pojo.ShopProductCategory;
import com.jg.pochi.pojo.ShopProductPack;
import com.jg.pochi.pojo.dto.ShopProductDto;
import com.jg.pochi.pojo.vo.ShopProductVo;
import com.jg.pochi.pojo.vo.SysUserVo;
import com.jg.pochi.service.ShopProductService;
import com.jg.pochi.utils.IdWorker;
import com.jg.pochi.utils.ShiroUtils;
import com.jg.pochi.utils.StringUtils;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.CollectionUtils;

import java.util.ArrayDeque;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Deque;
import java.util.List;
import java.util.stream.Collectors;

/**
 * @Author: 杨德石
 * @Date: 2020/11/24 23:38
 * @Version 1.0
 */
@Service
public class ShopProductServiceImpl implements ShopProductService {

    @Autowired
    private IdWorker idWorker;
    @Autowired
    private ShopProductMapper shopProductMapper;
    @Autowired
    private ShopBrandMapper shopBrandMapper;
    @Autowired
    private ShopProductCategoryMapper shopProductCategoryMapper;
    @Autowired
    private ShopProductPackMapper shopProductPackMapper;
    @Autowired
    private ShopPackMapper shopPackMapper;

    @Override
    public void save(ShopProductDto shopProductDto) {
        // 转换成ShopProduct
        ShopProduct shopProduct = new ShopProduct();
        BeanUtils.copyProperties(shopProductDto, shopProduct);
        shopProduct.setId(idWorker.nextId());
        // 处理轮播图
        if (!CollectionUtils.isEmpty(shopProductDto.getAlbumPicList())) {
            // 转成一个字符串，使用 , 拼接
            shopProduct.setAlbumPics(StringUtils.join(shopProductDto.getAlbumPicList(), ","));
        } else {
            // 用商品图片代替
            shopProduct.setAlbumPics(shopProduct.getPic());
        }
        /*
            品牌名称
            一般来讲，任何场景下我们都不能信任前端所传递的参数
            我们只能接收前端传递的品牌ID，名称我们自己去表里查
            如果我们系统的安全性做的比较足的话
            那么前端参数被伪造的概率是相当低的
            这个时候我们就可以相信前端传的参数
            我们本次课程系统安全性较差，因此不相信前端的参数
         */
        ShopBrand brand = shopBrandMapper.get(shopProduct.getBrandId());
        shopProduct.setBrandName(brand.getName());
        // 副标题如果为空，就设置为标题
        if (StringUtils.isBlank(shopProduct.getSubTitle())) {
            shopProduct.setSubTitle(shopProduct.getName());
        }
        // 创建人、修改人
        SysUserVo loginUser = ShiroUtils.getLoginUser();
        shopProduct.setCreateBy(loginUser.getUsername());
        shopProduct.setUpdateBy(loginUser.getUsername());
        shopProductMapper.save(shopProduct);
        // 处理套装
        handleProductPack(shopProductDto, shopProduct, loginUser);
    }

    /**
     * 处理添加商品时的套装逻辑
     *
     * @param shopProductDto 待添加商品的参数
     * @param shopProduct    当前商品
     * @param loginUser      当前登录用户
     */
    private void handleProductPack(ShopProductDto shopProductDto, ShopProduct shopProduct, SysUserVo loginUser) {
        ShopPack shopPack = shopProductDto.getShopPack();
        List<ShopProduct> productList = shopProductDto.getProductList();
        // * 用户选择了关联套装和关联商品
        if (shopPack != null && !CollectionUtils.isEmpty(productList)) {
            Long packCode = shopPack.getId();
            //  * 该商品没有加入其它套装：将该商品和选择的商品都加入到套装中。
            // 保存商品套装关联表
            List<Long> productIds = productList.stream().map(ShopProduct::getId).collect(Collectors.toList());
            List<ShopProduct> products = shopProductMapper.getByIds(productIds);
            // 将该商品加入到products
            products.add(shopProduct);
            handleProductPack(packCode, products);
        } else if (shopPack != null) {
            Long packCode = shopPack.getId();
            //* 用户没同时选择关联套装和关联商品
            //  * 用户选择了关联套装
            //    * 该商品没套装：将该商品加入到选择的套装中
            // 保存商品套装关联表
            List<ShopProduct> products = new ArrayList<>();
            // 将该商品加入到products
            products.add(shopProduct);
            // 构造ShopProductPack
            handleProductPack(packCode, products);
        } else if (!CollectionUtils.isEmpty(productList)) {
            //  * 用户选择了关联商品
            //    * 该商品没套装：将该商品和选择的商品打包成一个套装
            // 拷贝属性
            shopPack = new ShopPack();
            // ShopPack入库
            shopPack.setCreateBy(loginUser.getUsername());
            shopPack.setName(shopProduct.getName());
            shopPack.setProductCount(productList.size() + 1);
            long packCode = idWorker.nextId();
            shopPack.setId(packCode);
            // 保存
            shopPackMapper.save(shopPack);
            // 保存商品套装关联表
            List<Long> productIds = productList.stream().map(ShopProduct::getId).collect(Collectors.toList());
            List<ShopProduct> products = shopProductMapper.getByIds(productIds);
            // 将该商品加入到products
            products.add(shopProduct);
            // 构造ShopProductPack
            handleProductPack(packCode, products);
        }
    }

    /**
     * 处理商品的套装逻辑
     *
     * @param packCode
     * @param products
     */
    private void handleProductPack(Long packCode, List<ShopProduct> products) {
        // 构造ShopProductPack
        List<ShopProductPack> packList = products.stream().map(e -> {
            ShopProductPack shopProductPack = new ShopProductPack();
            shopProductPack.setProductId(e.getId());
            shopProductPack.setPackCode(packCode);
            shopProductPack.setPrice(e.getPrice());
            shopProductPack.setStock(e.getStock());
            shopProductPack.setLowStock(e.getLowStock());
            shopProductPack.setSpecName(e.getSpecs());
            if (StringUtils.isBlank(shopProductPack.getSpecName())) {
                shopProductPack.setSpecName(e.getName());
            }
            shopProductPack.setProductName(e.getName());
            return shopProductPack;
        }).collect(Collectors.toList());
        shopProductPackMapper.saveBatch(packList);
    }

    @Override
    public Page<ShopProductVo> getByPage(Page<ShopProductVo> page) {
        // 查询list和总条数
        List<ShopProduct> list = shopProductMapper.getByPage(page);
        Integer totalCount = shopProductMapper.countByPage(page);
        // ShopProduct的list转成vo的list
        List<ShopProductVo> productVoList = list.stream().map(e -> {
            ShopProductVo vo = new ShopProductVo();
            BeanUtils.copyProperties(e, vo);
            // 处理一下轮播图
            String albumPics = e.getAlbumPics();
            if (StringUtils.isNotBlank(albumPics)) {
                // 转成集合
                vo.setAlbumPicList(Arrays.asList(albumPics.split(",")));
            }
            return vo;
        }).collect(Collectors.toList());
        // 处理分类名称
        List<Long> categoryIds = productVoList.stream().map(ShopProductVo::getCategoryId).collect(Collectors.toList());
        List<ShopProductCategory> categoryList = shopProductCategoryMapper.getByIds(categoryIds);
        // 封装进去
        productVoList.forEach(e -> {
            ShopProductCategory category = categoryList.stream().filter(c -> c.getId().equals(e.getCategoryId())).findFirst().orElse(new ShopProductCategory());
            e.setCategory(category);
        });
        page.setList(productVoList);
        page.setTotalCount(totalCount);
        return page;
    }

    @Override
    public ShopProductVo getUpdate(Long id) {
        // 根据id查询
        ShopProduct product = shopProductMapper.getById(id);
        // 转换成VO
        ShopProductVo shopProductVo = new ShopProductVo();
        BeanUtils.copyProperties(product, shopProductVo);
        // 处理轮播图
        if (StringUtils.isNotBlank(product.getAlbumPics())) {
            shopProductVo.setAlbumPicList(Arrays.asList(product.getAlbumPics().split(",")));
        }
        // 处理categoryIds
        // 拿到子节点id
        Long categoryId = product.getCategoryId();
        Deque<Long> deque = new ArrayDeque<>(4);
        while (categoryId != null && !categoryId.equals(CoreConstant.DEFAULT_PARENT_ID)) {
            // 根据子节点ID查询分类
            ShopProductCategory category = shopProductCategoryMapper.get(categoryId);
            if (category != null) {
                // 入列
                deque.push(category.getId());
                categoryId = category.getParentId();
            } else {
                break;
            }
        }
        // 封装到vo里
        shopProductVo.setCategoryIds(new ArrayList<>(deque));
        return shopProductVo;
    }

    @Override
    public void update(ShopProductDto shopProductDto) {
        ShopProduct shopProduct = new ShopProduct();
        BeanUtils.copyProperties(shopProductDto, shopProduct);
        // 处理轮播图
        List<String> albumPicList = shopProductDto.getAlbumPicList();
        if (CollectionUtils.isEmpty(albumPicList)) {
            shopProduct.setAlbumPics(shopProduct.getPic());
        } else {
            shopProduct.setAlbumPics(StringUtils.join(albumPicList, ","));
        }
        ShopBrand brand = shopBrandMapper.get(shopProduct.getBrandId());
        shopProduct.setBrandName(brand.getName());
        // 副标题如果为空，就设置为标题
        if (StringUtils.isBlank(shopProduct.getSubTitle())) {
            shopProduct.setSubTitle(shopProduct.getName());
        }
        // 创建人、修改人
        SysUserVo loginUser = ShiroUtils.getLoginUser();
        shopProduct.setUpdateBy(loginUser.getUsername());
        shopProductMapper.update(shopProduct);
        // 处理商品套装
        handleUpdateProductPack(shopProductDto, shopProduct, loginUser);
    }

    /**
     * 处理修改时的商品套装逻辑
     *
     * @param shopProductDto 前端传参的商品对象
     * @param shopProduct    当前商品
     * @param loginUser      当前登录用户
     */
    private void handleUpdateProductPack(ShopProductDto shopProductDto, ShopProduct shopProduct, SysUserVo loginUser) {
        ShopPack shopPack = shopProductDto.getShopPack();
        List<ShopProduct> productList = shopProductDto.getProductList();
        // * 用户选择了关联套装和关联商品
        if (shopPack != null && !CollectionUtils.isEmpty(productList)) {
            // 根据商品编号查询套装
            //  * 该商品没有加入其它套装：将该商品和选择的商品都加入到套装中。
            List<Long> productIds = productList.stream().map(ShopProduct::getId).collect(Collectors.toList());
            List<ShopProduct> products = shopProductMapper.getByIds(productIds);
            // 将该商品加入到products
            products.add(shopProduct);
            handleUpdateProductPack(shopProductDto, shopPack, products);
        } else if (shopPack != null) {
            //* 用户没同时选择关联套装和关联商品
            //  * 用户选择了关联套装
            //    * 该商品没套装：将该商品加入到选择的套装中
            List<ShopProduct> products = new ArrayList<>();
            // 将该商品加入到products
            products.add(shopProduct);
            handleUpdateProductPack(shopProductDto, shopPack, products);
        } else if (!CollectionUtils.isEmpty(productList)) {
            //  * 用户选择了关联商品
            //    * 该商品没套装：将该商品和选择的商品打包成一个套装
            List<ShopProduct> products = new ArrayList<>();
            // 将该商品加入到products
            products.add(shopProduct);
            // 创建套装
            shopPack = new ShopPack();
            // ShopPack入库
            shopPack.setCreateBy(loginUser.getUsername());
            shopPack.setName(shopProduct.getName());
            shopPack.setProductCount(productList.size() + 1);
            long packCode = idWorker.nextId();
            shopPack.setId(packCode);
            // 保存
            shopPackMapper.save(shopPack);
            handleUpdateProductPack(shopProductDto, shopPack, products);
        }
    }

    /**
     * 处理修改商品时的套装逻辑
     *
     * @param shopProductDto
     * @param shopPack
     * @param products
     */
    private void handleUpdateProductPack(ShopProductDto shopProductDto, ShopPack shopPack, List<ShopProduct> products) {
        handleProductPack(shopPack.getId(), products);
        ShopProductPack shopProductPack = shopProductPackMapper.getByProductId(shopProductDto.getId());
        if (shopProductPack != null) {
            //  * 该商品加入了其它套装：将该商品和选择的商品都加入到套装中，并减少原套装的商品数。
            // 减少原套装的商品数
            Long oldPackCode = shopProductPack.getPackCode();
            ShopPack oldPack = shopPackMapper.get(oldPackCode);
            oldPack.setProductCount(oldPack.getProductCount() - 1);
            // 如果商品数等于0，就删除该套装，否则修改
            if (oldPack.getProductCount() == 0) {
                shopPackMapper.delete(oldPackCode);
            } else {
                shopPackMapper.update(oldPack);
            }
            // 删除原关联
            shopProductPackMapper.deleteById(shopProductPack.getId());
        }
    }

    @Override
    public void delete(Long id) {
        shopProductMapper.delete(id);
    }

    @Override
    public void publish(Long id) {
        ShopProduct product = shopProductMapper.getById(id);
        product.setPublishStatus(StateEnums.ENABLED.getCode());
        shopProductMapper.updatePublish(product);
    }

    @Override
    public void unPublish(Long id) {
        ShopProduct product = shopProductMapper.getById(id);
        product.setPublishStatus(StateEnums.NOT_ENABLE.getCode());
        shopProductMapper.updatePublish(product);
    }

    @Override
    public void news(Long id) {
        ShopProduct product = shopProductMapper.getById(id);
        product.setNewStatus(StateEnums.ENABLED.getCode());
        shopProductMapper.updateNewStatus(product);
    }

    @Override
    public void old(Long id) {
        ShopProduct product = shopProductMapper.getById(id);
        product.setNewStatus(StateEnums.NOT_ENABLE.getCode());
        shopProductMapper.updateNewStatus(product);
    }

    @Override
    public void recommend(Long id) {
        ShopProduct product = shopProductMapper.getById(id);
        product.setRecommendStatus(StateEnums.ENABLED.getCode());
        shopProductMapper.updateRecommend(product);
    }

    @Override
    public void unRecommend(Long id) {
        ShopProduct product = shopProductMapper.getById(id);
        product.setRecommendStatus(StateEnums.NOT_ENABLE.getCode());
        shopProductMapper.updateRecommend(product);
    }

    @Override
    public List<ShopProduct> getProductDetailList(Long packCode) {
        List<ShopProductPack> packList = shopProductPackMapper.getByPackCode(packCode);
        if (CollectionUtils.isEmpty(packList)) {
            return new ArrayList<>(0);
        }
        // 获取商品id
        List<Long> productIds = packList.stream().map(ShopProductPack::getProductId).collect(Collectors.toList());
        return shopProductMapper.getByIds(productIds);
    }

    @Override
    public Page<ShopProductVo> getByPageHasNotPack(Page<ShopProductVo> page) {
        // 查询list和总条数
        List<ShopProduct> list = shopProductMapper.getByPageHasNotPack(page);
        Integer totalCount = shopProductMapper.countByPageHasNotPack(page);
        // ShopProduct的list转成vo的list
        List<ShopProductVo> productVoList = list.stream().map(e -> {
            ShopProductVo vo = new ShopProductVo();
            BeanUtils.copyProperties(e, vo);
            return vo;
        }).collect(Collectors.toList());
        // 处理分类名称
        List<Long> categoryIds = productVoList.stream().map(ShopProductVo::getCategoryId).collect(Collectors.toList());
        List<ShopProductCategory> categoryList = shopProductCategoryMapper.getByIds(categoryIds);
        // 封装进去
        productVoList.forEach(e -> {
            ShopProductCategory category = categoryList.stream().filter(c -> c.getId().equals(e.getCategoryId())).findFirst().orElse(new ShopProductCategory());
            e.setCategory(category);
        });
        page.setList(productVoList);
        page.setTotalCount(totalCount);
        return page;
    }
}

```



## 3.2 前端

### 3.2.1 页面编写

#### select-pack

```vue
<template>
  <div>
    <!-- 搜索表单结束 -->
    <!-- 数据表格开始 -->
    <div class="data-table">
      <el-table
        ref="selectTable"
        v-loading="loading"
        :data="dataPage.list"
        header-row-class-name="table-header"
        stripe
        highlight-current-row
        style="width: 100%"
        @current-change="selectRow"
      >
        <el-table-column prop="id" label="套装编号" width="200" />
        <el-table-column prop="name" label="名称" />
        <el-table-column prop="productCount" label="商品数" />
        <el-table-column prop="createTime" label="创建时间" />
        <el-table-column prop="createBy" label="创建人" />
      </el-table>
      <el-pagination
        class="pagination"
        :current-page="page.currentPage"
        :page-sizes="[10,20,30,50]"
        :page-size="page.pageSize"
        layout="total, sizes, prev, pager, next, jumper"
        :total="dataPage.totalCount"
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
      />
    </div>
    <!-- 数据表格结束 -->

  </div>
</template>
<script>
import packApi from '@/api/shopPack'
export default {
  data() {
    return {
      page: {
        currentPage: 1,
        pageSize: 10,
        params: {}
      },
      dataPage: {
        list: [],
        totalCount: 0,
        totalPage: 0
      },
      loading: false
    }
  },
  created() {
    this.getByPage()
  },
  methods: {
    handleSizeChange(val) {
      this.page.pageSize = val
      this.getByPage()
    },
    selectRow(row, oldRow) {
      this.$emit('selected', row)
    },
    handleCurrentChange(val) {
      this.page.currentPage = val
      this.getByPage()
    },
    search() {
      this.page.currentPage = 1
      this.getByPage()
    },
    getByPage() {
      this.loading = true
      packApi.getByPage(this.page).then(res => {
        this.dataPage = res.data
        this.loading = false
      })
    }
  }
}
</script>
<style scoped>
.pagination {
  margin-top: 15px;
}
.mid-button-group {
  margin-bottom: 15px;
}
.button-group {
  margin-left: 10px;
}
</style>

```

#### product-add

```vue
<template>
  <div class="form">
    <el-card class="product-card" shadow="never">
      <el-steps align-center :active="active" finish-status="success">
        <el-step title="商品信息" />
        <el-step title="商品营销" />
        <el-step title="商品详情" />
        <el-step title="商品关联" />
      </el-steps>
      <el-form size="small" label-width="80px">
        <div v-show="active === 0" class="product-info">
          <el-row>
            <el-col :span="12">
              <el-form-item label="商品分类">
                <el-cascader
                  v-model="product.categoryIds"
                  :emit-path="false"
                  :show-all-levels="false"
                  :options="categoryList"
                  style="width: 100%"
                  placeholder="请选择分类"
                  :props="{label:'name', value:'id'}"
                  @change="categoryChange"
                />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="商品品牌">
                <el-select
                  v-model="product.brandId"
                  style="width: 100%"
                  placeholder="请选择品牌"
                  clearable
                  filterable
                >
                  <el-option
                    v-for="item in brandList"
                    :key="item.id"
                    :label="item.name"
                    :value="item.id"
                  />
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="24">
              <el-form-item label="商品名称">
                <el-input
                  v-model="product.name"
                  placeholder="商品名称"
                  clearable
                />
              </el-form-item>
            </el-col>
            <el-col :span="24">
              <el-form-item label="副标题">
                <el-input
                  v-model="product.subTitle"
                  placeholder="副标题"
                  clearable
                />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="库存">
                <el-input-number
                  v-model="product.stock"
                  style="width: 100%"
                  placeholder="库存"
                  clearable
                />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="警戒库存">
                <el-input-number
                  v-model="product.lowStock"
                  style="width: 100%"
                  placeholder="警戒库存"
                  clearable
                />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="排序">
                <el-input-number
                  v-model="product.sort"
                  placeholder="排序"
                  clearable
                />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="规格">
                <el-input
                  v-model="product.specs"
                  placeholder="规格"
                  clearable
                />
              </el-form-item>
            </el-col>
            <el-col :span="24">
              <el-form-item label="商品描述">
                <el-input
                  v-model="product.productComment"
                  type="textarea"
                  :rows="4"
                  placeholder="商品描述"
                  clearable
                />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-form-item>
              <el-button type="primary" @click="active++">下一步，填写商品营销</el-button>
            </el-form-item>
          </el-row>
        </div>
        <div v-show="active === 1" class="product-info">
          <el-row>
            <el-col :span="24">
              <el-form-item label="价格">
                <el-input-number
                  v-model="product.price"
                  style="width: 100%"
                  placeholder="价格"
                  clearable
                />
              </el-form-item>
            </el-col>
            <el-col :span="24">
              <el-form-item label="上架">
                <el-switch
                  v-model="product.publishStatus"
                  :active-value="1"
                  :inactive-value="0"
                />
              </el-form-item>
              <el-form-item label="新品">
                <el-switch
                  v-model="product.newStatus"
                  :active-value="1"
                  :inactive-value="0"
                />
              </el-form-item>
              <el-form-item label="推荐">
                <el-switch
                  v-model="product.recommendStatus"
                  :active-value="1"
                  :inactive-value="0"
                />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="积分">
                <el-input-number
                  v-model="product.point"
                  style="width: 100%"
                  placeholder="积分"
                  clearable
                />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="运费">
                <el-input-number
                  v-model="product.transFee"
                  style="width: 100%"
                  placeholder="运费"
                  clearable
                />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-form-item>
              <el-button @click="active--">上一步，填写商品信息</el-button>
              <el-button type="primary" @click="active++">下一步，填写商品详情</el-button>
            </el-form-item>
          </el-row>
        </div>
        <div v-show="active === 2" class="product-info">
          <el-row>
            <el-col :span="24">
              <el-form-item label="图片">
                <el-upload
                  class="avatar-uploader"
                  :action="uploadUrl"
                  :show-file-list="false"
                  :data="{dir: 'product'}"
                  :on-success="handlePicSuccess"
                >
                  <img v-if="picUrl" :src="picUrl" class="avatar">
                  <i v-else class="el-icon-plus avatar-uploader-icon" />
                </el-upload>
                <div class="danger-text">请上传封面图片，该图片用于列表页展示</div>
              </el-form-item>
            </el-col>
            <el-col :span="24">
              <el-form-item label="轮播图">
                <el-upload
                  class="upload-demo"
                  :action="uploadUrl"
                  :file-list="picList"
                  :on-remove="handleRemove"
                  :on-success="handlePicListSuccess"
                  :data="{dir: 'product'}"
                  list-type="picture"
                >
                  <el-button size="small" type="primary">点击上传</el-button>
                  <div slot="tip" class="el-upload__tip">只能上传jpg/png文件，且不超过500kb</div>
                </el-upload>
                <div class="danger-text">请上传商品详情轮播图，如果不上传，默认采用上面的图片</div>
              </el-form-item>
            </el-col>
            <el-col :span="24">
              <el-form-item label="商品详情">
                <div class="danger-text">商品详情建议采用上传多图的方式。文字内容过多可能会影响加载效果</div>
                <tinymce ref="tinymce" v-model="product.productContent" :height="300" />
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-form-item>
              <el-button @click="active--">上一步，填写商品营销</el-button>
              <el-button type="primary" @click="active++">下一步，填写商品关联</el-button>
            </el-form-item>
          </el-row>
        </div>
        <div v-show="active === 3" class="product-info">
          <el-row>
            <el-col :span="24">
              <el-form-item>
                <div class="danger-text">请选择与该商品打包的商品，也可以直接将该商品加入到指定套装。如果都进行选择，则会将该商品和选中商品一并加入套装</div>
              </el-form-item>
            </el-col>
            <el-col :span="24">
              <el-form-item label="关联套装">
                <el-button style="margin-bottom: 15px" type="primary" size="small" @click="toSelectPack">选择套装</el-button>
                <el-table
                  :data="selectPackList"
                  header-row-class-name="table-header"
                  stripe
                  border
                  row-key="id"
                >
                  <el-table-column prop="id" label="套装编号" />
                  <el-table-column prop="name" label="名称" />
                  <el-table-column prop="productCount" label="商品数" />
                  <el-table-column prop="createTime" label="创建时间" />
                  <el-table-column prop="createBy" label="创建人" />
                </el-table>
              </el-form-item>
            </el-col>
            <el-col :span="24">
              <el-form-item label="商品打包">
                <el-button style="margin-bottom: 15px" type="primary" size="small" @click="toSelectProduct">选择商品</el-button>
                <el-table
                  :data="product.productList"
                  header-row-class-name="table-header"
                  stripe
                  border
                  style="width: 100%"
                >
                  <el-table-column
                    prop="name"
                    label="名称"
                  />
                  <el-table-column
                    prop="price"
                    label="价格"
                  />
                  <el-table-column
                    prop="stock"
                    label="库存"
                  />
                  <el-table-column
                    prop="brandName"
                    label="品牌"
                  />

                  <el-table-column
                    label="操作"
                    fixed="right"
                  >
                    <template slot-scope="{row}">
                      <el-button type="text" icon="el-icon-delete" @click="deleteProduct(row.id)">删除</el-button>
                    </template>
                  </el-table-column>
                </el-table>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-form-item>
              <el-button @click="active--">上一步，填写商品详情</el-button>
              <el-button type="primary" @click="add">提交</el-button>
            </el-form-item>
          </el-row>
        </div>
      </el-form>
    </el-card>

    <el-dialog
      title="选择商品"
      :visible.sync="selectProductDialog"
      width="60%"
    >
      <select-product :default-select="product.productList" @selected="setProductList" />
    </el-dialog>

    <el-dialog
      title="选择套装"
      :visible.sync="selectPackDialog"
      width="60%"
    >
      <select-pack @selected="setPack" />
    </el-dialog>
  </div>
</template>
<script>
import shopProductApi from '@/api/shopProduct'
import Tinymce from '@/components/Tinymce'
import categoryApi from '@/api/shopProductCategory'
import selectProduct from '@/views/product/pack/pack-product-select'
import selectPack from './pack-select'
import brandApi from '@/api/shopBrand'
export default {
  components: { Tinymce, selectProduct, selectPack },
  data() {
    return {
      product: {
        albumPicList: []
      },
      picList: [],
      active: 0,
      selectPackList: [],
      brandList: [],
      selectProductDialog: false,
      selectPackDialog: false,
      categoryList: [],
      picUrl: null,
      uploadUrl: process.env.VUE_APP_UPLOAD_URL
    }
  },
  created() {
    this.getCategory()
  },
  methods: {
    add() {
      const prod = { ...this.product }
      const ids = prod.categoryIds
      prod.categoryId = ids[ids.length - 1]
      shopProductApi.save(prod).then(res => {
        this.$message.success(res.msg)
        this.$emit('after')
      })
    },
    getBrand(categoryId) {
      brandApi.getByCategory(categoryId).then(res => {
        this.brandList = res.data
      })
    },
    nextStep() {
      this.active++
    },
    handlePicSuccess(res, file) {
      this.picUrl = res.data
      this.product.pic = this.picUrl
    },
    handlePicListSuccess(res, file) {
      file.url = res.data
      this.product.albumPicList.push(res.data)
      console.log(res, file)
    },
    handleRemove(file, fileList) {
      console.log(fileList)
      this.product.albumPicList.splice(
        this.product.albumPicList.findIndex(e => e === file.url), 1
      )
    },
    toSelectProduct() {
      this.selectProductDialog = true
    },
    toSelectPack() {
      this.selectPackDialog = true
    },
    setProductList(productList) {
      this.product.productList = productList
      this.selectProductDialog = false
    },
    setPack(pack) {
      this.product.shopPack = pack
      this.selectPackList = [pack]
      this.selectPackDialog = false
    },
    deleteProduct(id) {
      this.product.productList.splice(
        this.product.productList.findIndex(e => e.id === id),
        1
      )
    },
    categoryChange(ids) {
      this.$set(this.product, 'brandId', null)
      this.getBrand(ids[ids.length - 1])
    },
    getCategory() {
      categoryApi.getTree().then(res => {
        this.categoryList = res.data
      })
    }
  }
}
</script>

<style scoped>
.product-card {
  max-width: 800px;
  padding: 40px;
  margin: auto;
}
.form >>> .el-form {
  margin-top: 50px;
}
.danger-text {
  color: red;
}
</style>

<style>
  .avatar-uploader .el-upload {
    border: 1px dashed #d9d9d9;
    border-radius: 6px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }
  .avatar-uploader .el-upload:hover {
    border-color: #409EFF;
  }
  .avatar-uploader-icon {
    font-size: 28px;
    color: #8c939d;
    width: 178px;
    height: 178px;
    line-height: 178px;
    text-align: center;
  }
  .avatar {
    width: 178px;
    height: 178px;
    display: block;
  }
</style>

```

# 4. 营销管理

## 4.1 优惠券

现在是我们优惠券的第一阶段。因为还没有小程序端 ，暂时只能做CRUD。

优惠券设计的表有

| 表名                 | 描述          |
| -------------------- | ------------- |
| shop_coupon          | 优惠券表      |
| shop_coupon_category | 优惠券-分类表 |
| shop_coupon_product  | 优惠券-商品表 |

优惠券可以发布全场、指定分类、指定商品。

那么我们就开始编写优惠券代码。

### 4.1.1 后端

#### ShopCoupon

```java
package com.jg.pochi.pojo;

import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;

/**
 * @Author: 杨德石
 * @Date: 2020/12/9 20:48
 * @Version 1.0
 */
@Data
public class ShopCoupon implements Serializable {

    /**
     * 编号，雪花算法
     */
    private Long id;

    /**
     * 使用类型，0全场通用，1指定分类，2指定商品
     */
    private Integer couponType;

    /**
     * 名称
     */
    private String name;

    /**
     * 优惠券金额
     */
    private BigDecimal amount;

    /**
     * 使用门槛
     */
    private BigDecimal minPoint;

    /**
     * 有效时间起
     */
    private String startTime;

    /**
     * 有效时间止
     */
    private String endTime;

    /**
     * 剩余数量
     */
    private Integer restCount;

    /**
     * 发行数量
     */
    private Integer publishCount;

    /**
     * 使用数量
     */
    private Integer useCount;

    /**
     * 领取数量
     */
    private Integer receiveCount;

    /**
     * 创建人
     */
    private String createBy;

    /**
     * 创建时间
     */
    private String createTime;

    /**
     * 修改人
     */
    private String updateBy;

    /**
     * 修改时间
     */
    private String updateTime;

    /**
     * 是否删除，1是0否
     */
    private Integer deleted;

    /**
     * 状态，1正常0过期
     */
    private Integer status;

}

```

#### ShopCouponDto

```java
package com.jg.pochi.pojo.dto;

import com.jg.pochi.pojo.ShopProduct;
import com.jg.pochi.pojo.ShopProductCategory;
import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;
import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2020/12/9 20:48
 * @Version 1.0
 */
@Data
public class ShopCouponDto implements Serializable {

    /**
     * 编号，雪花算法
     */
    private Long id;

    /**
     * 使用类型，0全场通用，1指定分类，2指定商品
     */
    private Integer couponType;

    /**
     * 名称
     */
    private String name;

    /**
     * 优惠券金额
     */
    private BigDecimal amount;

    /**
     * 使用门槛
     */
    private BigDecimal minPoint;

    /**
     * 有效时间起
     */
    private String startTime;

    /**
     * 有效时间止
     */
    private String endTime;

    /**
     * 发行数量
     */
    private Integer publishCount;

    /**
     * 状态，1正常0过期
     */
    private Integer status;

    /**
     * 分类列表
     */
    private List<ShopProductCategory> categoryList;

    /**
     * 商品列表
     */
    private List<ShopProduct> productList;


}

```

#### ShopCouponProduct

```JAVA
package com.jg.pochi.pojo;

import lombok.Data;

import java.io.Serializable;

/**
 * @Author: 杨德石
 * @Date: 2020/12/9 20:51
 * @Version 1.0
 */
@Data
public class ShopCouponProduct implements Serializable {

    private Long id;

    /**
     * 优惠券ID
     */
    private Long couponId;

    /**
     * 商品ID
     */
    private Long productId;

    public ShopCouponProduct(Long couponId, Long productId) {
        this.couponId = couponId;
        this.productId = productId;
    }
}

```

#### ShopCouponCategory

````java
package com.jg.pochi.pojo;

import lombok.Data;

import java.io.Serializable;

/**
 * @Author: 杨德石
 * @Date: 2020/12/9 20:51
 * @Version 1.0
 */
@Data
public class ShopCouponCategory implements Serializable {

    private Long id;

    /**
     * 优惠券ID
     */
    private Long couponId;

    /**
     * 分类ID
     */
    private Long categoryId;

    public ShopCouponCategory(Long couponId, Long categoryId) {
        this.couponId = couponId;
        this.categoryId = categoryId;
    }
}

````



#### ShopCouponController

```java
package com.jg.pochi.controller;

import com.jg.pochi.common.Page;
import com.jg.pochi.common.Result;
import com.jg.pochi.pojo.ShopCoupon;
import com.jg.pochi.pojo.dto.ShopCouponDto;
import com.jg.pochi.service.ShopCouponService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

/**
 * @Author: 杨德石
 * @Date: 2020/12/9 20:58
 * @Version 1.0
 */
@RestController
@RequestMapping("/shopCoupon")
public class ShopCouponController {

    @Autowired
    private ShopCouponService  shopCouponService;

    /**
     * 添加
     * @param shopCouponDto
     * @return
     */
    @RequestMapping(value = "/save", method = RequestMethod.POST)
    public Result<?> save(@RequestBody ShopCouponDto shopCouponDto) {
        shopCouponService.save(shopCouponDto);
        return new Result<>("添加成功");
    }

    /**
     * 根据id删除
     * @param id
     * @return
     */
    @RequestMapping(value = "/delete/{id}", method = RequestMethod.DELETE)
    public Result<?> delete(@PathVariable Long id) {
        shopCouponService.delete(id);
        return new Result<>("删除成功");
    }

    /**
     * 下架
     * @param id
     * @return
     */
    @RequestMapping(value = "/down/{id}", method = RequestMethod.PUT)
    public Result<?> down(@PathVariable Long id) {
        shopCouponService.down(id);
        return new Result<>("下架成功");
    }

    /**
     * 分页查询
     * @param page
     * @return
     */
    @RequestMapping(value = "/getByPage", method = RequestMethod.POST)
    public Result<Page<ShopCoupon>> getByPage(@RequestBody Page<ShopCoupon> page) {
        page = shopCouponService.getByPage(page);
        return new Result<>(page);
    }

}

```



#### ShopCouponService

```java
package com.jg.pochi.service;

import com.jg.pochi.common.Page;
import com.jg.pochi.pojo.ShopCoupon;
import com.jg.pochi.pojo.dto.ShopCouponDto;

/**
 * @Author: 杨德石
 * @Date: 2020/12/9 20:57
 * @Version 1.0
 */
public interface ShopCouponService {

    /**
     * 添加
     * @param shopCouponDto
     */
    void save(ShopCouponDto shopCouponDto);

    /**
     * 删除
     * @param id
     */
    void delete(Long id);

    /**
     * 下架
     * @param id
     */
    void down(Long id);

    /**
     * 分页查询
     * @param page
     * @return
     */
    Page<ShopCoupon> getByPage(Page<ShopCoupon> page);
}

```



#### ShopCouponServiceImpl

```java
package com.jg.pochi.service.impl;

import com.jg.pochi.common.Page;
import com.jg.pochi.enums.StateEnums;
import com.jg.pochi.mapper.ShopCouponCategoryMapper;
import com.jg.pochi.mapper.ShopCouponMapper;
import com.jg.pochi.mapper.ShopCouponProductMapper;
import com.jg.pochi.pojo.ShopCoupon;
import com.jg.pochi.pojo.ShopCouponCategory;
import com.jg.pochi.pojo.ShopCouponProduct;
import com.jg.pochi.pojo.dto.ShopCouponDto;
import com.jg.pochi.pojo.vo.SysUserVo;
import com.jg.pochi.service.ShopCouponService;
import com.jg.pochi.utils.IdWorker;
import com.jg.pochi.utils.ShiroUtils;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

/**
 * @Author: 杨德石
 * @Date: 2020/12/9 20:58
 * @Version 1.0
 */
@Service
public class ShopCouponServiceImpl implements ShopCouponService {

    @Autowired
    private ShopCouponMapper shopCouponMapper;
    @Autowired
    private ShopCouponCategoryMapper shopCouponCategoryMapper;
    @Autowired
    private ShopCouponProductMapper shopCouponProductMapper;
    @Autowired
    private IdWorker idWorker;

    /**
     * @param shopCouponDto
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public void save(ShopCouponDto shopCouponDto) {
        long couponId = idWorker.nextId();
        // 复制属性
        ShopCoupon shopCoupon = new ShopCoupon();
        BeanUtils.copyProperties(shopCouponDto, shopCoupon);
        // 设置默认值
        SysUserVo loginUser = ShiroUtils.getLoginUser();
        shopCoupon.setId(couponId);
        shopCoupon.setCreateBy(loginUser.getUsername());
        shopCoupon.setUpdateBy(loginUser.getUsername());
        shopCoupon.setRestCount(shopCoupon.getPublishCount());
        shopCouponMapper.save(shopCoupon);
        // 如果有分类，添加优惠券-分类关联
        if (StateEnums.CATEGORY.getCode().equals(shopCoupon.getCouponType())) {
            List<ShopCouponCategory> couponCategoryList = shopCouponDto.getCategoryList().stream().map(e -> new ShopCouponCategory(couponId, e.getId())).collect(Collectors.toList());
            shopCouponCategoryMapper.saveBatch(couponCategoryList);
        }
        // 如果有商品，添加优惠券-商品关联
        if (StateEnums.PRODUCT.getCode().equals(shopCoupon.getCouponType())) {
            List<ShopCouponProduct> couponProductList = shopCouponDto.getProductList().stream().map(e -> new ShopCouponProduct(couponId, e.getId())).collect(Collectors.toList());
            shopCouponProductMapper.saveBatch(couponProductList);
        }
    }

    @Override
    public void delete(Long id) {
        shopCouponMapper.delete(id);
    }

    @Override
    public void down(Long id) {
        shopCouponMapper.down(id);
    }

    @Override
    public Page<ShopCoupon> getByPage(Page<ShopCoupon> page) {
        List<ShopCoupon> list = shopCouponMapper.getByPage(page);
        Integer totalCount = shopCouponMapper.countByPage(page);
        page.setList(list);
        page.setTotalCount(totalCount);
        return page;
    }
}

```



#### ShopCouponMapper

```java
package com.jg.pochi.mapper;

import com.jg.pochi.common.Page;
import com.jg.pochi.pojo.ShopCoupon;
import org.springframework.stereotype.Component;

import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2020/11/8 13:46
 * @Version 1.0
 */
@Component
public interface ShopCouponMapper {

    /**
     * 添加
     * @param shopCoupon
     */
    void save(ShopCoupon shopCoupon);

    /**
     * 删除
     * @param id
     */
    void delete(Long id);

    /**
     * 下架
     * @param id
     */
    void down(Long id);

    /**
     * 分页查询
     * @param page
     * @return
     */
    List<ShopCoupon> getByPage(Page<ShopCoupon> page);

    /**
     * 查询总数
     * @param page
     * @return
     */
    Integer countByPage(Page<ShopCoupon> page);
}

```



#### ShopCouponMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jg.pochi.mapper.ShopCouponMapper">
    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.jg.pochi.pojo.ShopCoupon">
        <id column="id" property="id"/>
        <result column="coupon_type" property="couponType"/>
        <result column="name" property="name"/>
        <result column="amount" property="amount"/>
        <result column="min_point" property="minPoint"/>
        <result column="start_time" property="startTime"/>
        <result column="end_time" property="endTime"/>
        <result column="rest_count" property="restCount"/>
        <result column="publish_count" property="publishCount"/>
        <result column="use_count" property="useCount"/>
        <result column="receive_count" property="receiveCount"/>
        <result column="create_by" property="createBy"/>
        <result column="create_time" property="createTime"/>
        <result column="update_by" property="updateBy"/>
        <result column="update_time" property="updateTime"/>
        <result column="deleted" property="deleted"/>
        <result column="status" property="status"/>
    </resultMap>
    <insert id="save">
        insert into shop_coupon(id, coupon_type, name, amount, min_point,
                                start_time, end_time, rest_count,
                                publish_count, create_by, update_by)
        VALUES (#{id}, #{couponType}, #{name}, #{amount}, #{minPoint},
                #{startTime}, #{endTime}, #{restCount},
                #{publishCount}, #{createBy}, #{updateBy})
    </insert>
    <update id="delete">
        update shop_coupon
        set deleted = 1
        where id = #{id}
    </update>
    <update id="down">
        update shop_coupon
        set status = 0
        where id = #{id}
    </update>
    <select id="getByPage" resultMap="BaseResultMap">
        select id,
        coupon_type,
        name,
        amount,
        min_point,
        start_time,
        end_time,
        rest_count,
        publish_count,
        use_count,
        receive_count,
        create_by,
        create_time,
        status
        from shop_coupon
        where deleted = 0
        <if test="params.name != null and params.name != ''">
            and name like concat('%', #{params.name}, '%')
        </if>
        order by create_time desc
        limit #{index}, #{pageSize}
    </select>
    <select id="countByPage" resultType="java.lang.Integer">
        select count(*)
        from shop_coupon
        where deleted = 0
        <if test="params.name != null and params.name != ''">
            and name like concat('%', #{params.name}, '%')
        </if>
    </select>



</mapper>

```

#### ShopCouponProductMapper

```java
package com.jg.pochi.mapper;

import com.jg.pochi.pojo.ShopCouponProduct;
import org.springframework.stereotype.Component;

import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2020/11/8 13:46
 * @Version 1.0
 */
@Component
public interface ShopCouponProductMapper {

    /**
     * 批量插入
     * @param couponProductList
     */
    void saveBatch(List<ShopCouponProduct> couponProductList);
}

```



#### ShopCouponProductMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jg.pochi.mapper.ShopCouponProductMapper">
    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.jg.pochi.pojo.ShopCouponProduct">
        <id column="id" property="id"/>
        <result column="product_id" property="productId"/>
        <result column="coupon_id" property="couponId"/>
    </resultMap>
    <insert id="saveBatch">
        insert into shop_coupon_product( coupon_id, product_id) values
        <foreach collection="list" separator="," item="item">
            (#{item.couponId}, #{item.productId})
        </foreach>
    </insert>



</mapper>

```



#### ShopCouponCategoryMapper

```java
package com.jg.pochi.mapper;

import com.jg.pochi.pojo.ShopCouponCategory;
import org.springframework.stereotype.Component;

import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2020/11/8 13:46
 * @Version 1.0
 */
@Component
public interface ShopCouponCategoryMapper {

    /**
     * 批量插入
     * @param couponCategoryList
     */
    void saveBatch(List<ShopCouponCategory> couponCategoryList);
}

```



#### ShopCouponCategoryMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jg.pochi.mapper.ShopCouponCategoryMapper">
    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.jg.pochi.pojo.ShopCouponCategory">
        <id column="id" property="id"/>
        <result column="category_id" property="categoryId"/>
        <result column="coupon_id" property="couponId"/>
    </resultMap>
    <insert id="saveBatch">
        insert into shop_coupon_category( coupon_id, category_id) values
        <foreach collection="list" item="item" separator=",">
            (#{item.couponId}, #{item.categoryId})
        </foreach>
    </insert>



</mapper>

```



### 4.1.2 前端

#### API

在 `api` 下新建 `shopCoupon.js` 文件，内容如下。

```js
import request from '@/utils/request'
const groupName = 'shopCoupon'
export default {
  /**
   * 添加
   */
  save(sysUser) {
    return request({
      url: `/${groupName}/save`,
      method: 'post',
      data: sysUser
    })
  },
  /**
   * 分页查询
   * @param {分页查询} page
   */
  getByPage(page) { // 分页查询
    return request({
      url: `/${groupName}/getByPage`,
      method: 'post',
      data: page
    })
  },
  /**
   * 删除
   * @param {*} id
   */
  delete(id) {
    return request({
      url: `/${groupName}/delete/${id}`,
      method: 'delete'
    })
  },
  /**
   * 下架
   */
  down(id) {
    return request({
      url: `/${groupName}/down/${id}`,
      method: 'put'
    })
  }
}

```

#### 页面编写

在 `views` 下新建 `market/coupon`，在下面创建 `coupon-list.vue、coupon-add.vue`

##### coupon-list.vue

```vue
<template>
  <div>
    <!-- 搜索表单 -->
    <div class="search-form">
      <el-form :model="page.params" :inline="true" size="small">
        <el-form-item>
          <el-input v-model="page.params.name" clearable placeholder="" />
        </el-form-item>
        <el-form-item>
          <el-button type="primary" icon="el-icon-search" @click="search">查询</el-button>
          <el-button type="warning" icon="el-icon-refresh" @click="page.params = {}">重置</el-button>
        </el-form-item>
      </el-form>
    </div>
    <!-- 搜索表单结束 -->
    <!-- 添加按钮 -->
    <div class="button-group">
      <el-button type="primary" size="small" icon="el-icon-plus" @click="toAdd">添加</el-button>
    </div>
    <!-- 添加按钮结束 -->
    <!-- 数据表格 -->
    <div class="data-table">
      <el-table
        header-row-class-name="pochi-table-header"
        :data="dataPage.list"
        stripe
        style="width: 10"
      >
        <el-table-column prop="name" label="名称" />
        <el-table-column prop="couponType" label="类型" />
        <el-table-column prop="amount" label="面值" />
        <el-table-column prop="minPoint" label="门槛" />
        <el-table-column label="数量">
          <template slot-scope="{row}">
            <div>发行数：{{ row.publishCount }}</div>
            <div>已领取：{{ row.receiveCount }}</div>
            <div>已使用：{{ row.useCount }}</div>
            <div>剩余数：{{ row.restCount }}</div>
          </template>
        </el-table-column>
        <el-table-column label="有效期">
          <template slot-scope="{row}">
            <div>{{ row.startTime }}</div>
            <div>至</div>
            <div>{{ row.endTime }}</div>
          </template>
        </el-table-column>
        <el-table-column prop="status" label="状态">
          <template slot-scope="{row}">
            <el-tag v-if="row.status === 1" type="success">未过期</el-tag>
            <el-tag v-else type="info">已过期</el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="createTime" label="创建时间" />
        <el-table-column prop="createBy" label="创建人" />
        <el-table-column label="操作" width="200px">
          <template slot-scope="{row}">
            <el-button type="text" icon="el-icon-document" @click="toInfo(row.id)">详情</el-button>
            <el-button type="text" icon="el-icon-edit" @click="toDown(row.id)">下架</el-button>
            <el-button type="text" icon="el-icon-delete" @click="toDelete(row.id)">删除</el-button>
          </template>
        </el-table-column>
      </el-table>

    </div>
    <!-- 数据表格结束 -->
    <!-- 分页组件开始 -->
    <div class="pageable">
      <el-pagination
        :current-page="page.pageNumber"
        :page-sizes="[10, 20, 30, 50]"
        :page-size="10"
        background
        layout="total, sizes, prev, pager, next, jumper"
        :total="dataPage.totalCount"
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
      />
    </div>
    <!-- 分页组件结束 -->
    <!-- 添加弹窗 -->
    <el-dialog
      title="添加优惠券"
      :visible.sync="addDialog"
      width="40%"
    >
      <shop-coupon-add @after="getByPage" @close="closeDialog" />
    </el-dialog>
    <!-- 添加弹窗结束 -->
  </div>
</template>

<script>
import couponApi from '@/api/shop-coupon'
import shopCouponAdd from './shop-coupon-add'
export default {
  components: {
    shopCouponAdd
  },
  data() {
    return {
      // 分页对象
      page: {
        // 搜索参数
        params: {},
        // 当前页
        pageNumber: 1,
        // 每页条数
        pageSize: 10
      },
      // 数据分页对象
      dataPage: {},
      // 控制添加弹窗展示
      addDialog: false
    }
  },
  created() {
    this.getByPage()
  },
  methods: {
    // 搜索
    search() {
      this.page.pageNumber = 1
      this.getByPage()
    },
    // 分页查询
    getByPage() {
      couponApi.getByPage(this.page).then(res => {
        this.dataPage = res.data
      })
    },
    // 每页条数发生改变
    handleSizeChange(val) {
      this.page.pageSize = val
      this.getByPage()
    },
    // 当前页发生变化
    handleCurrentChange(val) {
      this.page.pageNumber = val
      this.getByPage()
    },
    // 添加
    toAdd() {
      this.addDialog = true
    },
    // 详情
    toInfo(id) {},
    // 下架
    toDown(id) {
      this.$confirm('下架后无法上架，是否继续?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        couponApi.down(id).then(res => {
          this.$message.success(res.msg)
          this.getByPage()
        })
      })
    },
    // 删除
    toDelete(id) {
      this.$confirm('是否删除该帮助?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'error'
      }).then(() => {
        couponApi.deleteById(id).then(res => {
          this.$message.success(res.msg)
          this.getByPage()
        })
      })
    },
    // 关闭所有弹窗
    closeDialog() {
      this.addDialog = false
    }
  }
}
</script>

<style>

</style>

```



##### coupon-add.vue

```vue
<template>
  <div>
    <el-form :model="shopCoupon" label-width="100px" size="small">
      <el-row :gutter="20">
        <el-col :span="12" :offset="0">
          <el-form-item label="优惠券名称">
            <el-input v-model="shopCoupon.name" clearable placeholder="请输入名称" />
          </el-form-item>
        </el-col>
        <el-col :span="12" :offset="0">
          <el-form-item label="面值">
            <el-input-number v-model="shopCoupon.amount" style="width: 100%" controls-position="right" clearable placeholder="请输入面值" />
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12" :offset="0">
          <el-form-item label="发行量">
            <el-input-number v-model="shopCoupon.publishCount" style="width: 100%" controls-position="right" clearable placeholder="请输入发行量" />
          </el-form-item>
        </el-col>
        <el-col :span="12" :offset="0">
          <el-form-item label="使用门槛">
            <el-input-number v-model="shopCoupon.minPoint" style="width: 100%" controls-position="right" clearable placeholder="请输入使用门槛" />
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="有效期">
            <el-date-picker
              v-model="timeRange"
              style="width: 100%"
              type="datetimerange"
              range-separator="至"
              start-placeholder="开始日期"
              value-format="yyyy-MM-dd HH:mm:ss"
              end-placeholder="结束日期"
            />
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="优惠券类型">
            <el-radio-group v-model="shopCoupon.couponType">
              <el-radio-button :label="0">全场通用</el-radio-button>
              <el-radio-button :label="1">指定分类</el-radio-button>
              <el-radio-button :label="2">指定商品</el-radio-button>
            </el-radio-group>
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <!-- 指定分类 -->
          <div v-show="shopCoupon.couponType === 1" class="select-category">
            <el-form-item>
              <el-form label-width="100px" :inline="true" size="small">
                <el-form-item label="选择分类">
                  <el-cascader
                    v-model="currentCategory"
                    clearable
                    filterable
                    placeholder="选择分类"
                    style="width: 100%"
                    :options="categoryList"
                    :props="{ expandTrigger: 'hover', value: 'id', label: 'name' }"
                  />
                </el-form-item>
                <el-form-item>
                  <el-button type="primary" @click="addCategory">添加</el-button>
                </el-form-item>
              </el-form>
              <el-table
                header-row-class-name="pochi-table-header"
                :data="shopCoupon.categoryList"
                stripe
                border
                style="width: 100%"
              >
                <el-table-column prop="name" label="分类名称" />
                <el-table-column label="操作">
                  <template slot-scope="{row}">
                    <el-button type="text" icon="el-icon-delete" @click="deleteCategory(row)">删除</el-button>
                  </template>
                </el-table-column>
              </el-table>
            </el-form-item>
          </div>
          <!-- 指定分类结束 -->
          <!-- 指定商品 -->
          <div v-show="shopCoupon.couponType === 2" class="select-product">
            <el-form label-width="100px" size="small">
              <el-form-item>
                <el-button type="primary" @click="selectProduct">选择商品</el-button>
              </el-form-item>
              <el-form-item>
                <el-table
                  header-row-class-name="pochi-table-header"
                  :data="shopCoupon.productList"
                  stripe
                  border
                  style="width: 100%"
                >
                  <el-table-column prop="name" label="名称" />
                  <el-table-column prop="price" label="价格" />
                  <el-table-column prop="stock" label="库存" />
                  <el-table-column prop="brandName" label="品牌" />
                  <el-table-column label="操作">
                    <template slot-scope="{row}">
                      <el-button type="text" icon="el-icon-delete" @click="deleteProduct(row.id)">删除</el-button>
                    </template>
                  </el-table-column>
                </el-table>
              </el-form-item>
            </el-form>

          </div>
          <!-- 指定商品结束 -->
        </el-col>
      </el-row>
      <el-form-item>
        <el-button type="primary" @click="add">添加</el-button>
      </el-form-item>
    </el-form>

    <!-- 商品选择弹窗 -->
    <el-dialog
      append-to-body
      title="选择商品"
      :visible.sync="selectDialog"
      width="70%"
    >
      <select-product :default-select="shopCoupon.productList" @selectSubmit="selectSubmit" />
    </el-dialog>

    <!-- 商品选择弹窗结束 -->
  </div>
</template>

<script>
import categoryApi from '@/api/shop-product-category'
import selectProduct from '@/components/SelectProduct'
import couponApi from '@/api/shop-coupon'
export default {
  components: {
    selectProduct
  },
  data() {
    return {
      // 表单对象
      shopCoupon: {
        // 分类集合
        categoryList: [],
        // 商品集合
        productList: []
      },
      // 有效期
      timeRange: [],
      // 分类列表
      categoryList: [],
      // 当前选择的分类
      currentCategory: {},
      // 商品选择弹窗
      selectDialog: false
    }
  },
  watch: {
    timeRange: {
      immediate: true,
      deep: true,
      handler: function(newVal) {
        if (newVal && newVal[0]) {
          this.shopCoupon.startTime = newVal[0]
          this.shopCoupon.endTime = newVal[1]
        } else {
          this.shopCoupon.startTime = null
          this.shopCoupon.endTime = null
        }
      }
    }
  },
  created() {
    this.getCategoryTree()
  },
  methods: {
    // 查询分类树
    getCategoryTree() {
      categoryApi.getTree().then(res => {
        this.categoryList = res.data
      })
    },
    // 提交选中商品触发
    selectSubmit(val) {
      this.selectDialog = false
      this.shopCoupon.productList = val
    },
    // 选择商品
    selectProduct() {
      this.selectDialog = true
    },
    // 添加
    add() {
      couponApi.save(this.shopCoupon).then(res => {
        this.$message.success(res.msg)
        this.$emit('after')
        this.$emit('close')
      })
    },
    // 删除选中的商品
    deleteProduct(id) {
      this.shopCoupon.productList.splice(
        this.shopCoupon.productList.findIndex(e => e.id === id),
        1
      )
    },
    // 添加分类
    addCategory() {
      const firstId = this.currentCategory[0]
      const secondId = this.currentCategory[1]
      const thirdId = this.currentCategory[2]
      // 根据第一个下标找到一级分类
      let name = ''
      this.categoryList.forEach(e => {
        if (e.id === firstId) {
          name += e.name
          // 获取子节点，根据第二个下标找到二级分类
          e.children.forEach(c1 => {
            if (c1.id === secondId) {
              name += ' > ' + c1.name
              // 获取子节点，根据第三个下标找到三级分类
              c1.children.forEach(c2 => {
                if (c2.id === thirdId) {
                  name += ' > ' + c2.name
                  c2.name = name
                  // 找到了
                  this.shopCoupon.categoryList.push(c2)
                  this.currentCategory = []
                  return
                }
              })
            }
          })
        }
      })
    },
    // 删除分类
    deleteCategory(row) {
      this.shopCoupon.categoryList.splice(
        this.shopCoupon.categoryList.findIndex(e => e.id === row.id),
        1
      )
    }
  }
}
</script>

<style>

</style>

```

到这里，我们的后台管理就暂时告一段落了，下面开始写小程序端。