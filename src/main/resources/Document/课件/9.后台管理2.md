到这里，我们的功能基本快开发完毕了。还剩余一部分后台管理的功能，我们快速结束。

# 1. 用户管理

## 1.1 后端

后端这里提供列表、详情、封禁、解封、删除、查询订单功能。后台一般不提供添加前台页面的功能。

其中查询订单功能我们在开发完订单管理再回来进行

### ShopUserController

```java
package com.jg.pochi.controller;

import com.jg.pochi.common.Page;
import com.jg.pochi.common.Result;
import com.jg.pochi.pojo.ShopUser;
import com.jg.pochi.pojo.vo.ShopUserVo;
import com.jg.pochi.service.ShopUserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

/**
 * @Author: 杨德石
 * @Date: 2021/1/24 17:32
 * @Version 1.0
 */
@RestController
@RequestMapping("/user")
public class ShopUserController {

    @Autowired
    private ShopUserService shopUserService;

    /**
     * 分页查询
     *
     * @param page
     * @return
     */
    @RequestMapping(value = "/getByPage", method = RequestMethod.POST)
    public Result<Page<ShopUser>> getByPage(@RequestBody Page<ShopUser> page) {
        page = shopUserService.getByPage(page);
        return new Result<>(page);
    }

    /**
     * 根据id查询
     *
     * @param id
     * @return
     */
    @RequestMapping(value = "/get/{id}", method = RequestMethod.GET)
    public Result<ShopUserVo> get(@PathVariable Long id) {
        ShopUserVo shopUserVo = shopUserService.get(id);
        return new Result<>(shopUserVo);
    }

    /**
     * 根据id删除
     *
     * @param id
     * @return
     */
    @RequestMapping(value = "/delete/{id}", method = RequestMethod.DELETE)
    public Result<?> delete(@PathVariable Long id) {
        shopUserService.delete(id);
        return new Result<>("删除成功");
    }

    /**
     * 解封
     *
     * @param id
     * @return
     */
    @RequestMapping(value = "/enableById/{id}", method = RequestMethod.PUT)
    public Result<?> enableById(@PathVariable Long id) {
        shopUserService.enableById(id);
        return new Result<>("操作成功");
    }

    /**
     * 封禁
     *
     * @param id
     * @return
     */
    @RequestMapping(value = "/disableById/{id}", method = RequestMethod.PUT)
    public Result<?> disableById(@PathVariable Long id) {
        shopUserService.disableById(id);
        return new Result<>("操作成功");
    }

}

```



### ShopUserService

```java
package com.jg.pochi.service;

import com.jg.pochi.common.Page;
import com.jg.pochi.pojo.ShopUser;
import com.jg.pochi.pojo.dto.ShopUserBindDto;
import com.jg.pochi.pojo.vo.ShopUserVo;

/**
 * @Author: 杨德石
 * @Date: 2020/12/12 17:08
 * @Version 1.0
 */
public interface ShopUserService {

    /**
     * 根据openid查询
     *
     * @param openId
     * @return
     */
    ShopUser getByOpenId(String openId);

    /**
     * 注册
     *
     * @param toShopUser
     */
    void register(ShopUser toShopUser);

    /**
     * 绑定用户
     *
     * @param shopUserBindDto
     * @return
     */
    ShopUser bindUser(ShopUserBindDto shopUserBindDto);

    /**
     * 分页查询
     *
     * @param page
     * @return
     */
    Page<ShopUser> getByPage(Page<ShopUser> page);

    /**
     * 根据id查询
     *
     * @param id
     * @return
     */
    ShopUserVo get(Long id);

    /**
     * 根据id删除
     *
     * @param id
     */
    void delete(Long id);

    /**
     * 解封
     *
     * @param id
     */
    void enableById(Long id);

    /**
     * 封禁
     *
     * @param id
     */
    void disableById(Long id);
}

```



### ShopUserServiceImpl

```java
package com.jg.pochi.service.impl;

import com.jg.pochi.common.Page;
import com.jg.pochi.enums.ResultEnums;
import com.jg.pochi.enums.StateEnums;
import com.jg.pochi.exception.PochiException;
import com.jg.pochi.mapper.ShopUserMapper;
import com.jg.pochi.mapper.ShopUserStatisticMapper;
import com.jg.pochi.pojo.ShopUser;
import com.jg.pochi.pojo.ShopUserStatistic;
import com.jg.pochi.pojo.dto.ShopUserBindDto;
import com.jg.pochi.pojo.vo.ShopUserVo;
import com.jg.pochi.service.ShopUserService;
import com.jg.pochi.shiro.LoginUser;
import com.jg.pochi.utils.IdWorker;
import com.jg.pochi.utils.ShiroUtils;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2020/12/12 17:09
 * @Version 1.0
 */
@Service
public class ShopUserServiceImpl implements ShopUserService {

    @Autowired
    private ShopUserMapper shopUserMapper;
    @Autowired
    private ShopUserStatisticMapper shopUserStatisticMapper;

    @Autowired
    private IdWorker idWorker;

    @Override
    public ShopUser getByOpenId(String openId) {
        return shopUserMapper.getByOpenId(openId);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void register(ShopUser shopUser) {
        // 用户入表
        long userId = idWorker.nextId();
        shopUser.setId(userId);
        shopUserMapper.save(shopUser);
        // 创建用户统计对象入表
        ShopUserStatistic statistic = new ShopUserStatistic();
        long statisticId = idWorker.nextId();
        statistic.setId(statisticId);
        statistic.setUserId(userId);
        shopUserStatisticMapper.save(statistic);
    }

    @Override
    public ShopUser bindUser(ShopUserBindDto shopUserBindDto) {
        Integer bindType = shopUserBindDto.getBindType();
        if (StateEnums.NEW_USER.getCode().equals(bindType)) {
            // 校验手机号是否存在
            ShopUser shopUser = shopUserMapper.getByPhone(shopUserBindDto.getPhone());
            if (shopUser != null) {
                throw new PochiException(ResultEnums.USER_REAL_EXISTS);
            }
            // 获取当前登录用户，获取到openid，根据openid查询用户，设置 手机号、密码
            LoginUser loginUser = ShiroUtils.getLoginUser();
            String openId = loginUser.getOpenId();
            shopUser = shopUserMapper.getByOpenId(openId);
            shopUser.setPhone(shopUserBindDto.getPhone());
            shopUser.setPassword(shopUserBindDto.getPassword());
            shopUserMapper.updateLoginInfo(shopUser);
            return shopUser;
        } else {
            LoginUser loginUser = ShiroUtils.getLoginUser();
            // 绑定现有账户
            // 查询现有账户，更新openid
            ShopUser shopUser = shopUserMapper.getByPhone(shopUserBindDto.getPhone());
            if (shopUser == null) {
                throw new PochiException(ResultEnums.USER_NOT_FOUND);
            }
            if (!shopUser.getPassword().equals(shopUserBindDto.getPassword())) {
                throw new PochiException("密码不正确");
            }
            shopUser.setOpenId(loginUser.getOpenId());
            shopUserMapper.updateLoginInfo(shopUser);
            // 删除当前登录用户ID对应的账号，这个账号是没有手机号的
            shopUserMapper.clearById(loginUser.getId());
            return shopUser;
        }
    }

    @Override
    public Page<ShopUser> getByPage(Page<ShopUser> page) {
        List<ShopUser> list = shopUserMapper.getByPage(page);
        Integer count = shopUserMapper.getCountByPage(page);
        page.setList(list);
        page.setTotalCount(count);
        return page;
    }

    @Override
    public ShopUserVo get(Long id) {
        ShopUser shopUser = shopUserMapper.get(id);
        ShopUserVo vo = new ShopUserVo();
        BeanUtils.copyProperties(shopUser, vo);
        // 查询统计信息
        ShopUserStatistic statistic = shopUserStatisticMapper.getByUserId(id);
        vo.setShopUserStatistic(statistic);
        return vo;
    }

    @Override
    public void delete(Long id) {
        shopUserMapper.delete(id);
    }

    @Override
    public void enableById(Long id) {
        shopUserMapper.enableById(id);
    }

    @Override
    public void disableById(Long id) {
        shopUserMapper.disableById(id);
    }
}

```



### ShopUserMapper

```java
package com.jg.pochi.mapper;

import com.jg.pochi.common.Page;
import com.jg.pochi.pojo.ShopUser;
import org.springframework.stereotype.Component;

import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2020/12/12 17:07
 * @Version 1.0
 */
@Component
public interface ShopUserMapper {

    /**
     * 根据openid查询
     * @param openId
     * @return
     */
    ShopUser getByOpenId(String openId);

    /**
     * 保存
     * @param shopUser
     */
    void save(ShopUser shopUser);

    /**
     * 更新登录信息（手机号、密码）
     * @param shopUser
     */
    void updateLoginInfo(ShopUser shopUser);

    /**
     * 根据手机号查询
     * @param phone
     * @return
     */
    ShopUser getByPhone(String phone);

    /**
     * 根据id，物理删除用户
     * @param id
     */
    void clearById(Long id);

    /**
     * 修改积分
     * @param user
     */
    void updatePoint(ShopUser user);

    /**
     * 分页查询
     * @param page
     * @return
     */
    List<ShopUser> getByPage(Page<ShopUser> page);

    /**
     * 查询总数
     * @param page
     * @return
     */
    Integer getCountByPage(Page<ShopUser> page);

    /**
     * 根据id查询
     * @param id
     * @return
     */
    ShopUser get(Long id);

    /**
     * 根据id删除
     * @param id
     */
    void delete(Long id);

    /**
     * 解封
     * @param id
     */
    void enableById(Long id);

    /**
     * 封禁
     * @param id
     */
    void disableById(Long id);
}

```



### ShopUserMapper.xml

```xml
    <select id="getByPage" resultMap="BaseResultMap">
        select id,
        phone,
        nickname,
        status,
        header,
        gender,
        note,
        point,
        history_point,
        create_time,
        update_time
        from shop_user
        where deleted = 0
        <if test="params.phone!=null and params.phone!=''">
            and phone = #{params.phone}
        </if>
        <if test="params.nickname!=null and params.nickname!=''">
            and nickname like concat('%', #{params.nickname}, '%')
        </if>
        <if test="params.status!=null">
            and status = #{params.status}
        </if>

        limit #{index}, #{pageSize}
    </select>
    <select id="getCountByPage" resultType="java.lang.Integer">
        select count(*)
        from shop_user
        where deleted = 0
        <if test="params.phone!=null and params.phone!=''">
            and phone = #{params.phone}
        </if>
        <if test="params.nickname!=null and params.nickname!=''">
            and nickname like concat('%', #{params.nickname}, '%')
        </if>
        <if test="params.status!=null">
            and status = #{params.status}
        </if>
    </select>
    <select id="get" resultMap="BaseResultMap">
        select id,
               phone,
               nickname,
               status,
               header,
               gender,
               note,
               openid,
               point,
               history_point,
               create_time,
               update_time
        from shop_user
        where id = #{id}
    </select>

    <update id="delete">
        update shop_user
        set deleted = 1
        where id = #{id}
    </update>
    <update id="enableById">
        update shop_user
        set status = 1
        where id = #{id}
    </update>
    <update id="disableById">
        update shop_user
        set status = 0
        where id = #{id}
    </update>
```



## 1.2 前端

### API

在 `api` 下创建 `shopUser.js` 文件，内容如下

```js
import request from '@/utils/request'
const groupName = 'user'
export default {
  /**
   * 分页
   */
  getByPage(page) {
    return request({
      url: `/${groupName}/getByPage`,
      method: 'post',
      data: page
    })
  },
  /**
   * 启用
   */
  enableById(id) {
    return request({
      url: `/${groupName}/enableById/${id}`,
      method: 'put'
    })
  },
  /**
   * 禁用
   */
  disableById(id) {
    return request({
      url: `/${groupName}/disableById/${id}`,
      method: 'put'
    })
  },
  /**
   * 删除
   */
  deleteById(id) {
    return request({
      url: `/${groupName}/delete/${id}`,
      method: 'delete'
    })
  },
  /**
   * 根据id查询
   */
  get(id) {
    return request({
      url: `/${groupName}/get/${id}`,
      method: 'get'
    })
  }
}

```

### 页面

在 `views` 下创建 `shop/user`，并分别创建 `shop-user-list、shop-user-info、shop-user-order` 文件 ，并配置路由。其中订单的组件我们后面再进行开发

#### shop-user-list

```vue
<template>
  <div>
    <!-- 搜索栏开始 -->
    <div class="search-form">
      <el-form :inline="true" :model="page.params" size="small">
        <el-form-item>
          <el-input v-model="page.params.phone" clearable placeholder="手机号" />
        </el-form-item>
        <el-form-item>
          <el-input v-model="page.params.nickname" clearable placeholder="昵称" />
        </el-form-item>
        <el-form-item>
          <el-select v-model="page.params.status" placeholder="状态" clearable>
            <el-option label="启用" :value="1" />
            <el-option label="禁用" :value="0" />
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" icon="el-icon-search" @click="search">查询</el-button>
          <el-button type="warning" icon="el-icon-refresh" @click="page.params = {}">重置</el-button>
        </el-form-item>
      </el-form>
    </div>
    <!-- 搜索栏结束 -->
    <!-- 数据表格开始 -->
    <el-table
      header-row-class-name="pochi-table-header"
      :data="dataPage.list"
      stripe
      style="width: 100%"
    >
      <el-table-column prop="phone" label="手机号" width="120px" />
      <el-table-column prop="nickname" label="昵称" />
      <el-table-column prop="header" label="头像" width="70px">
        <template slot-scope="{row}">
          <el-image
            style="width: 50px; height: 50px"
            :src="row.header"
            fit="fill"
            :preview-src-list="[row.header]"
          />
        </template>
      </el-table-column>
      <el-table-column prop="gender" label="性别" width="70px">
        <template slot-scope="{row}">
          {{ row.gender===1?'男':'女' }}
        </template>
      </el-table-column>
      <el-table-column prop="point" label="积分" width="120px" />
      <el-table-column prop="historyPoint" label="历史积分" width="120px" />
      <el-table-column prop="status" label="启用状态" width="100px">
        <template slot-scope="{row}">
          <el-switch
            v-model="row.status"
            :active-value="1"
            :inactive-value="0"
            @change="changeStatus(row)"
          />
        </template>
      </el-table-column>
      <el-table-column prop="createTime" label="创建时间" width="180px" />
      <el-table-column prop="updateTime" label="修改时间" width="180px" />
      <el-table-column prop="note" label="个性签名" />
      <el-table-column label="操作" width="170px">
        <template slot-scope="{row}">
          <el-button type="text" icon="el-icon-document" @click="toInfo(row.id)">详情</el-button>
          <el-dropdown class="handle-button">
            <span class="el-dropdown-link">
              操作<i class="el-icon-arrow-down el-icon--right" />
            </span>
            <el-dropdown-menu slot="dropdown">
              <el-dropdown-item>
                <el-button type="text" icon="el-icon-delete">删除</el-button>
              </el-dropdown-item>
            </el-dropdown-menu>
          </el-dropdown>
        </template>
      </el-table-column>
    </el-table>
    <!-- 数据表格结束 -->
    <!-- 分页组件开始 -->
    <div class="pageable">
      <el-pagination
        :current-page="page.pageNumber"
        :page-sizes="[10, 20, 30, 50]"
        :page-size="10"
        background
        layout="total, sizes, prev, pager, next, jumper"
        :total="dataPage.totalCount"
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
      />
    </div>
    <!-- 分页组件结束 -->
    <!-- 详情弹窗 -->
    <el-dialog
      title="用户详情"
      :visible.sync="infoDialog"
      width="45%"
    >
      <user-info :active-id="activeId" />
    </el-dialog>
    <!-- 详情弹窗结束 -->
  </div>
</template>

<script>
import userApi from '@/api/shop-user'
import UserInfo from './user-info'
export default {
  components: {
    UserInfo
  },
  data() {
    return {
      // 搜索分页对象
      page: {
        // 当前页
        pageNumber: 1,
        // 每页条数
        pageSize: 20,
        // 查询参数
        params: {}
      },
      // 数据分页对象
      dataPage: {},
      // 当前点击ID
      activeId: null,
      // 控制详情弹窗展示
      infoDialog: false
    }
  },
  created() {
    this.getByPage()
  },
  methods: {
    // 改变启用状态
    changeStatus(item) {
      const status = item.status
      if (status === 0) {
        // 禁用
        this.$confirm('是否禁用该用户，禁用后将无法登陆?', '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          userApi.disableById(item.id).then(res => {
            this.$message.success(res.msg)
            this.getByPage()
          })
        }).catch(() => {
          item.status = 1
        })
      } else {
        // 启用
        this.$confirm('是否启用该用户?', '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'success'
        }).then(() => {
          userApi.enableById(item.id).then(res => {
            this.$message.success(res.msg)
            this.getByPage()
          })
        }).catch(() => {
          item.status = 0
        })
      }
    },
    // 打开详情弹窗
    toInfo(id) {
      this.activeId = id
      this.infoDialog = true
    },
    // 当前页发生改变触发
    handleCurrentChange(val) {
      this.page.pageNumber = val
      this.getByPage()
    },
    // 每页条数发生改变
    handleSizeChange(val) {
      this.page.pageSize = val
      this.getByPage()
    },
    // 搜索
    search() {
      this.page.pageNumber = 1
      this.getByPage()
    },
    // 分页查询
    getByPage() {
      if (this.page.params.status === '') {
        this.page.params.status = null
      }
      userApi.getByPage(this.page).then(res => {
        this.dataPage = res.data
      })
    }
  }
}
</script>

<style>
</style>

```



#### shop-user-info

```vue
<template>
  <div>
    <el-form label-width="80px" size="small">
      <el-row class="image-container">
        <el-image :src="user.header" class="header-image" :preview-list="[user.header]" />
      </el-row>
      <el-row :gutter="20">
        <el-col :span="8" :offset="0">
          <el-form-item label="账号">
            {{ user.phone }}
          </el-form-item>
        </el-col>
        <el-col :span="8" :offset="0">
          <el-form-item label="性别">
            {{ user.gender===1?'男':'女' }}
          </el-form-item>
        </el-col>
        <el-col :span="8" :offset="0">
          <el-form-item label="昵称">
            {{ user.nickname }}
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12" :offset="0">
          <el-form-item label="启用状态">
            {{ user.status===1?'启用':'封禁' }}
          </el-form-item>
        </el-col>
        <el-col :span="12" :offset="0">
          <el-form-item label="创建时间">
            {{ user.createTime }}
          </el-form-item>
        </el-col>
      </el-row>
      <!-- 统计信息 -->
      <div class="statistic">
        <el-row>
          <el-col :span="6" :offset="0">
            <el-form-item>
              <div slot="label">积分</div>
              {{ user.point }}
            </el-form-item>
          </el-col>
          <el-col :span="6" :offset="0">
            <el-form-item>
              <div slot="label">累计积分</div>
              {{ user.historyPoint }}
            </el-form-item>
          </el-col>
          <el-col v-if="user.shopUserStatistic" :span="6" :offset="0">
            <el-form-item>
              <div slot="label">累计消费</div>
              {{ user.shopUserStatistic.consumeAmount }}
            </el-form-item>
          </el-col>
          <el-col v-if="user.shopUserStatistic" :span="6" :offset="0">
            <el-form-item>
              <div slot="label">订单数</div>
              {{ user.shopUserStatistic.orderCount }}
            </el-form-item>
          </el-col>
        </el-row>
        <el-row v-if="user.shopUserStatistic">
          <el-col :span="6" :offset="0">
            <el-form-item>
              <div slot="label">优惠券数</div>
              {{ user.shopUserStatistic.couponCount }}
            </el-form-item>
          </el-col>
          <el-col :span="6" :offset="0">
            <el-form-item>
              <div slot="label">评价数</div>
              {{ user.shopUserStatistic.commentCount }}
            </el-form-item>
          </el-col>
          <el-col :span="6" :offset="0">
            <el-form-item>
              <div slot="label">退货次数</div>
              {{ user.shopUserStatistic.returnOrderCount }}
            </el-form-item>
          </el-col>
          <el-col :span="6" :offset="0">
            <el-form-item>
              <div slot="label">登录次数</div>
              {{ user.shopUserStatistic.loginCount }}
            </el-form-item>
          </el-col>
        </el-row>

      </div>
      <!-- 统计信息结束 -->
    </el-form>
  </div>
</template>

<script>
import userApi from '@/api/shop-user'
export default {
  props: {
    activeId: {
      type: String,
      default: null
    }
  },
  data() {
    return {
      // 用户对象
      user: {}
    }
  },
  watch: {
    activeId: {
      immediate: true,
      handler: function() {
        this.getById()
      }
    }
  },
  methods: {
    // 根据ID查询
    getById() {
      userApi.get(this.activeId).then((res) => {
        this.$nextTick(() => {
          this.user = res.data
        })
      })
    }
  }
}
</script>

<style scoped>
.image-container {
  text-align: center;
}
.header-image {
  width: 100px;
  height: 100px;
  margin-bottom: 20px;
}

.statistic >>> .el-row {
  border-top: 1px solid #dcdfe6;
  border-bottom: 1px solid #dcdfe6;
  border-right: 1px solid #dcdfe6;
  margin-bottom: -1px;
}

.statistic >>> .el-col {
  border-left: 1px solid #dcdfe6;
}

.statistic >>> .el-form-item__label {
  border-right: 1px solid #dcdfe6;
  text-align: center;
  background-color: #f2f6fc;
}

.statistic >>> .el-form-item {
  line-height: 45px;
  margin-bottom: 0px;
}

.statistic >>> .el-form-item__content {
  text-align: center;
}

</style>

```



# 2. 优惠券管理

## 2.1 优惠券详情

前面我们遗留了优惠券详情页，现在我们开始开发详情页。

详情页除了展示优惠券的基本信息外，还需要展示优惠券的领取详情。

### 2.1.1 后端

#### ShopCouponController

```java
    /**
     * 根据id查询
     *
     * @param id
     * @return
     */
    @RequestMapping(value = "/get/{id}", method = RequestMethod.GET)
    public Result<ShopCoupon> get(@PathVariable Long id) {
        ShopCoupon coupon = shopCouponService.get(id);
        return new Result<>(coupon);
    }

    /**
     * 查询优惠券领取记录
     *
     * @param id
     * @return
     */
    @RequestMapping(value = "/getHistoryList/{id}", method = RequestMethod.GET)
    public Result<List<ShopCouponHistory>> getHistoryList(@PathVariable Long id) {
        List<ShopCouponHistory> list = shopCouponService.getHistoryList(id);
        return new Result<>(list);
    }
```

#### ShopCouponService

```java
    /**
     * 根据id查询
     *
     * @param id
     * @return
     */
    ShopCoupon get(Long id);

    /**
     * 查询优惠券领取记录
     *
     * @param id
     * @return
     */
    List<ShopCouponHistory> getHistoryList(Long id);
```



#### ShopCouponServiceImpl

```java
    @Override
    public ShopCoupon get(Long id) {
        return shopCouponMapper.get(id);
    }

    @Override
    public List<ShopCouponHistory> getHistoryList(Long id) {
        return shopCouponHistoryMapper.getByCouponId(id);
    }
```



#### ShopCouponMapper

```java
    /**
     * 查询优惠券
     * @param couponId
     * @return
     */
    ShopCoupon get(Long couponId);

```



#### ShopCouponMapper.xml

```xml
    <select id="get" resultMap="BaseResultMap">
        select id,
               coupon_type,
               name,
               amount,
               min_point,
               start_time,
               end_time,
               rest_count,
               publish_count,
               use_count,
               receive_count,
               status
        from shop_coupon
        where id = #{id}
    </select>
```

#### ShopCouponHistoryMapper

```java
    /**
     * 根据优惠券ID查询
     * @param id
     * @return
     */
    List<ShopCouponHistory> getByCouponId(Long id);
```



#### ShopCouponHistoryMapper.xml

```xml
    <select id="getByCouponId" resultMap="BaseResultMap">
        select id,
               coupon_id,
               create_by,
               use_status,
               use_time,
               order_id,
               amount,
               min_point,
               create_time
        from shop_coupon_history
        where coupon_id = #{couponId}
    </select>
```



### 2.1.2 前端

#### API

```js
  /**
   * 根据id查询
   * @param {*} id
   */
  get(id) {
    return request({
      url: `/${groupName}/get/${id}`,
      method: 'get'
    })
  },
  /**
   * 根据id查询使用记录
   * @param {*} id
   */
  getHistoryList(id) {
    return request({
      url: `/${groupName}/getHistoryList/${id}`,
      method: 'get'
    })
  },
```

#### 页面编写

回到我们的 `coupon-info.vue`，内容如下

```vue
<template>
  <div>
    <el-form>
      <div class="statistic">
        <el-row>
          <el-col :span="5" :offset="0">
            <el-form-item>
              <div slot="label">名称</div>
              {{ coupon.name }}
            </el-form-item>
          </el-col>
          <el-col :span="5" :offset="0">
            <el-form-item>
              <div slot="label">使用类型</div>
              <span v-if="coupon.couponType === 0">全场通用</span>
              <span v-if="coupon.couponType === 1">指定分类</span>
              <span v-if="coupon.couponType === 2">指定商品</span>
            </el-form-item>
          </el-col>
          <el-col :span="5" :offset="0">
            <el-form-item>
              <div slot="label">使用门槛</div>
              {{ coupon.minPoint }}
            </el-form-item>
          </el-col>
          <el-col :span="5" :offset="0">
            <el-form-item>
              <div slot="label">面值</div>
              {{ coupon.amount }}
            </el-form-item>
          </el-col>
          <el-col :span="4" :offset="0">
            <el-form-item>
              <div slot="label">状态</div>
              {{ coupon.status===1?'正常':'过期' }}
            </el-form-item>
          </el-col>
        </el-row>
        <el-row>
          <el-col :span="5" :offset="0">
            <el-form-item>
              <div slot="label">有效期</div>
              {{ coupon.startTime }} 至 {{ coupon.endTime }}
            </el-form-item>
          </el-col>
          <el-col :span="5" :offset="0">
            <el-form-item>
              <div slot="label">发行数</div>
              {{ coupon.publishCount }}
            </el-form-item>
          </el-col>
          <el-col :span="5" :offset="0">
            <el-form-item>
              <div slot="label">已领取</div>
              {{ coupon.receiveCount }}
            </el-form-item>
          </el-col>
          <el-col :span="5" :offset="0">
            <el-form-item>
              <div slot="label">已使用</div>
              {{ coupon.useCount }}
            </el-form-item>
          </el-col>
          <el-col :span="4" :offset="0">
            <el-form-item>
              <div slot="label">剩余数</div>
              {{ coupon.restCount }}
            </el-form-item>
          </el-col>
        </el-row>
      </div>
    </el-form>
    <!-- 领取历史 -->
    <el-card class="history-card" shadow="never" :body-style="{ padding: '20px' }">
      <div slot="header">
        <span>领取历史</span>
      </div>
      <div class="history-table">
        <el-table header-row-class-name="pochi-table-header" :data="historyList" stripe>
          <el-table-column prop="id" label="编号" />
          <el-table-column prop="createBy" label="领取人" />
          <el-table-column prop="useStatus" label="使用状态">
            <template slot-scope="{row}">
              <el-tag v-if="row.useStatus === 0">未使用</el-tag>
              <el-tag v-if="row.useStatus === 1" type="success">已使用</el-tag>
              <el-tag v-if="row.useStatus === 2" type="info">已过期</el-tag>
            </template>
          </el-table-column>
          <el-table-column prop="amount" label="面值" />
          <el-table-column prop="minPoint" label="使用门槛" />
          <el-table-column prop="useTime" label="使用时间" />
          <el-table-column prop="orderId" label="订单ID" />
          <el-table-column prop="createTime" label="领取时间" />
        </el-table>
      </div>
    </el-card>
  </div>
</template>

<script>
import couponApi from '@/api/shop-coupon'
export default {
  props: {
    activeId: {
      type: String,
      default: null
    }
  },
  data() {
    return {
      // 优惠券对象
      coupon: {},
      // 优惠券领取记录数组
      historyList: []
    }
  },
  watch: {
    activeId: {
      immediate: true,
      handler: function() {
        this.getById()
        this.getHistoryList()
      }
    }
  },
  methods: {
    // 查询详情
    getById() {
      couponApi.get(this.activeId).then((res) => {
        this.coupon = res.data
      })
    },
    // 查询优惠券领取记录
    getHistoryList() {
      couponApi.getHistoryList(this.activeId).then((res) => {
        this.historyList = res.data
      })
    }
  }
}
</script>

<style scoped>
.statistic >>> .el-row {
  border-top: 1px solid #dcdfe6;
  border-bottom: 1px solid #dcdfe6;
  border-right: 1px solid #dcdfe6;
  margin-bottom: -1px;
}

.statistic >>> .el-col {
  border-left: 1px solid #dcdfe6;
}

.statistic >>> .el-form-item__label {
  border-right: 1px solid #dcdfe6;
  text-align: center;
  width: 100%;
  background-color: #f2f6fc;
}

.statistic >>> .el-form-item {
  line-height: 45px;
  margin-bottom: 0px;
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-right: -1px;
}

.statistic >>> .el-form-item__content {
  text-align: center;
}

.history-card {
  margin-top: 20px;
}
</style>

```



# 3. 订单管理

## 3.1 支付订单

支付订单直接列表展示订单即可，此外，还需要一个较为详细的详情页。

### 3.1.1 后端

#### ShopOrderPayController

```java
package com.jg.pochi.controller;

import com.jg.pochi.common.Page;
import com.jg.pochi.common.Result;
import com.jg.pochi.pojo.ShopOrderPay;
import com.jg.pochi.service.ShopOrderPayService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

/**
 * @Author: 杨德石
 * @Date: 2021/1/25 21:19
 * @Version 1.0
 */
@RestController
@RequestMapping("/orderPay")
public class ShopOrderPayController {

    @Autowired
    private ShopOrderPayService shopOrderPayService;

    /**
     * 分页查询
     *
     * @param page
     * @return
     */
    @RequestMapping(value = "/getByPage", method = RequestMethod.POST)
    public Result<Page<ShopOrderPay>> getByPage(@RequestBody Page<ShopOrderPay> page) {
        page = shopOrderPayService.getByPage(page);
        return new Result<>(page);
    }

    /**
     * 查询详情
     *
     * @param id
     * @return
     */
    @RequestMapping(value = "/get/{id}", method = RequestMethod.GET)
    public Result<ShopOrderPay> get(@PathVariable Long id) {
        ShopOrderPay pay = shopOrderPayService.get(id);
        return new Result<>(pay);
    }

}

```



#### ShopOrderPayService

```java
package com.jg.pochi.service;

import com.jg.pochi.common.Page;
import com.jg.pochi.pojo.ShopOrderPay;

/**
 * @Author: 杨德石
 * @Date: 2021/1/19 23:51
 * @Version 1.0
 */
public interface ShopOrderPayService {
    /**
     * 分页查询
     *
     * @param page
     * @return
     */
    Page<ShopOrderPay> getByPage(Page<ShopOrderPay> page);

    /**
     * 根据id查询
     * @param id
     * @return
     */
    ShopOrderPay get(Long id);
}

```



#### ShopOrderPayServiceImpl

```java
package com.jg.pochi.service.impl;

import com.jg.pochi.common.Page;
import com.jg.pochi.mapper.ShopOrderPayMapper;
import com.jg.pochi.pojo.ShopOrderPay;
import com.jg.pochi.service.ShopOrderPayService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2021/1/19 23:51
 * @Version 1.0
 */
@Service
public class ShopOrderPayServiceImpl implements ShopOrderPayService {

    @Autowired
    private ShopOrderPayMapper shopOrderPayMapper;

    @Override
    public Page<ShopOrderPay> getByPage(Page<ShopOrderPay> page) {
        List<ShopOrderPay> list = shopOrderPayMapper.getByPage(page);
        Integer count = shopOrderPayMapper.getCountByPage(page);
        page.setList(list);
        page.setTotalCount(count);
        return page;
    }

    @Override
    public ShopOrderPay get(Long id) {
        return shopOrderPayMapper.get(id);
    }
}

```



#### ShopOrderPayMapper

```java
    /**
     * 分页查询
     *
     * @param page
     * @return
     */
    List<ShopOrderPay> getByPage(Page<ShopOrderPay> page);

    /**
     * 查询总数
     * @param page
     * @return
     */
    Integer getCountByPage(Page<ShopOrderPay> page);

    /**
     * 根据id查询
     * @param id
     * @return
     */
    ShopOrderPay get(Long id);
```



#### ShopOrderPayMapper.xml

```xml
    <select id="getByPage" resultMap="BaseResultMap">
        select id,
        create_by,
        wx_order_no,
        out_trade_no,
        order_id,
        pay_amount,
        create_time,
        status,
        update_time
        from shop_order_pay
        where deleted = 0
        <if test="params.createBy!=null and params.createBy!=''">
            and create_by = #{params.createBy}
        </if>
        <if test="params.wxOrderNo!=null and params.wxOrderNo!=''">
            and wx_order_no = #{params.wxOrderNo}
        </if>
        <if test="params.outTradeNo!=null and params.outTradeNo!=''">
            and out_trade_no = #{params.outTradeNo}
        </if>
        <if test="params.orderId!=null and params.orderId!=''">
            and order_id = #{params.orderId}
        </if>
        <if test="params.status!=null">
            and status = #{params.status}
        </if>
        order by create_time desc
        limit #{index}, #{pageSize}
    </select>
    <select id="getCountByPage" resultType="java.lang.Integer">
        select count(*)
        from shop_order_pay
        where deleted = 0
        <if test="params.createBy!=null and params.createBy!=''">
            and create_by = #{params.createBy}
        </if>
        <if test="params.wxOrderNo!=null and params.wxOrderNo!=''">
            and wx_order_no = #{params.wxOrderNo}
        </if>
        <if test="params.outTradeNo!=null and params.outTradeNo!=''">
            and out_trade_no = #{params.outTradeNo}
        </if>
        <if test="params.orderId!=null and params.orderId!=''">
            and order_id = #{params.orderId}
        </if>
        <if test="params.status!=null">
            and status = #{params.status}
        </if>
    </select>
    <select id="get" resultMap="BaseResultMap">
        select id,
               create_by,
               wx_order_no,
               out_trade_no,
               order_id,
               order_param,
               pay_amount,
               create_time,
               status,
               update_time
        from shop_order_pay
        where id = #{id}
    </select>
```



### 3.1.2 前端

#### API

```js
import request from '@/utils/request'
const groupName = 'orderPay'
export default {
  /**
   * 分页查询
   * @param {分页查询} page
   */
  getByPage(page) { // 分页查询
    return request({
      url: `/${groupName}/getByPage`,
      method: 'post',
      data: page
    })
  },
  /**
   * 查询回显数据
   * @param {*} id
   */
  get(id) {
    return request({
      url: `/${groupName}/get/${id}`,
      method: 'get'
    })
  }
}

```

#### 页面

##### 列表页

```vue
<template>
  <div>
    <!-- 搜索表单 -->
    <div class="search-form">
      <el-form :model="page.params" :inline="true" size="small">
        <el-form-item>
          <el-input v-model="page.params.createBy" clearable placeholder="手机号" />
        </el-form-item>
        <el-form-item>
          <el-input v-model="page.params.wxOrderNo" clearable placeholder="微信订单号" />
        </el-form-item>
        <el-form-item>
          <el-input v-model="page.params.outTradeNo" clearable placeholder="外部订单号" />
        </el-form-item>
        <el-form-item>
          <el-input v-model="page.params.orderId" clearable placeholder="商品订单号" />
        </el-form-item>
        <el-form-item>
          <el-select v-model="page.params.status" placeholder="订单状态" clearable>
            <el-option label="支付中" :value="0" />
            <el-option label="支付成功" :value="1" />
            <el-option label="支付失败" :value="-1" />
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" icon="el-icon-search" @click="search">查询</el-button>
          <el-button type="warning" icon="el-icon-refresh" @click="page.params = {}">重置</el-button>
        </el-form-item>
      </el-form>
    </div>
    <!-- 搜索表单结束 -->
    <!-- 数据表格 -->
    <div class="data-table">
      <el-table
        header-row-class-name="pochi-table-header"
        :data="dataPage.list"
        stripe
        style="width: 100%"
      >
        <el-table-column prop="outTradeNo" label="外部订单号" />
        <el-table-column prop="wxOrderNo" label="微信订单号" />
        <el-table-column prop="orderId" label="商品订单号" />
        <el-table-column prop="payAmount" label="支付金额" />
        <el-table-column prop="createTime" label="创建时间" />
        <el-table-column prop="createBy" label="手机号" />
        <el-table-column prop="status" label="支付状态">
          <template slot-scope="{row}">
            <el-tag v-if="row.status === 0">支付中</el-tag>
            <el-tag v-else-if="row.status === 1" type="success">支付成功</el-tag>
            <el-tag v-else type="danger">支付失败</el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="updateTime" label="状态更新时间" />
        <el-table-column label="操作" width="170px">
          <template slot-scope="{row}">
            <el-button type="text" icon="el-icon-document" @click="toInfo(row.id)">详情</el-button>
            <el-dropdown class="handle-button">
              <span class="el-dropdown-link">
                操作<i class="el-icon-arrow-down el-icon--right" />
              </span>
              <el-dropdown-menu slot="dropdown">
                <el-dropdown-item>
                  <el-button type="text" icon="el-icon-delete">删除</el-button>
                </el-dropdown-item>
              </el-dropdown-menu>
            </el-dropdown>
          </template>
        </el-table-column>
      </el-table>
    </div>
    <!-- 数据表格结束 -->
    <!-- 分页组件开始 -->
    <div class="pageable">
      <el-pagination
        :current-page="page.pageNumber"
        :page-sizes="[10, 20, 30, 50]"
        :page-size="10"
        background
        layout="total, sizes, prev, pager, next, jumper"
        :total="dataPage.totalCount"
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
      />
    </div>
    <!-- 分页组件结束 -->
    <!-- 详情弹窗 -->
    <el-dialog
      title="订单详情"
      :visible.sync="infoDialog"
      width="30%"
    >
      <pay-info :active-id="activeId" />
    </el-dialog>

    <!-- 详情弹窗结束 -->
  </div>
</template>

<script>
import payApi from '@/api/shop-order-pay'
import payInfo from './pay-info'
export default {
  components: {
    payInfo
  },
  data() {
    return {
      // 分页查询对象
      page: {
        // 当前页
        pageNumber: 1,
        // 每页条数
        pageSize: 10,
        // 参数
        params: {}
      },
      // 数据分页对象
      dataPage: {},
      // 控制详情弹窗展示
      infoDialog: false,
      // 当前点击的ID
      activeId: null
    }
  },
  created() {
    this.getByPage()
  },
  methods: {
    // 详情
    toInfo(id) {
      this.infoDialog = true
      this.activeId = id
    },
    // 分页查询
    getByPage() {
      payApi.getByPage(this.page).then((res) => {
        this.dataPage = res.data
      })
    },
    // 搜索
    search() {
      this.page.pageNumber = 1
      this.getByPage()
    },
    // 当前页发生改变
    handleCurrentChange(val) {
      this.page.pageNumber = val
      this.getByPage()
    },
    // 每页条数发生改变
    handleSizeChaneg(val) {
      this.page.pageSize = val
      this.getByPage()
    }
  }
}
</script>

<style>
</style>

```



##### 详情页

```vue
<template>
  <div>
    <el-form label-width="100px">
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="微信订单号">
            {{ order.wxOrderNo }}
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="外部订单号">
            {{ order.outTradeNo }}
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="商品订单号">
            {{ order.orderId }}
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12" :offset="0">
          <el-form-item label="手机号">
            {{ order.createBy }}
          </el-form-item>
        </el-col>
        <el-col :span="12" :offset="0">
          <el-form-item label="状态">
            <el-tag v-if="order.status === 0">支付中</el-tag>
            <el-tag v-else-if="order.status === 1" type="success">支付成功</el-tag>
            <el-tag v-else type="danger">支付失败</el-tag>
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12" :offset="0">
          <el-form-item label="创建时间">
            {{ order.createTime }}
          </el-form-item>
        </el-col>
        <el-col :span="12" :offset="0">
          <el-form-item label="更新时间">
            {{ order.updateTime }}
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="订单参数">
            {{ order.orderParam }}
          </el-form-item>
        </el-col>
      </el-row>
    </el-form>
  </div>
</template>

<script>
import payApi from '@/api/shop-order-pay'
export default {
  props: {
    activeId: {
      type: String,
      default: null
    }
  },
  data() {
    return {
      // 订单
      order: {}
    }
  },
  watch: {
    activeId: {
      immediate: true,
      handler: function() {
        this.getById()
      }
    }
  },
  methods: {
    // 查询详情
    getById() {
      payApi.get(this.activeId).then(res => {
        this.order = res.data
      })
    }
  }
}
</script>

<style>

</style>

```



## 3.2 订单管理

订单管理是对商品订单的分页查询、详情查询、状态变更

### 后端

#### ShopOrderController

````java
    /**
     * 查询订单历史
     *
     * @param id
     * @return
     */
    @RequestMapping(value = "/getHistory/{id}", method = RequestMethod.GET)
    public Result<List<ShopOrderHistory>> getHistory(@PathVariable Long id) {
        List<ShopOrderHistory> list = shopOrderService.getHistory(id);
        return new Result<>(list);
    }
    /**
     * 改变订单状态
     *
     * @param order
     * @return
     */
    @RequestMapping(value = "/changeOrderStatus", method = RequestMethod.PUT)
    public Result<?> changeOrderStatus(@RequestBody ShopOrder order) {
        shopOrderService.changeOrderStatus(order);
        return new Result<>("操作成功");
    }

````



#### ShopOrderServicer

```java
    /**
     * 改变订单状态
     * @param order
     */
    void changeOrderStatus(ShopOrder order);

    /**
     * 查询订单历史
     * @param id
     * @return
     */
    List<ShopOrderHistory> getHistory(Long id);
```



#### ShopOrderServiceImpl

```java
    @Override
    public void changeOrderStatus(ShopOrder order) {
        shopOrderMapper.updateOrderStatus(order);
    }

    @Override
    public List<ShopOrderHistory> getHistory(Long id) {
        return shopOrderHistoryMapper.getHistory(id);
    }
```



#### ShopOrderMapper

```java
    /**
     * 修改订单状态
     * @param order
     */
    void updateOrderStatus(ShopOrder order);
```



#### ShopOrderMapper.xml

```xml
    <update id="updateOrderStatus">
        update shop_order
        set status = #{status}
        where id = #{id}
    </update>
```



#### ShopOrderHistoryMapper

```java
    /**
     * 查询订单历史
     * @param id
     * @return
     */
    List<ShopOrderHistory> getHistory(Long id);
```

#### ShopOrderHistoryMapper.xml

```xml
    <select id="getHistory" resultMap="BaseResultMap">
        select id,
               order_id,
               operate_man,
               order_status,
               note,
               create_time
        from shop_order_history
        where order_id = #{orderId}
    </select>
```



#### ShopOrderPayController

```java
    /**
     * 根据商品订单ID查询
     *
     * @param id
     * @return
     */
    @RequestMapping(value = "/getByOrderId/{id}", method = RequestMethod.GET)
    public Result<ShopOrderPay> getByOrderId(@PathVariable Long id) {
        ShopOrderPay pay = shopOrderPayService.getByOrderId(id);
        return new Result<>(pay);
    }
```



#### ShopOrderPayService

```java
    /**
     * 根据商品订单ID查询
     * @param id
     * @return
     */
    ShopOrderPay getByOrderId(Long id);
```



#### ShopOrderPayServiceImpl

```java
    @Override
    public ShopOrderPay getByOrderId(Long id) {
        return shopOrderPayMapper.getByOrderId(id);
    }
```



#### ShopOrderPayMapper

```java
    /**
     * 根据商品订单ID查询
     * @param id
     * @return
     */
    ShopOrderPay getByOrderId(Long id);
```



#### ShopOrderPayMapper.xml

```xml
    <select id="getByOrderId" resultMap="BaseResultMap">
        select id,
               create_by,
               wx_order_no,
               out_trade_no,
               order_id,
               pay_amount,
               create_time,
               status,
               update_time
        from shop_order_pay
        where order_id = #{orderId}
        order by create_time desc
        limit 1
    </select>
```



### 前端

#### API

```js
  /**
   * 查询历史数据
   * @param {*} id
   */
  getHistory(id) {
    return request({
      url: `/${groupName}/getHistory/${id}`,
      method: 'get'
    })
  },
  /**
   * 改变订单状态
   */
  changeOrderStatus(order) {
    return request({
      url: `/${groupName}/changeOrderStatus`,
      method: 'put',
      data: order
    })
  }
```

#### 列表页

```vue
<template>
  <div>
    <!-- 搜索表单 -->
    <div class="search-form">
      <el-form :model="page.params" :inline="true" size="small">
        <el-form-item>
          <el-input v-model="page.params.createBy" clearable placeholder="手机号" />
        </el-form-item>
        <el-form-item>
          <el-input v-model="page.params.id" clearable placeholder="订单号" />
        </el-form-item>
        <el-form-item>
          <el-select v-model="page.params.status" placeholder="订单状态" clearable>
            <el-option label="待付款" :value="0" />
            <el-option label="待确认" :value="1" />
            <el-option label="待发货" :value="2" />
            <el-option label="待签收" :value="3" />
            <el-option label="待评价" :value="4" />
            <el-option label="已完成" :value="5" />
            <el-option label="无效订单" :value="6" />
            <el-option label="已关闭" :value="7" />
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" icon="el-icon-search" @click="search">查询</el-button>
          <el-button type="warning" icon="el-icon-refresh" @click="page.params = {}">重置</el-button>
        </el-form-item>
      </el-form>
    </div>
    <!-- 搜索表单结束 -->
    <!-- 数据表格 -->
    <div class="data-table">
      <el-table
        header-row-class-name="pochi-table-header"
        :data="dataPage.list"
        stripe
        style="width: 100%"
      >
        <el-table-column prop="id" label="订单号" />
        <el-table-column prop="createBy" label="下单账号" />
        <el-table-column prop="totalAmount" label="总金额" />
        <el-table-column prop="payAmount" label="应付金额" />
        <el-table-column prop="couponAmount" label="优惠券抵扣" />
        <el-table-column prop="status" label="订单状态">
          <template slot-scope="{row}">
            <!-- 订单状态：0待付款；1待确认；2待发货；3已发货（待签收）；4已签收（待评价）；5已完成；6无效订单，7已关闭' -->
            <el-tag v-if="row.status === 0">待付款</el-tag>
            <el-tag v-else-if="row.status === 1">待确认</el-tag>
            <el-tag v-else-if="row.status === 2">待发货</el-tag>
            <el-tag v-else-if="row.status === 3">待签收</el-tag>
            <el-tag v-else-if="row.status === 4">待评价</el-tag>
            <el-tag v-else-if="row.status === 5" type="success">已完成</el-tag>
            <el-tag v-else-if="row.status === 6" type="info">无效订单</el-tag>
            <el-tag v-else-if="row.status === 7" type="info">已关闭</el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="intgration" label="积分" />
        <el-table-column prop="confirmStatus" label="确认收货状态">
          <template slot-scope="{row}">
            <el-tag v-if="row.confirmStatus === 0" type="info">未收货</el-tag>
            <el-tag v-else>已收货</el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="paymentTime" label="支付时间" />
        <el-table-column prop="deliveryTime" label="发货时间" />
        <el-table-column prop="commentTime" label="评价时间" />
        <el-table-column prop="createTime" label="下单时间" />
        <el-table-column label="操作" width="170px">
          <template slot-scope="{row}">
            <el-button type="text" icon="el-icon-document" @click="toInfo(row.id)">详情</el-button>
            <el-dropdown class="handle-button">
              <span class="el-dropdown-link">
                操作<i class="el-icon-arrow-down el-icon--right" />
              </span>
              <el-dropdown-menu slot="dropdown">
                <el-dropdown-item>
                  <el-button type="text" icon="el-icon-delete">删除</el-button>
                </el-dropdown-item>
                <el-dropdown-item>
                  <el-button v-if="row.status === 2" type="text" icon="el-icon-delete" @click="sendProduct(row)">发货</el-button>
                </el-dropdown-item>
                <el-dropdown-item>
                  <el-button v-if="row.status === 0" type="text" icon="el-icon-delete" @click="closeOrder(row.id)">关闭</el-button>
                </el-dropdown-item>
              </el-dropdown-menu>
            </el-dropdown>
          </template>
        </el-table-column>
      </el-table>
    </div>
    <!-- 数据表格结束 -->
    <!-- 分页组件开始 -->
    <div class="pageable">
      <el-pagination
        :current-page="page.pageNumber"
        :page-sizes="[10, 20, 30, 50]"
        :page-size="10"
        background
        layout="total, sizes, prev, pager, next, jumper"
        :total="dataPage.totalCount"
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
      />
    </div>
    <!-- 分页组件结束 -->
  </div>
</template>

<script>
import orderApi from '@/api/shop-order'
export default {
  data() {
    return {
      // 分页对象
      page: {
        // 当前页
        pageNumber: 1,
        // 每页条数
        pageSize: 10,
        // 查询参数
        params: {}
      },
      // 数据分页对象
      dataPage: {}
    }
  },
  created() {
    this.getByPage()
  },
  methods: {
    // 详情
    toInfo(id) {
      this.$router.push('/order/orderInfo/' + id)
    },
    // 发货
    sendProduct(row) {
      this.$confirm(`
      <p>是否确认发货？操作后无法取消</p>
      <p>收货人：<span style="color: red">${row.receiverName} - ${row.receiverPhone}</span></p>
      <p>收货地址：${row.receiverProvince}${row.receiverCity}${row.receiverRegion}${row.receiverDetailAddress}</p>
      `, '提示', {
        dangerouslyUseHTMLString: true,
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'success'
      }).then(() => {
        orderApi.changeOrderStatus({ id: row.id, status: 3 }).then(res => {
          this.$message.success(res.msg)
          this.getByPage()
        })
      })
    },
    // 关闭订单
    closeOrder(id) {
      this.$confirm('关闭订单后无法重新开启，是否继续?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'error'
      }).then(() => {
        orderApi.changeOrderStatus({ id: id, status: 7 }).then(res => {
          this.$message.success(res.msg)
          this.getByPage()
        })
      })
    },
    // 分页查询
    getByPage() {
      orderApi.getByPage(this.page).then((res) => {
        this.dataPage = res.data
      })
    },
    // 搜索
    search() {
      this.page.pageNumber = 1
      this.getByPage()
    },
    // 当前页发生改变
    handleCurrentChange(val) {
      this.page.pageNumber = val
      this.getByPage()
    },
    // 每页条数发生改变
    handleSizeChange(val) {
      this.page.pageSize = val
      this.getByPage()
    }
  }
}
</script>

<style>
</style>

```

#### 详情页

````vue
<template>
  <div>
    <!-- 订单步骤 -->
    <div class="order-step">
      <el-steps :active="currentStep" finish-status="success" align-center>
        <el-step v-for="(item, index) in stepList" :key="index" :title="item.name" :description="item.time" />
      </el-steps>
    </div>
    <!-- 详情卡片 -->
    <el-card shadow="never">
      <div slot="header">
        <span>
          当前订单状态：
          <el-tag v-if="order.status === 0">待付款</el-tag>
          <el-tag v-else-if="order.status === 1">待确认</el-tag>
          <el-tag v-else-if="order.status === 2">待发货</el-tag>
          <el-tag v-else-if="order.status === 3">待签收</el-tag>
          <el-tag v-else-if="order.status === 4">待评价</el-tag>
          <el-tag v-else-if="order.status === 5" type="success">已完成</el-tag>
          <el-tag v-else-if="order.status === 6" type="info">无效订单</el-tag>
          <el-tag v-else-if="order.status === 7" type="info">已关闭</el-tag>
        </span>
      </div>
      <div class="order-body">
        <!-- 基本信息 -->
        <el-card shadow="never" class="order-card">
          <div slot="header">订单基本信息</div>
          <el-form>
            <div class="statistic">
              <el-row>
                <el-col :span="6" :offset="0">
                  <el-form-item>
                    <div slot="label">订单号</div>
                    {{ order.id }}
                  </el-form-item>
                </el-col>
                <el-col :span="6" :offset="0">
                  <el-form-item>
                    <div slot="label">下单用户</div>
                    {{ order.createBy }}
                  </el-form-item>
                </el-col>
                <el-col :span="6" :offset="0">
                  <el-form-item>
                    <div slot="label">订单类型</div>
                    {{ order.orderType === 0?'普通订单':'秒杀订单' }}
                  </el-form-item>
                </el-col>
                <el-col :span="6" :offset="0">
                  <el-form-item>
                    <div slot="label">物流公司</div>
                    {{ order.deliveryCompany }}
                  </el-form-item>
                </el-col>
              </el-row>
              <el-row>
                <el-col :span="6" :offset="0">
                  <el-form-item>
                    <div slot="label">物流单号</div>
                    {{ order.deliverySn }}
                  </el-form-item>
                </el-col>
                <el-col :span="6" :offset="0">
                  <el-form-item>
                    <div slot="label">自动确认天数</div>
                    {{ order.autoConfirmDay }}
                  </el-form-item>
                </el-col>
                <el-col :span="6" :offset="0">
                  <el-form-item>
                    <div slot="label">积分</div>
                    {{ order.integration }}
                  </el-form-item>
                </el-col>
                <el-col :span="6" :offset="0">
                  <el-form-item>
                    <div slot="label">确认收货状态</div>
                    {{ order.confirmStatus===0?'未确认':'已确认' }}
                  </el-form-item>
                </el-col>
              </el-row>
            </div>
          </el-form>
        </el-card>
        <!-- 基本信息结束 -->
        <!-- 收货人信息 -->
        <el-card shadow="never" class="order-card">
          <div slot="header">订单收货信息</div>
          <el-form>
            <div class="statistic">
              <el-row>
                <el-col :span="6" :offset="0">
                  <el-form-item>
                    <div slot="label">收货人</div>
                    {{ order.receiverName }}
                  </el-form-item>
                </el-col>
                <el-col :span="6" :offset="0">
                  <el-form-item>
                    <div slot="label">收货电话</div>
                    {{ order.receiverPhone }}
                  </el-form-item>
                </el-col>
                <el-col :span="4" :offset="0">
                  <el-form-item>
                    <div slot="label">邮政编码</div>
                    {{ order.receiverPostCode }}
                  </el-form-item>
                </el-col>
                <el-col :span="8" :offset="0">
                  <el-form-item>
                    <div slot="label">收货地址</div>
                    {{ order.receiverProvince }}
                    {{ order.receiverCity }}
                    {{ order.receiverRegion }}
                    {{ order.receiverDetailAddress }}
                  </el-form-item>
                </el-col>
              </el-row>
            </div>
          </el-form>
        </el-card>
        <!-- 收货人信息结束 -->
        <!-- 商品信息 -->
        <el-card shadow="never" class="order-card">
          <div slot="header">
            <span>订单商品信息</span>
          </div>
          <div class="data-table">
            <el-table
              header-row-class-name="pochi-table-header"
              :data="order.itemList"
              stripe
              style="width: 100%"
            >
              <el-table-column prop="productName" label="商品名称" />
              <el-table-column prop="productPic" label="图片">
                <template slot-scope="{row}">
                  <el-image :src="row.productPic" style="width: 100px; height: 125px" fit="fill" :preview-src-list="[row.productPic]" />
                </template>
              </el-table-column>
              <el-table-column prop="productBrand" label="品牌" />
              <el-table-column prop="productPrice" label="价格" />
              <el-table-column prop="productQuantity" label="购买数量" />
              <el-table-column prop="integration" label="积分" />
            </el-table>
          </div>
          <div class="totalAmount">
            合计金额：<span style="color:red">{{ totalAmount }}</span>
          </div>
        </el-card>
        <!-- 商品信息结束 -->

        <!-- 费用信息 -->
        <el-card shadow="never" class="order-card">
          <div slot="header">订单费用信息</div>
          <el-form>
            <div class="statistic">
              <el-row>
                <el-col :span="6" :offset="0">
                  <el-form-item>
                    <div slot="label">总金额</div>
                    {{ order.totalAmount }}
                  </el-form-item>
                </el-col>
                <el-col :span="6" :offset="0">
                  <el-form-item>
                    <div slot="label">应付金额</div>
                    {{ order.payAmount }}
                  </el-form-item>
                </el-col>
                <el-col :span="6" :offset="0">
                  <el-form-item>
                    <div slot="label">运费金额</div>
                    {{ order.freightAmount }}
                  </el-form-item>
                </el-col>
                <el-col :span="6" :offset="0">
                  <el-form-item>
                    <div slot="label">优惠金额</div>
                    {{ order.couponAmount }}
                  </el-form-item>
                </el-col>
              </el-row>
            </div>
          </el-form>
        </el-card>
        <!-- 费用信息结束 -->
        <!-- 支付信息 -->
        <el-card shadow="never" class="order-card">
          <div slot="header">订单支付信息</div>
          <el-form>
            <div class="statistic">
              <el-row>
                <el-col :span="8" :offset="0">
                  <el-form-item>
                    <div slot="label">微信订单号</div>
                    {{ payOrder.wxOrderNo?payOrder.wxOrderNo:' ' }}
                  </el-form-item>
                </el-col>
                <el-col :span="8" :offset="0">
                  <el-form-item>
                    <div slot="label">外部订单号</div>
                    {{ payOrder.outTradeNo }}
                  </el-form-item>
                </el-col>
                <el-col :span="8" :offset="0">
                  <el-form-item>
                    <div slot="label">商品订单号</div>
                    {{ payOrder.orderId }}
                  </el-form-item>
                </el-col>
              </el-row>
              <el-row>
                <el-col :span="8" :offset="0">
                  <el-form-item>
                    <div slot="label">支付金额</div>
                    {{ payOrder.payAmount }}
                  </el-form-item>
                </el-col>
                <el-col :span="8" :offset="0">
                  <el-form-item>
                    <div slot="label">支付时间</div>
                    {{ payOrder.createTime }}
                  </el-form-item>
                </el-col>
                <el-col :span="8" :offset="0">
                  <el-form-item>
                    <div slot="label">支付状态</div>
                    <el-tag v-if="payOrder.status === 0">支付中</el-tag>
                    <el-tag v-else-if="payOrder.status === 1" type="success">支付成功</el-tag>
                    <el-tag v-else type="danger">支付失败</el-tag>
                  </el-form-item>
                </el-col>
              </el-row>
            </div>
          </el-form>
        </el-card>
        <!-- 支付信息结束 -->
        <!-- 操作记录 -->
        <el-card shadow="never" class="order-card">
          <div slot="header">
            <span>订单操作记录</span>
          </div>
          <div class="data-table">
            <el-table
              header-row-class-name="pochi-table-header"
              :data="historyList"
              stripe
              style="width: 100%"
            >
              <el-table-column prop="orderId" label="订单ID" />
              <el-table-column prop="operateMan" label="操作人" />
              <el-table-column prop="orderStatus" label="操作状态">
                <template slot-scope="{row}">
                  <el-tag v-if="row.orderStatus === 0">待付款</el-tag>
                  <el-tag v-else-if="row.orderStatus === 1">待确认</el-tag>
                  <el-tag v-else-if="row.orderStatus === 2">待发货</el-tag>
                  <el-tag v-else-if="row.orderStatus === 3">待签收</el-tag>
                  <el-tag v-else-if="row.orderStatus === 4">待评价</el-tag>
                  <el-tag v-else-if="row.orderStatus === 5" type="success">已完成</el-tag>
                  <el-tag v-else-if="row.orderStatus === 6" type="info">无效订单</el-tag>
                  <el-tag v-else-if="row.orderStatus === 7" type="info">已关闭</el-tag>
                </template>
              </el-table-column>
              <el-table-column prop="createTime" label="操作时间" />
            </el-table>
          </div>
        </el-card>
        <!-- 操作记录结束 -->
      </div>
    </el-card>
    <!-- 详情卡片结束 -->
  </div>
</template>

<script>
import orderApi from '@/api/shop-order'
import payApi from '@/api/shop-order-pay'
export default {
  data() {
    return {
      // 订单ID
      orderId: null,
      // 订单详情
      order: {},
      // 操作历史
      historyList: [],
      // 支付订单
      payOrder: {},
      // 当前进度条
      currentStep: 0,
      // 步骤条
      stepList: [
        { id: 0, name: '待付款', time: '' },
        { id: 1, name: '待确认', time: '' },
        { id: 2, name: '待发货', time: '' },
        { id: 3, name: '待签收', time: '' },
        { id: 4, name: '待评价', time: '' },
        { id: 5, name: '已完成', time: '' },
        { id: 6, name: '无效订单', time: '' },
        { id: 7, name: '已关闭', time: '' }
      ]
    }
  },
  computed: {
    totalAmount() {
      let money = 0
      if (this.order.itemList) {
        this.order.itemList.forEach(e => {
          money += e.productPrice * e.productQuantity
        })
      }
      return money
    }
  },
  created() {
    this.orderId = this.$route.params.id
    this.getById()
    this.getHistory()
    this.getPayOrder()
  },
  methods: {
    // 查询详情
    getById() {
      orderApi.get(this.orderId).then((res) => {
        this.order = res.data
        this.currentStep = this.order.status + 1
      })
    },
    // 查询历史数据
    getHistory() {
      orderApi.getHistory(this.orderId).then((res) => {
        this.historyList = res.data
        if (this.historyList) {
          // 操作步骤条，赋值操作时间
          this.stepList.forEach(s => {
            const item = this.historyList.find(h => h.orderStatus === s.id)
            if (item) {
              s.time = item.createTime
            }
          })
        }
      })
    },
    // 查询支付订单
    getPayOrder() {
      payApi.getByOrderId(this.orderId).then((res) => {
        this.payOrder = res.data
      })
    }
  }
}
</script>

<style scoped>
.order-step {
  margin-bottom: 20px;
}
.totalAmount {
  font-size: 14px;
  margin-top: 10px;
  text-align: right;
}
.order-card {
  margin-bottom: 20px;
}
.statistic >>> .el-row {
  border-top: 1px solid #dcdfe6;
  border-bottom: 1px solid #dcdfe6;
  border-right: 1px solid #dcdfe6;
  margin-bottom: -1px;
}

.statistic >>> .el-col {
  border-left: 1px solid #dcdfe6;
}

.statistic >>> .el-form-item__label {
  border-right: 1px solid #dcdfe6;
  text-align: center;
  width: 100%;
  background-color: #f2f6fc;
}

.statistic >>> .el-form-item {
  line-height: 45px;
  margin-bottom: 0px;
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-right: -1px;
}

.statistic >>> .el-form-item__content {
  text-align: center;
}
</style>

````



## 3.3 用户订单

用户订单功能，即在用户管理加个按钮，点击后在弹窗中分页展示该用户的订单。

### user-list

```vue
    <el-dialog
      title="用户订单"
      :visible.sync="orderDialog"
      width="85%"
    >
      <order-list :user-id="activePhone" />
    </el-dialog>
```



### order-list

```vue
  watch: {
    userId: function() {
      this.getByPage()
    }
  },
    getByPage() {
      if (this.userId) {
        this.page.params.createBy = this.userId
      }
      orderApi.getByPage(this.page).then((res) => {
        this.dataPage = res.data
      })
    },
```



# 4. 评价管理

评价管理一般不单独提供页面，而是分为商品评价和订单评价，在商品管理和订单管理分别提供按钮查询即可。

## 前端

### 列表页

```vue
<template>
  <div>
    <div class="data-table">
      <el-table
        header-row-class-name="pochi-table-header"
        :data="dataPage.list"
        stripe
        style="width: 100%"
      >
        <el-table-column prop="productId" label="商品编号" />
        <el-table-column prop="productName" label="商品名称" />
        <el-table-column prop="nickName" label="评论人" />
        <el-table-column prop="memberIcon" label="用户头像">
          <template slot-scope="{row}">
            <el-image
              style="width: 50px; height: 50px"
              :src="row.memberIcon"
              fit="fill"
              :preview-src-list="[row.memberIcon]"
            />
          </template>
        </el-table-column>
        <el-table-column prop="orderId" label="订单编号" />
        <el-table-column prop="commentType" label="评论类型" />
        <el-table-column prop="star" label="星数">
          <template slot-scope="{row}">
            <el-rate v-model="row.star" disabled :colors="colors" />
          </template>
        </el-table-column>
        <el-table-column prop="createTime" label="评论时间" />
        <el-table-column label="操作" width="170px">
          <template slot-scope="{row}">
            <el-button type="text" icon="el-icon-document" @click="toInfo(row)">详情</el-button>
          </template>
        </el-table-column>
      </el-table>
    </div>
    <!-- 分页组件开始 -->
    <div class="pageable">
      <el-pagination
        :current-page="page.pageNumber"
        :page-sizes="[10, 20, 30, 50]"
        :page-size="10"
        background
        layout="total, sizes, prev, pager, next, jumper"
        :total="dataPage.totalCount"
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
      />
    </div>
    <!-- 分页组件结束 -->
    <!-- 详情弹窗 -->
    <el-dialog
      title="评论详情"
      :visible.sync="infoDialog"
      append-to-body
      width="50%"
    >
      <comment-info :current-comment="currentComment" />
    </el-dialog>
    <!-- 详情弹窗结束 -->
  </div>
</template>

<script>
import commentApi from '@/api/shop-order-comment'
import commentInfo from './comment-info'
export default {
  components: {
    commentInfo
  },
  props: {
    productId: {
      type: String,
      default: null
    },
    orderId: {
      type: String,
      default: null
    }
  },
  data() {
    return {
      // 分页查询对象
      page: {
        // 当前页
        pageNumber: 1,
        // 每页条数
        pageSize: 10,
        // 查询参数
        params: {}
      },
      colors: ['#99A9BF', '#F7BA2A', '#FF9900'],
      // 数据分页对象
      dataPage: {},
      // 控制详情弹窗展示
      infoDialog: false,
      // 当前点击的评论
      currentComment: null
    }
  },
  watch: {
    productId: {
      immediate: true,
      handler: function() {
        if (this.productId) {
          this.page.params.productId = this.productId
          this.getByPage()
        }
      }
    },
    orderId: {
      immediate: true,
      handler: function() {
        if (this.orderId) {
          this.page.params.orderId = this.orderId
          this.getByPage()
        }
      }
    }
  },
  methods: {
    // 查看详情
    toInfo(item) {
      this.infoDialog = true
      this.currentComment = item
    },
    // 分页查询
    getByPage() {
      commentApi.getByPage(this.page).then((res) => {
        this.dataPage = res.data
      })
    },
    // 当前页发生改变
    handleCurrentChange(val) {
      this.page.pageNumber = val
      this.getByPage()
    },
    // 每页条数发生改变
    handleSizeChange(val) {
      this.page.pageSize = val
      this.getByPage()
    }
  }
}
</script>

<style>
</style>

```



### 详情页

```vue
<template>
  <div>
    <el-form label-width="80px">
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="头像">
            <el-image
              style="width: 50px; height: 50px"
              :src="currentComment.memberIcon"
              fit="fill"
              :preview-src-list="[currentComment.memberIcon]"
            />
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12" :offset="0">
          <el-form-item label="商品编号">
            {{ currentComment.productId }}
          </el-form-item>
        </el-col>
        <el-col :span="12" :offset="0">
          <el-form-item label="订单编号">
            {{ currentComment.orderId }}
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="商品名称">
            {{ currentComment.productName }}
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12" :offset="0">
          <el-form-item label="评论用户">
            {{ currentComment.nickName }}
          </el-form-item>
        </el-col>
        <el-col :span="12" :offset="0">
          <el-form-item label="评论时间">
            {{ currentComment.createTime }}
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12" :offset="0">
          <el-form-item label="评论类型">
            <span v-if="currentComment.commentType === 1">普通评论</span>
            <span v-else-if="currentComment.commentType === 2">商家回复</span>
            <span v-else>追评</span>
          </el-form-item>
        </el-col>
        <el-col :span="12" :offset="0">
          <el-form-item label="评分">
            <el-rate v-model="currentComment.star" disabled :colors="colors" />
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="图片列表">
            <el-image
              v-for="(item, index) in currentComment.picList"
              :key="index"
              style="margin: 0 10px;width: 100px; height: 150px"
              :src="item"
              fit="fill"
              :preview-src-list="[item]"
            />
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="评论内容">
            {{ currentComment.content }}
          </el-form-item>
        </el-col>
      </el-row>

    </el-form>
  </div>
</template>

<script>
export default {
  props: {
    currentComment: {
      type: Object,
      default() {
        return {}
      }
    }
  },
  data() {
    return {
      // 评分颜色
      colors: ['#99A9BF', '#F7BA2A', '#FF9900']
    }
  }
}
</script>

<style>

</style>

```



# 5. 统计

在我们的后台系统中，首页目前还有空缺，首页用来放我们的各个统计图。

我们以统计订单数、用户统计两个案例进行讲解。

## 5.1 订单数

统计订单功能这里开发两个功能，一是当月订单，二是各个状态订单占比。

### OrderMonthVo

```java
package com.jg.pochi.pojo.vo;

import lombok.Data;

import java.io.Serializable;

/**
 * @Author: 杨德石
 * @Date: 2021/1/26 22:16
 * @Version 1.0
 */
@Data
public class OrderMonthVo implements Serializable {

    private String day;

    private Integer count;

}

```

### OrderPointVo

```java
package com.jg.pochi.pojo.vo;

import lombok.Data;

import java.io.Serializable;

/**
 * @Author: 杨德石
 * @Date: 2021/1/26 22:24
 * @Version 1.0
 */
@Data
public class OrderPointVo implements Serializable {

    /**
     * 订单状态
     */
    private Integer status;

    /**
     * 中文状态
     */
    private String statusMsg;

    /**
     * 订单数
     */
    private Integer count;

}

```



### ShopOrderController

```java

    /**
     * 查询当月订单
     *
     * @return
     */
    @RequestMapping(value = "/monthOrder", method = RequestMethod.GET)
    public Result<List<OrderMonthVo>> monthOrder() {
        List<OrderMonthVo> list = shopOrderService.monthOrder();
        return new Result<>(list);
    }

    /**
     * 查询每种订单的占比
     *
     * @return
     */
    @RequestMapping(value = "/orderPoint", method = RequestMethod.GET)
    public Result<List<OrderPointVo>> orderPoint() {
        List<OrderPointVo> list = shopOrderService.orderPoint();
        return new Result<>(list);
    }
```



### ShopOrderService

```java
    /**
     * 月订单统计
     * @return
     */
    List<OrderMonthVo> monthOrder();

    /**
     * 查询每种订单占比
     * @return
     */
    List<OrderPointVo> orderPoint();
```



### ShopOrderServiceImpl

```java

    @Override
    public List<OrderMonthVo> monthOrder() {
        return shopOrderMapper.monthOrder();
    }

    @Override
    public List<OrderPointVo> orderPoint() {
        List<OrderPointVo> list = shopOrderMapper.orderPoint();
        for (OrderPointVo vo : list) {
            vo.setStatusMsg(OrderStateEnum.getStatusByCode(vo.getStatus()).getMsg());
        }
        return list;
    }
```



### ShopOrderMapper

```java
    /**
     * 月订单统计
     * @return
     */
    List<OrderMonthVo> monthOrder();

    /**
     * 查询每种订单占比
     * @return
     */
    List<OrderPointVo> orderPoint();
```



### ShopOrderMapper.xml

```xml
    <select id="monthOrder" resultType="com.jg.pochi.pojo.vo.OrderMonthVo">
        select DATE_FORMAT(create_time, '%Y-%m-%d') as day, count(*) as count
        from shop_order
        where DATE_FORMAT(create_time, '%Y-%m') = DATE_FORMAT(now(), '%Y-%m')
        group by day
        order by day asc
    </select>
    <select id="orderPoint" resultType="com.jg.pochi.pojo.vo.OrderPointVo">
        select status, count(*) as count
        from shop_order
        group by status
    </select>
```



## 5.2 用户统计

这里我们直接查询**累计消费最多的前十个用户**，查询在 `shop_user_statistic` 表中的各项信息，使用条形统计图展示

### ShopUserStatisticVo

```java
package com.jg.pochi.pojo.vo;

import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;

/**
 * @Author: 杨德石
 * @Date: 2021/1/26 23:39
 * @Version 1.0
 */
@Data
public class ShopUserStatisticVo implements Serializable {

    /**
     * 柱名
     */
    private String name;

    /**
     * 用户姓名
     */
    private String userName;

    /**
     * 数量
     */
    private BigDecimal count;

}

```



### ShopUserController

```java
    /**
     * 查询累计消费最多的前十个用户
     *
     * @return
     */
    @RequestMapping(value = "/getTopStatistic", method = RequestMethod.GET)
    public Result<List<ShopUserStatisticVo>> getTopStatistic() {
        List<ShopUserStatisticVo> list = shopUserService.getTopStatistic();
        return new Result<>(list);
    }
```



### ShopUserService

```java
    /**
     * 查询累计消费最多的前十个用户
     * @return
     */
    List<ShopUserStatisticVo> getTopStatistic();
```



### ShopUserServiceImpl

```java
    @Override
    public List<ShopUserStatisticVo> getTopStatistic() {
        List<ShopUserStatistic> list = shopUserStatisticMapper.getTopStatistic();
        List<Long> userIds = list.stream().map(ShopUserStatistic::getUserId).collect(Collectors.toList());
        List<ShopUser> userList = shopUserMapper.getByIds(userIds);
        List<ShopUserStatisticVo> voList = new ArrayList<>();
        for (ShopUserStatistic statistic : list) {
            ShopUser shopUser = userList.stream().filter(u -> u.getId().equals(statistic.getUserId())).findFirst().orElse(null);
            if (shopUser == null) {
                continue;
            }
            ShopUserStatisticVo consume = new ShopUserStatisticVo();
            consume.setUserName(shopUser.getNickname() + shopUser.getPhone());
            consume.setName("累计消费");
            consume.setCount(statistic.getConsumeAmount());
            voList.add(consume);

            ShopUserStatisticVo order = new ShopUserStatisticVo();
            order.setUserName(shopUser.getNickname() + shopUser.getPhone());
            order.setName("累计订单");
            order.setCount(new BigDecimal(statistic.getOrderCount()));
            voList.add(order);

            ShopUserStatisticVo coupon = new ShopUserStatisticVo();
            coupon.setUserName(shopUser.getNickname() + shopUser.getPhone());
            coupon.setName("优惠券数");
            coupon.setCount(new BigDecimal(statistic.getCouponCount()));
            voList.add(coupon);

            ShopUserStatisticVo comment = new ShopUserStatisticVo();
            comment.setUserName(shopUser.getNickname() + shopUser.getPhone());
            comment.setName("评价数");
            comment.setCount(new BigDecimal(statistic.getCommentCount()));
            voList.add(comment);

            ShopUserStatisticVo retOrder = new ShopUserStatisticVo();
            retOrder.setUserName(shopUser.getNickname() + shopUser.getPhone());
            retOrder.setName("退货数");
            retOrder.setCount(new BigDecimal(statistic.getReturnOrderCount()));
            voList.add(retOrder);

            ShopUserStatisticVo login = new ShopUserStatisticVo();
            login.setUserName(shopUser.getNickname() + shopUser.getPhone());
            login.setName("登录次数");
            login.setCount(new BigDecimal(statistic.getLoginCount()));
            voList.add(login);
        }
        return voList;
    }
```



### ShopUserStatisticMapper

```java
    /**
     * 查询累计消费最多的前十个用户
     * @return
     */
    List<ShopUserStatistic> getTopStatistic();
```



### ShopUserStatisticMapper.xml

```xml
    <select id="getTopStatistic" resultMap="BaseResultMap">
        select id,
               user_id,
               consume_amount,
               order_count,
               coupon_count,
               comment_count,
               return_order_count,
               login_count
        from shop_user_statistic
        order by consume_amount desc
        limit 10
    </select>
```





## 5.3 前端

本次统计我们使用阿里的 `antV` 进行开发

[官方文档](https://antv.vision/zh)

AntV主要包含 G2、G6、F2、L7 以及一套完整的图表使用和设计规范。得益于丰富的业务场景和用户需求挑战，AntV  经历多年积累与不断打磨，已支撑阿里集团内外 20000+ 业务系统，通过了日均千万级 UV 产品的严苛考验后方敢与君见。

```vue
<template>
  <div class="dashboard-container">
    <el-row :gutter="20">
      <el-col :span="16" :offset="0">
        <el-card shadow="never">
          <div slot="header">
            <span>月订单统计</span>
          </div>
          <div id="monthOrder" />
        </el-card>
      </el-col>
      <el-col :span="8" :offset="0">
        <el-card shadow="never">
          <div slot="header">
            <span>订单状态统计</span>
          </div>
          <div id="pointOrder" />
        </el-card>
      </el-col>
    </el-row>
    <el-row :gutter="20">
      <el-col :span="24" :offset="0">
        <el-card shadow="never">
          <div slot="header">
            <span>用户统计</span>
          </div>
          <div id="user" />
        </el-card>

      </el-col>
    </el-row>

  </div>
</template>

<script>
import { Chart } from '@antv/g2'
import orderApi from '@/api/shop-order'
import userApi from '@/api/shop-user'

export default {
  name: 'Dashboard',
  data() {
    return {
      // 月订单表格
      monthOrderChart: null,
      // 订单状态表格
      statusOrderChart: null
    }
  },
  mounted() {
    this.initMonthOrderCharts()
    this.getMonthOrder()
    this.initStatusOrderCharts()
    this.getStatusOrder()
    userApi.getTopStatistic().then(res => {
      const chart = new Chart({
        container: 'user',
        autoFit: true,
        height: 500
      })

      chart.data(res.data)
      chart.scale('count', {
        nice: true
      })
      chart.tooltip({
        showMarkers: false,
        shared: true
      })

      chart
        .interval()
        .position('userName*count')
        .color('name')
        .adjust([
          {
            type: 'dodge',
            marginRatio: 0
          }
        ])

      chart.interaction('active-region')

      chart.render()
    })
    // const data = [
    //   { name: 'London', 月份: 'Jan.', 月均降雨量: 18.9 },
    //   { name: 'London', 月份: 'Feb.', 月均降雨量: 28.8 },
    //   { name: 'London', 月份: 'Mar.', 月均降雨量: 39.3 },
    //   { name: 'London', 月份: 'Apr.', 月均降雨量: 81.4 },
    //   { name: 'London', 月份: 'May', 月均降雨量: 47 },
    //   { name: 'London', 月份: 'Jun.', 月均降雨量: 20.3 },
    //   { name: 'London', 月份: 'Jul.', 月均降雨量: 24 },
    //   { name: 'London', 月份: 'Aug.', 月均降雨量: 35.6 },
    //   { name: 'Berlin', 月份: 'Jan.', 月均降雨量: 12.4 },
    //   { name: 'Berlin', 月份: 'Feb.', 月均降雨量: 23.2 },
    //   { name: 'Berlin', 月份: 'Mar.', 月均降雨量: 34.5 },
    //   { name: 'Berlin', 月份: 'Apr.', 月均降雨量: 99.7 },
    //   { name: 'Berlin', 月份: 'May', 月均降雨量: 52.6 },
    //   { name: 'Berlin', 月份: 'Jun.', 月均降雨量: 35.5 },
    //   { name: 'Berlin', 月份: 'Jul.', 月均降雨量: 37.4 },
    //   { name: 'Berlin', 月份: 'Aug.', 月均降雨量: 42.4 }
    // ]
  },
  methods: {
    // 填充状态订单数据
    getStatusOrder() {
      orderApi.orderPoint().then(res => {
        const data = res.data
        this.statusOrderChart.data(data)
        this.statusOrderChart.render()
      })
    },
    // 填充月订单数据
    getMonthOrder() {
      orderApi.monthOrder().then(res => {
        const data = res.data
        this.monthOrderChart.data(data)
        // 计算总单量
        let count = 0
        data.forEach(e => {
          count += e.count
        })
        // 辅助文本
        this.monthOrderChart
          .annotation()
          .text({
            position: ['50%', '50%'],
            content: '总订单',
            style: {
              fontSize: 14,
              fill: '#8c8c8c',
              textAlign: 'center'
            },
            offsetY: -20
          })
          .text({
            position: ['50%', '50%'],
            content: count,
            style: {
              fontSize: 20,
              fill: '#8c8c8c',
              textAlign: 'center'
            },
            offsetX: -10,
            offsetY: 20
          })
          .text({
            position: ['50%', '50%'],
            content: '单',
            style: {
              fontSize: 14,
              fill: '#8c8c8c',
              textAlign: 'center'
            },
            offsetY: 20,
            offsetX: 20
          })

        this.monthOrderChart.render()
      })
    },
    // 初始化订单状态表格
    initStatusOrderCharts() {
      const chart = new Chart({
        container: 'pointOrder',
        autoFit: true,
        height: 300
      })
      chart.scale('count', {
        formatter: (val) => {
          return val
        }
      })
      chart.coordinate('theta', {
        radius: 0.75,
        innerRadius: 0.6
      })
      chart.tooltip({
        showTitle: false,
        showMarkers: false,
        itemTpl: '<li class="g2-tooltip-list-item"><span style="background-color:{color};" class="g2-tooltip-marker"></span>{name}: {value}</li>'
      })
      chart
        .interval()
        .adjust('stack')
        .position('count')
        .color('statusMsg')
        .label('count', (count) => {
          return {
            content: (data) => {
              return `${data.statusMsg}: ${count}`
            }
          }
        })
        .tooltip('statusMsg*count', (item, percent) => {
          return {
            name: item,
            value: percent
          }
        })

      chart.interaction('element-active')
      this.statusOrderChart = chart
    },
    // 初始化月订单表格
    initMonthOrderCharts() {
      const chart = new Chart({
        container: 'monthOrder',
        autoFit: true,
        height: 300
      })
      chart.scale({
        year: {
          range: [0, 1]
        },
        value: {
          min: 0,
          nice: true
        }
      })
      chart.tooltip({
        showCrosshairs: true, // 展示 Tooltip 辅助线
        shared: true
      })

      chart.line().position('day*count').label('count')
      chart.point().position('day*count')
      this.monthOrderChart = chart
    }
  }
}
</script>

```

