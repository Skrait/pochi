# 1. 商品分类

商品分类目前仅支持三层分类。对于这种有父子关系的数据，我们在前面学习菜单的时候已经知道，需要展示成树状结构，这里我们也进行树状展示。

这里我们需要提供两个树状查询接口，一个是列表页展示，一个是下拉选择展示。

列表页展示所有，树状下拉只展示前两级。

## 1.1 后端

### 1.1.1 ShopProductCategory

```vue
package com.jg.pochi.pojo;

import lombok.Data;

import java.io.Serializable;

/**
 * @Author: 杨德石
 * @Date: 2020/11/23 23:34
 * @Version 1.0
 */
@Data
public class ShopProductCategory implements Serializable {

    /**
     * ID
     */
    private Long id;

    /**
     * 父级ID
     */
    private Long parentId;

    /**
     * 名称
     */
    private String name;

    /**
     * 层级
     */
    private Integer level;

    /**
     * 是否显示在导航栏
     */
    private Integer navStatus;

    /**
     * 排序，越小越靠前
     */
    private Integer sort;

    /**
     * 图标
     */
    private String icon;

}

```

### 1.1.2 ShopProductCategoryVo

```java
package com.jg.pochi.pojo.vo;

import lombok.Data;

import java.io.Serializable;
import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2020/11/23 23:34
 * @Version 1.0
 */
@Data
public class ShopProductCategoryVo implements Serializable {

    /**
     * ID
     */
    private Long id;

    /**
     * 父级ID
     */
    private Long parentId;

    /**
     * 名称
     */
    private String name;

    /**
     * 层级
     */
    private Integer level;

    /**
     * 是否显示在导航栏
     */
    private Integer navStatus;

    /**
     * 排序，越小越靠前
     */
    private Integer sort;

    /**
     * 图标
     */
    private String icon;

    /**
     * 父级分类
     */
    private List<ShopProductCategoryVo> children;

}

```



### 1.1.3 ShopProductCategoryController

```java
package com.jg.pochi.controller;

import com.jg.pochi.common.Page;
import com.jg.pochi.common.Result;
import com.jg.pochi.pojo.ShopProductCategory;
import com.jg.pochi.pojo.vo.ShopProductCategoryVo;
import com.jg.pochi.service.ShopProductCategoryService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2020/11/23 23:38
 * @Version 1.0
 */
@RestController
@RequestMapping("/shopProductCategory")
public class ShopProductCategoryController {

    @Autowired
    private ShopProductCategoryService shopProductCategoryService;

    /**
     * 添加分类
     *
     * @param shopProductCategory
     * @return
     */
    @RequestMapping(value = "/save", method = RequestMethod.POST)
    public Result<?> save(@RequestBody ShopProductCategory shopProductCategory) {
        shopProductCategoryService.save(shopProductCategory);
        return new Result<>("添加成功");
    }

    /**
     * 修改分类
     *
     * @param shopProductCategory
     * @return
     */
    @RequestMapping(value = "/update", method = RequestMethod.PUT)
    public Result<?> update(@RequestBody ShopProductCategory shopProductCategory) {
        shopProductCategoryService.update(shopProductCategory);
        return new Result<>("修改成功");
    }

    /**
     * 根据id查询
     *
     * @param id
     * @return
     */
    @RequestMapping(value = "/get/{id}", method = RequestMethod.GET)
    public Result<ShopProductCategory> get(@PathVariable Long id) {
        ShopProductCategory category = shopProductCategoryService.get(id);
        return new Result<>(category);
    }

    /**
     * 根据id删除
     *
     * @param id
     * @return
     */
    @RequestMapping(value = "/delete/{id}", method = RequestMethod.DELETE)
    public Result<?> delete(@PathVariable Long id) {
        shopProductCategoryService.delete(id);
        return new Result<>("删除成功");
    }

    /**
     * 分页查询
     *
     * @param page
     * @return
     */
    @RequestMapping(value = "/getByPage", method = RequestMethod.POST)
    public Result<Page<ShopProductCategory>> getByPage(@RequestBody Page<ShopProductCategory> page) {
        page = shopProductCategoryService.getByPage(page);
        return new Result<>(page);
    }

    /**
     * 树形列表查询
     *
     * @return
     */
    @RequestMapping(value = "/getTree", method = RequestMethod.GET)
    public Result<List<ShopProductCategoryVo>> getTree() {
        List<ShopProductCategoryVo> list = shopProductCategoryService.getTree();
        return new Result<>(list);
    }

    /**
     * 查询树形下拉框
     * @return
     */
    @RequestMapping(value = "/getSelectTree", method = RequestMethod.GET)
    public Result<List<ShopProductCategoryVo>> getSelectTree() {
        List<ShopProductCategoryVo> list = shopProductCategoryService.getSelectTree();
        return new Result<>(list);
    }

}

```



### 1.1.4 ShopProductCategoryService

```java
package com.jg.pochi.service;

import com.jg.pochi.common.Page;
import com.jg.pochi.pojo.ShopProductCategory;
import com.jg.pochi.pojo.vo.ShopProductCategoryVo;

import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2020/11/23 23:38
 * @Version 1.0
 */
public interface ShopProductCategoryService {

    /**
     * 添加
     * @param shopProductCategory
     */
    void save(ShopProductCategory shopProductCategory);

    /**
     * 修改
     * @param shopProductCategory
     */
    void update(ShopProductCategory shopProductCategory);

    /**
     * 根据id查询
     * @param id
     * @return
     */
    ShopProductCategory get(Long id);

    /**
     * 根据id删除
     * @param id
     * @return
     */
    void delete(Long id);

    /**
     * 分页查询
     * @param page
     * @return
     */
    Page<ShopProductCategory> getByPage(Page<ShopProductCategory> page);

    /**
     * 树形查询
     * @return
     */
    List<ShopProductCategoryVo> getTree();

    /**
     * 查询树形下拉框
     * @return
     */
    List<ShopProductCategoryVo> getSelectTree();
}

```



### 1.1.5 ShopProductCategoryServiceImpl

```java
package com.jg.pochi.service.impl;

import com.jg.pochi.common.Page;
import com.jg.pochi.constant.CoreConstant;
import com.jg.pochi.enums.ResultEnums;
import com.jg.pochi.exception.PochiException;
import com.jg.pochi.mapper.ShopProductCategoryMapper;
import com.jg.pochi.pojo.ShopProductCategory;
import com.jg.pochi.pojo.vo.ShopProductCategoryVo;
import com.jg.pochi.service.ShopProductCategoryService;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

/**
 * @Author: 杨德石
 * @Date: 2020/11/23 23:38
 * @Version 1.0
 */
@Service
public class ShopProductCategoryServiceImpl implements ShopProductCategoryService {

    @Autowired
    private ShopProductCategoryMapper shopProductCategoryMapper;

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void save(ShopProductCategory shopProductCategory) {
        // 如果父级ID为空，就赋值为0
        if (shopProductCategory.getParentId() == null) {
            shopProductCategory.setParentId(CoreConstant.DEFAULT_PARENT_ID);
        }
        ShopProductCategory category = shopProductCategoryMapper.getByParentIdAndName(shopProductCategory);
        if (category != null) {
            throw new PochiException(ResultEnums.CATEGORY_EXISTS);
        }
        shopProductCategoryMapper.save(shopProductCategory);
    }

    @Override
    public void update(ShopProductCategory shopProductCategory) {
        // 如果父级ID为空，就赋值为0
        if (shopProductCategory.getParentId() == null) {
            shopProductCategory.setParentId(CoreConstant.DEFAULT_PARENT_ID);
        }
        // 如果没改名称，也没有改父级菜单的情况下，当前查出来的就是自己
        ShopProductCategory category = shopProductCategoryMapper.getByParentIdAndName(shopProductCategory);
        if (category != null && !category.getId().equals(shopProductCategory.getId())) {
            throw new PochiException(ResultEnums.CATEGORY_EXISTS);
        }
        shopProductCategoryMapper.update(shopProductCategory);
    }

    @Override
    public ShopProductCategory get(Long id) {
        return shopProductCategoryMapper.get(id);
    }

    @Override
    public void delete(Long id) {
        shopProductCategoryMapper.delete(id);
    }

    @Override
    public Page<ShopProductCategory> getByPage(Page<ShopProductCategory> page) {
        List<ShopProductCategory> list = shopProductCategoryMapper.getByPage(page);
        Integer totalCount = shopProductCategoryMapper.countByPage(page);
        page.setList(list);
        page.setTotalCount(totalCount);
        return page;
    }

    @Override
    public List<ShopProductCategoryVo> getTree() {
        // 查询出所有
        List<ShopProductCategory> list = shopProductCategoryMapper.getAll();
        // 找到父节点
        return buildTree(list);
    }

    @Override
    public List<ShopProductCategoryVo> getSelectTree() {
        // 查询出所有非三级分类
        List<ShopProductCategory> list = shopProductCategoryMapper.getSelectList();
        return buildTree(list);
    }

    /**
     * 构造树形结构
     *
     * @param list
     * @return
     */
    private List<ShopProductCategoryVo> buildTree(List<ShopProductCategory> list) {
        return list.stream().filter(e -> e.getParentId().equals(CoreConstant.DEFAULT_PARENT_ID))
                .map(e -> {
                    // 构造成VO
                    ShopProductCategoryVo vo = new ShopProductCategoryVo();
                    BeanUtils.copyProperties(e, vo);
                    return vo;
                }).map(e -> {
                    // 构造子节点
                    e.setChildren(getChildren(e, list));
                    return e;
                }).collect(Collectors.toList());
    }

    /**
     * 寻找子节点
     *
     * @param category
     * @param list
     * @return
     */
    private List<ShopProductCategoryVo> getChildren(ShopProductCategoryVo category, List<ShopProductCategory> list) {
        // 找到category所有的子节点
        return list.stream().filter(e -> e.getParentId().equals(category.getId()))
                .map(e -> {
                    // 转成VO
                    ShopProductCategoryVo vo = new ShopProductCategoryVo();
                    BeanUtils.copyProperties(e, vo);
                    return vo;
                }).map(e -> {
                    e.setChildren(getChildren(e, list));
                    return e;
                }).collect(Collectors.toList());
    }
}

```



### 1.1.6 ShopProductCategoryMapper

```java
package com.jg.pochi.mapper;

import com.jg.pochi.common.Page;
import com.jg.pochi.pojo.ShopProductCategory;
import org.springframework.stereotype.Component;

import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2020/11/8 13:46
 * @Version 1.0
 */
@Component
public interface ShopProductCategoryMapper {

    /**
     * 添加
     *
     * @param shopProductCategory
     */
    void save(ShopProductCategory shopProductCategory);

    /**
     * 根据父级ID和名称查询
     *
     * @param shopProductCategory
     * @return
     */
    ShopProductCategory getByParentIdAndName(ShopProductCategory shopProductCategory);

    /**
     * 修改
     *
     * @param shopProductCategory
     */
    void update(ShopProductCategory shopProductCategory);

    /**
     * 根据id查询
     *
     * @param id
     * @return
     */
    ShopProductCategory get(Long id);

    /**
     * 根据id删除
     *
     * @param id
     */
    void delete(Long id);

    /**
     * 分页查询
     * @param page
     * @return
     */
    List<ShopProductCategory> getByPage(Page<ShopProductCategory> page);

    /**
     * 查询总数
     * @param page
     * @return
     */
    Integer countByPage(Page<ShopProductCategory> page);

    /**
     * 查询所有
     * @return
     */
    List<ShopProductCategory> getAll();

    /**
     * 查询所有一级二级分类
     * @return
     */
    List<ShopProductCategory> getSelectList();
}

```

### 1.1.7 ShopProductCategoryMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jg.pochi.mapper.ShopProductCategoryMapper">
    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.jg.pochi.pojo.ShopProductCategory">
        <id column="id" property="id"/>
        <result column="parent_id" property="parentId"/>
        <result column="name" property="name"/>
        <result column="level" property="level"/>
        <result column="nav_status" property="navStatus"/>
        <result column="sort" property="sort"/>
        <result column="icon" property="icon"/>
    </resultMap>
    <insert id="save">
        insert into shop_product_category(parent_id, name, level, nav_status, sort, icon) value (
                                                                                                 #{parentId}, #{name},
                                                                                                 #{level}, #{navStatus},
                                                                                                 #{sort}, #{icon}
            )
    </insert>
    <update id="update">
        update shop_product_category
        set parent_id = #{parentId}
        <if test="name!=null and name!=''">
            ,name = #{name}
        </if>
        <if test="icon!=null and icon!=''">
            ,icon = #{icon}
        </if>
        <if test="level!=null">
            ,level = #{level}
        </if>
        <if test="navStatus!=null">
            ,nav_status = #{navStatus}
        </if>
        <if test="sort!=null">
            ,sort = #{sort}
        </if>
        where id = #{id}
    </update>
    <delete id="delete">
        delete
        from shop_product_category
        where id = #{id}
    </delete>
    <select id="getByParentIdAndName" resultMap="BaseResultMap">
        select id,
               parent_id,
               name
        from shop_product_category
        where parent_id = #{parentId}
          and name = #{name}
    </select>
    <select id="get" resultMap="BaseResultMap">
        select id,
               parent_id,
               name,
               level,
               nav_status,
               sort,
               icon
        from shop_product_category
        where id = #{id}
    </select>
    <select id="getByPage" resultMap="BaseResultMap">
        select id,
               parent_id,
               name,
               level,
               nav_status,
               sort,
               icon
        from shop_product_category
        order by sort
        limit #{index}, #{pageSize}
    </select>
    <select id="countByPage" resultType="java.lang.Integer">
        select count(*)
        from shop_product_category
    </select>
    <select id="getAll" resultMap="BaseResultMap">
        select id,
               parent_id,
               name,
               level,
               nav_status,
               sort,
               icon
        from shop_product_category
    </select>
    <select id="getSelectList" resultMap="BaseResultMap">
        select id,
               parent_id,
               name,
               level,
               nav_status,
               sort,
               icon
        from shop_product_category
        where level in (1, 2)
    </select>

</mapper>

```



## 1.2 前端

### 1.2.1 API

在 `api` 下创建 `shopProductCategory.js`，内容如下

```js
import request from '@/utils/request'
var group_name = 'shopProductCategory'
export default {
  getByPage(page) { // 分页查询
    return request({
      url: `/${group_name}/getByPage`,
      method: 'post',
      data: page
    })
  },
  save(shopProductCategory) { // 保存
    return request({
      url: `/${group_name}/save`,
      method: 'post',
      data: shopProductCategory
    })
  },
  get(id) { // 根据id查询
    return request({
      url: `/${group_name}/get/${id}`,
      method: 'get'
    })
  },
  getTree() { // 根据id查询
    return request({
      url: `/${group_name}/getTree`,
      method: 'get'
    })
  },
  getSelectTree() { // 根据id查询
    return request({
      url: `/${group_name}/getSelectTree`,
      method: 'get'
    })
  },
  getAll() { // 根据id查询
    return request({
      url: `/${group_name}/getAll`,
      method: 'get'
    })
  },
  update(shopProductCategory) { // 更新
    return request({
      url: `/${group_name}/update`,
      method: 'put',
      data: shopProductCategory
    })
  },
  deleteById(id) { // 根据id删除
    return request({
      url: `/${group_name}/delete`,
      method: 'put',
      data: { id: id }
    })
  }
}

```

### 1.2.2 页面编写

在 `views` 下创建 `base/category`，并分别创建 `product-category-list、product-category-add、product-category-update` 文件 。

#### product-category-list

```vue
<template>
  <div>
    <!-- 添加按钮开始 -->
    <div class="button-group">
      <el-button type="primary" size="small" icon="el-icon-plus" @click="toAdd">添加</el-button>
    </div>
    <!-- 添加按钮结束 -->
    <!-- 数据表格 -->
    <div class="data-table">
      <el-table
        header-row-class-name="pochi-table-header"
        :data="treeList"
        stripe
        row-key="id"
        style="width: 100%"
      >
        <el-table-column prop="id" label="编号" />
        <el-table-column prop="name" label="名称" />
        <el-table-column prop="level" label="级别" />
        <el-table-column prop="navStatus" label="导航栏显示">
          <template slot-scope="{row}">
            <el-tag v-if="row.navStatus === 1" type="success">是</el-tag>
            <el-tag v-else type="info">否</el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="sort" label="排序" />
        <el-table-column prop="icon" label="图标">
          <template slot-scope="{row}">
            <el-image
              style="width: 50px; height: 50px"
              :src="row.icon"
              fit="fill"
              :preview-src-list="[row.icon]"
            />
          </template>
        </el-table-column>
        <el-table-column label="操作" width="160px">
          <template slot-scope="{row}">
            <el-button type="text" icon="el-icon-edit" @click="toUpdate(row.id)">修改</el-button>
            <el-button type="text" icon="el-icon-delete" @click="toDelete(row.id)">删除</el-button>
          </template>
        </el-table-column>
      </el-table>
    </div>
    <!-- 数据表格结束 -->
    <!-- 添加弹窗开始 -->
    <el-dialog
      title="添加分类"
      :visible.sync="addDialog"
      width="40%"
    >
      <product-category-add @after="getTree" @close="closeDialog" />
    </el-dialog>
    <!-- 添加弹窗结束 -->
    <!-- 修改弹窗开始 -->
    <el-dialog
      title="修改分类"
      :visible.sync="updateDialog"
      width="40%"
    >
      <product-category-update :active-id="activeId" @after="getTree" @close="closeDialog" />
    </el-dialog>
    <!-- 修改窗结束 -->
  </div>
</template>

<script>
import categoryApi from '@/api/shop-product-category'
import productCategoryAdd from './product-category-add'
import productCategoryUpdate from './product-category-update'
export default {
  components: {
    productCategoryAdd,
    productCategoryUpdate
  },
  data() {
    return {
      // 树形列表
      treeList: [],
      // 控制添加弹窗展示
      addDialog: false,
      // 控制修改弹窗展示
      updateDialog: false,
      // 当前点击的分类ID
      activeId: null
    }
  },
  created() {
    this.getTree()
  },
  methods: {
    // 添加
    toAdd() {
      this.addDialog = true
    },
    // 修改
    toUpdate(id) {
      this.activeId = id
      this.updateDialog = true
    },
    // 关闭弹窗
    closeDialog() {
      this.addDialog = false
      this.updateDialog = false
    },
    // 删除
    toDelete(id) {
      this.$confirm('是否删除该分类?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'error'
      }).then(() => {
        categoryApi.deleteById(id).then(res => {
          this.$message.success(res.msg)
          this.getTree()
        })
      })
    },
    // 树形查询
    getTree() {
      categoryApi.getTree().then(res => {
        this.treeList = res.data
      })
    }
  }
}
</script>

<style>
</style>

```



#### product-category-add

```vue
<template>
  <div>
    <el-form :model="category" label-width="80px" size="small">
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="图标">
            <el-upload
              class="avatar-uploader"
              :action="uploadUrl"
              :show-file-list="false"
              :headers="{Authorization: token}"
              :data="{dir: 'type'}"
              :on-success="handleAvatarSuccess"
            >
              <img v-if="imageUrl" :src="imageUrl" class="avatar">
              <i v-else class="el-icon-plus avatar-uploader-icon" />
            </el-upload>
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="上级分类">
            <treeselect
              v-model="category.parentId"
              :options="selectTree"
              :normalizer="normalizer"
              :show-count="true"
              placeholder="请选择上级分类"
            />
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12" :offset="0">
          <el-form-item label="分类名称">
            <el-input v-model="category.name" placeholder="分类名称" clearable />
          </el-form-item>
        </el-col>
        <el-col :span="12" :offset="0">
          <el-form-item label="排序">
            <el-input-number v-model="category.sort" controls-position="right" style="width: 100%" placeholder="分类名称" clearable />
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12" :offset="0">
          <el-form-item label="分类层级">
            <el-radio-group v-model="category.level">
              <el-radio :label="1">1级</el-radio>
              <el-radio :label="2">2级</el-radio>
              <el-radio :label="3">3级</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-col>
        <el-col :span="12" :offset="0">
          <el-form-item label="导航显示">
            <el-radio-group v-model="category.navStatus">
              <el-radio :label="1">显示</el-radio>
              <el-radio :label="0">隐藏</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-col>
      </el-row>

      <el-form-item>
        <el-button type="primary" @click="add">添加</el-button>
      </el-form-item>
    </el-form>
  </div>
</template>

<script>
import categoryApi from '@/api/shop-product-category'
import { mapGetters } from 'vuex'
import Treeselect from '@riophae/vue-treeselect'
import '@riophae/vue-treeselect/dist/vue-treeselect.css'
export default {
  components: {
    Treeselect
  },
  data() {
    return {
      // 表单对象
      category: {},
      // 上传图片回显
      imageUrl: null,
      // 上传图片路径
      uploadUrl: process.env.VUE_APP_UPLOAD_URL,
      // 下拉选择
      selectTree: []
    }
  },
  computed: {
    ...mapGetters([
      'token'
    ])
  },
  created() {
    this.getSelectTree()
  },
  methods: {
    // 上传成功回显
    handleAvatarSuccess(res, file) {
      this.imageUrl = res.data
      this.category.icon = this.imageUrl
    },
    // 设置属性下拉框结构
    normalizer(node) {
      if (!node.children) {
        delete node.children
      }
      return {
        id: node.id,
        label: node.name,
        children: node.children
      }
    },
    // 添加
    add() {
      categoryApi.save(this.category).then(res => {
        this.$message.success(res.msg)
        this.$emit('after')
        this.$emit('close')
      })
    },
    // 查询下拉选择树
    getSelectTree() {
      categoryApi.getSelectTree().then(res => {
        this.selectTree = res.data
      })
    }
  }
}
</script>

<style>
  .avatar-uploader .el-upload {
    border: 1px dashed #d9d9d9;
    border-radius: 6px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }
  .avatar-uploader .el-upload:hover {
    border-color: #409EFF;
  }
  .avatar-uploader-icon {
    font-size: 28px;
    color: #8c939d;
    width: 90px;
    height: 90px;
    line-height: 90px;
    text-align: center;
  }
  .avatar {
    width: 90px;
    height: 90px;
    display: block;
  }
</style>

```



#### product-category-update

```vue
<template>
  <div>
    <el-form :model="category" label-width="80px" size="small">
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="图标">
            <el-upload
              class="avatar-uploader"
              :action="uploadUrl"
              :show-file-list="false"
              :headers="{Authorization: token}"
              :data="{dir: 'type'}"
              :on-success="handleAvatarSuccess"
            >
              <img v-if="imageUrl" :src="imageUrl" class="avatar">
              <i v-else class="el-icon-plus avatar-uploader-icon" />
            </el-upload>
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="上级分类">
            <treeselect
              v-model="category.parentId"
              :options="selectTree"
              :normalizer="normalizer"
              :show-count="true"
              placeholder="请选择上级分类"
            />
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12" :offset="0">
          <el-form-item label="分类名称">
            <el-input v-model="category.name" placeholder="分类名称" clearable />
          </el-form-item>
        </el-col>
        <el-col :span="12" :offset="0">
          <el-form-item label="排序">
            <el-input-number v-model="category.sort" controls-position="right" style="width: 100%" placeholder="分类名称" clearable />
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12" :offset="0">
          <el-form-item label="分类层级">
            <el-radio-group v-model="category.level">
              <el-radio :label="1">1级</el-radio>
              <el-radio :label="2">2级</el-radio>
              <el-radio :label="3">3级</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-col>
        <el-col :span="12" :offset="0">
          <el-form-item label="导航显示">
            <el-radio-group v-model="category.navStatus">
              <el-radio :label="1">显示</el-radio>
              <el-radio :label="0">隐藏</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-col>
      </el-row>

      <el-form-item>
        <el-button type="primary" @click="update">修改</el-button>
      </el-form-item>
    </el-form>
  </div>
</template>

<script>
import categoryApi from '@/api/shop-product-category'
import { mapGetters } from 'vuex'
import Treeselect from '@riophae/vue-treeselect'
import '@riophae/vue-treeselect/dist/vue-treeselect.css'
export default {
  components: {
    Treeselect
  },
  props: {
    activeId: {
      type: String,
      default: null
    }
  },
  data() {
    return {
      // 表单对象
      category: {},
      // 上传图片回显
      imageUrl: null,
      // 上传图片路径
      uploadUrl: process.env.VUE_APP_UPLOAD_URL,
      // 下拉选择
      selectTree: []
    }
  },
  computed: {
    ...mapGetters([
      'token'
    ])
  },
  watch: {
    activeId: {
      immediate: true,
      handler: function(newVal, oldVal) {
        this.getById(newVal)
      }
    }
  },
  created() {
    this.getSelectTree()
  },
  methods: {
    // 上传成功回显
    handleAvatarSuccess(res, file) {
      this.imageUrl = res.data
      this.category.icon = this.imageUrl
    },
    // 设置属性下拉框结构
    normalizer(node) {
      if (!node.children) {
        delete node.children
      }
      return {
        id: node.id,
        label: node.name,
        children: node.children
      }
    },
    // 修改
    update() {
      categoryApi.update(this.category).then(res => {
        this.$message.success(res.msg)
        this.$emit('after')
        this.$emit('close')
      })
    },
    // 查询下拉选择树
    getSelectTree() {
      categoryApi.getSelectTree().then(res => {
        this.selectTree = res.data
      })
    },
    // 根据id查询
    getById(id) {
      categoryApi.get(id).then(res => {
        this.category = res.data
      })
    }
  }
}
</script>

<style>

</style>

```



# 2. 品牌管理

品牌管理需要跟商品分类进行关联，关系是多对多关系。因此我们在添加和修改时需要提交多个商品分类ID，而查询详情时则需要展示商品分类名称，因此这里需要创建 VO 和DTO

这里我们除了增删改查之外，还需要 `getUpdate` 方法，用于修改页的回显

## 2.1 后端

### 2.1.1 ShopBrand

```java
package com.jg.pochi.pojo;

import lombok.Data;

import java.io.Serializable;

/**
 * @Author: 杨德石
 * @Date: 2020/11/24 23:34
 * @Version 1.0
 */
@Data
public class ShopBrand implements Serializable {

    /**
     * 编号
     */
    private Long id;
    /**
     * 名称
     */
    private String name;

    /**
     * 排序
     */
    private Long sort;

    /**
     * 是否显示
     */
    private Integer showStatus;
    /**
     * logo
     */
    private String logo;

}

```



### 2.1.2 ShopBrandVo

```java
package com.jg.pochi.pojo.vo;

import com.jg.pochi.pojo.ShopProductCategory;
import lombok.Data;

import java.io.Serializable;
import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2020/11/24 23:36
 * @Version 1.0
 */
@Data
public class ShopBrandVo implements Serializable {

    /**
     * 编号
     */
    private Long id;
    /**
     * 名称
     */
    private String name;

    /**
     * 排序
     */
    private Long sort;

    /**
     * 是否显示
     */
    private Integer showStatus;
    /**
     * logo
     */
    private String logo;
    /**
     * 分类集合
     */
    private List<ShopProductCategory> categoryList;

}

```



### 2.1.3 ShopBrandDto

```java
package com.jg.pochi.pojo.dto;

import lombok.Data;

import java.io.Serializable;
import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2020/11/24 23:35
 * @Version 1.0
 */
@Data
public class ShopBrandDto implements Serializable {

    /**
     * 编号
     */
    private Long id;
    /**
     * 名称
     */
    private String name;

    /**
     * 排序
     */
    private Long sort;

    /**
     * 是否显示
     */
    private Integer showStatus;
    /**
     * logo
     */
    private String logo;
    /**
     * 分类ID集合
     */
    private List<Long> categoryIds;

}

```



### 2.1.4 ShopBrandController

```java
package com.jg.pochi.controller;

import com.jg.pochi.common.Page;
import com.jg.pochi.common.Result;
import com.jg.pochi.pojo.ShopBrand;
import com.jg.pochi.pojo.dto.ShopBrandDto;
import com.jg.pochi.pojo.vo.ShopBrandVo;
import com.jg.pochi.service.ShopBrandService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

/**
 * @Author: 杨德石
 * @Date: 2020/11/24 23:38
 * @Version 1.0
 */
@RestController
@RequestMapping("/category")
public class ShopBrandController {

    @Autowired
    private ShopBrandService shopBrandService;

    /**
     * 添加
     * @param shopBrandDto
     * @return
     */
    @RequestMapping(value = "/save", method = RequestMethod.POST)
    public Result<?> save(@RequestBody ShopBrandDto shopBrandDto) {
        shopBrandService.save(shopBrandDto);
        return new Result<>("添加成功");
    }

    /**
     * 修改
     * @param shopBrandDto
     * @return
     */
    @RequestMapping(value = "/update", method = RequestMethod.PUT)
    public Result<?> update(@RequestBody ShopBrandDto shopBrandDto) {
        shopBrandService.update(shopBrandDto);
        return new Result<>("修改成功");
    }

    /**
     * 根据id删除
     * @param id
     * @return
     */
    @RequestMapping(value = "/delete/{id}", method = RequestMethod.DELETE)
    public Result<?> delete(@PathVariable Long id) {
        shopBrandService.delete(id);
        return new Result<>("删除成功");
    }

    /**
     * 根据id查询
     * @param id
     * @return
     */
    @RequestMapping(value = "/get/{id}", method = RequestMethod.GET)
    public Result<ShopBrandVo> get(@PathVariable Long id) {
        ShopBrandVo vo = shopBrandService.get(id);
        return new Result<>(vo);
    }

    /**
     * 根据id查询用于修改的数据回显
     * @param id
     * @return
     */
    @RequestMapping(value = "/getUpdate/{id}", method = RequestMethod.GET)
    public Result<ShopBrandDto> getUpdate(@PathVariable Long id) {
        ShopBrandDto vo = shopBrandService.getUpdate(id);
        return new Result<>(vo);
    }

    /**
     * 分页查询
     * @param page
     * @return
     */
    @RequestMapping(value = "/getByPage",  method = RequestMethod.POST)
    public Result<Page<ShopBrand>> getByPage(@RequestBody Page<ShopBrand> page) {
        page = shopBrandService.getByPage(page);
        return new Result<>(page);
    }

}

```



### 2.1.5 ShopBrandService

```java
package com.jg.pochi.service;

import com.jg.pochi.common.Page;
import com.jg.pochi.pojo.ShopBrand;
import com.jg.pochi.pojo.dto.ShopBrandDto;
import com.jg.pochi.pojo.vo.ShopBrandVo;

/**
 * @Author: 杨德石
 * @Date: 2020/11/24 23:37
 * @Version 1.0
 */
public interface ShopBrandService {

    /**
     * 添加
     * @param shopBrandDto
     */
    void save(ShopBrandDto shopBrandDto);

    /**
     * 修改
     * @param shopBrandDto
     */
    void update(ShopBrandDto shopBrandDto);

    /**
     * 根据id删除
     * @param id
     */
    void delete(Long id);

    /**
     * 根据id查询
     * @param id
     * @return
     */
    ShopBrandVo get(Long id);

    /**
     * 查询用于回显的数据
     * @param id
     * @return
     */
    ShopBrandDto getUpdate(Long id);

    /**
     * 分页查询
     * @param page
     * @return
     */
    Page<ShopBrand> getByPage(Page<ShopBrand> page);
}

```



### 2.1.6 ShopBrandServiceImpl

```java
package com.jg.pochi.service.impl;

import com.jg.pochi.common.Page;
import com.jg.pochi.mapper.ShopBrandCategoryMapper;
import com.jg.pochi.mapper.ShopBrandMapper;
import com.jg.pochi.mapper.ShopProductCategoryMapper;
import com.jg.pochi.pojo.ShopBrand;
import com.jg.pochi.pojo.ShopBrandCategory;
import com.jg.pochi.pojo.ShopProductCategory;
import com.jg.pochi.pojo.dto.ShopBrandDto;
import com.jg.pochi.pojo.vo.ShopBrandVo;
import com.jg.pochi.service.ShopBrandService;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.CollectionUtils;

import java.util.List;
import java.util.stream.Collectors;

/**
 * @Author: 杨德石
 * @Date: 2020/11/24 23:38
 * @Version 1.0
 */
@Service
public class ShopBrandServiceImpl implements ShopBrandService {

    @Autowired
    private ShopBrandMapper shopBrandMapper;
    @Autowired
    private ShopBrandCategoryMapper shopBrandCategoryMapper;
    @Autowired
    private ShopProductCategoryMapper shopProductCategoryMapper;

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void save(ShopBrandDto shopBrandDto) {
        // 转成实体类
        ShopBrand shopBrand = new ShopBrand();
        BeanUtils.copyProperties(shopBrandDto, shopBrand);
        // 将品牌存库
        shopBrandMapper.save(shopBrand);
        // 将品牌-分类存库
        // 判断分类ID集合是否为空，不为空就入库
        if (!CollectionUtils.isEmpty(shopBrandDto.getCategoryIds())) {
            List<ShopBrandCategory> brandCategoryList = shopBrandDto.getCategoryIds().stream().map(cid -> {
                ShopBrandCategory shopBrandCategory = new ShopBrandCategory();
                shopBrandCategory.setCategoryId(cid);
                shopBrandCategory.setBrandId(shopBrand.getId());
                return shopBrandCategory;
            }).collect(Collectors.toList());
            // 存库
            shopBrandCategoryMapper.saveBatch(brandCategoryList);
        }
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void update(ShopBrandDto shopBrandDto) {
        // 转成实体类
        ShopBrand shopBrand = new ShopBrand();
        BeanUtils.copyProperties(shopBrandDto, shopBrand);
        // 修改
        shopBrandMapper.update(shopBrand);
        // 将品牌-分类删除
        shopBrandCategoryMapper.deleteByBrandId(shopBrand.getId());
        // 将品牌-分类存库
        // 判断分类ID集合是否为空，不为空就入库
        if (!CollectionUtils.isEmpty(shopBrandDto.getCategoryIds())) {
            List<ShopBrandCategory> brandCategoryList = shopBrandDto.getCategoryIds().stream().map(cid -> {
                ShopBrandCategory shopBrandCategory = new ShopBrandCategory();
                shopBrandCategory.setCategoryId(cid);
                shopBrandCategory.setBrandId(shopBrand.getId());
                return shopBrandCategory;
            }).collect(Collectors.toList());
            // 存库
            shopBrandCategoryMapper.saveBatch(brandCategoryList);
        }
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void delete(Long id) {
        shopBrandMapper.delete(id);
        shopBrandCategoryMapper.deleteByBrandId(id);
    }

    @Override
    public ShopBrandVo get(Long id) {
        // 查询出品牌
        ShopBrand shopBrand = shopBrandMapper.get(id);
        // 转成VO
        ShopBrandVo shopBrandVo = new ShopBrandVo();
        BeanUtils.copyProperties(shopBrand, shopBrandVo);
        // 根据品牌id查询品牌-分类关联关系
        List<ShopBrandCategory> shopBrandCategoryList = shopBrandCategoryMapper.getByBrandId(id);
        if (!CollectionUtils.isEmpty(shopBrandCategoryList)) {
            // 取出分类ID
            List<Long> categoryIds = shopBrandCategoryList.stream().map(ShopBrandCategory::getCategoryId).collect(Collectors.toList());
            // 根据关联关系查询分类
            List<ShopProductCategory> categoryList = shopProductCategoryMapper.getByIds(categoryIds);
            shopBrandVo.setCategoryList(categoryList);
        }
        return shopBrandVo;
    }

    @Override
    public ShopBrandDto getUpdate(Long id) {
        ShopBrand shopBrand = shopBrandMapper.get(id);
        // 转成DTO
        ShopBrandDto shopBrandDto = new ShopBrandDto();
        BeanUtils.copyProperties(shopBrand, shopBrandDto);
        // 查询品牌-分类关系
        List<ShopBrandCategory> brandCategoryList = shopBrandCategoryMapper.getByBrandId(id);
        // 判断集合是否为空，不为空就取出分类ID集合
        if (!CollectionUtils.isEmpty(brandCategoryList)) {
            List<Long> categoryIds = brandCategoryList.stream().map(ShopBrandCategory::getCategoryId).collect(Collectors.toList());
            // set进dto
            shopBrandDto.setCategoryIds(categoryIds);
        }
        return shopBrandDto;
    }

    @Override
    public Page<ShopBrand> getByPage(Page<ShopBrand> page) {
        List<ShopBrand> list = shopBrandMapper.getByPage(page);
        Integer totalCount = shopBrandMapper.countByPage(page);
        page.setList(list);
        page.setTotalCount(totalCount);
        return page;
    }
}

```



### 2.1.7 ShopBrandMapper

```java
package com.jg.pochi.mapper;

import com.jg.pochi.common.Page;
import com.jg.pochi.pojo.ShopBrand;
import org.springframework.stereotype.Component;

import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2020/11/8 13:46
 * @Version 1.0
 */
@Component
public interface ShopBrandMapper {

    /**
     * 添加
     * @param shopBrand
     */
    void save(ShopBrand shopBrand);

    /**
     * 修改
     * @param shopBrand
     */
    void update(ShopBrand shopBrand);

    /**
     * 根据id删除
     * @param id
     */
    void delete(Long id);

    /**
     * 根据id查询
     * @param id
     * @return
     */
    ShopBrand get(Long id);

    /**
     * 分页查询
     * @param page
     * @return
     */
    List<ShopBrand> getByPage(Page<ShopBrand> page);

    /**
     * 查询总数
     * @param page
     * @return
     */
    Integer countByPage(Page<ShopBrand> page);
}

```



### 2.1.8 ShopBrandMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jg.pochi.mapper.ShopBrandMapper">
    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.jg.pochi.pojo.ShopBrand">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="sort" property="sort"/>
        <result column="show_status" property="showStatus"/>
        <result column="logo" property="logo"/>
    </resultMap>
    <insert id="save" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        insert into shop_brand(name, sort, show_status, logo)
        values (#{name}, #{sort}, #{showStatus}, #{logo})
    </insert>
    <update id="update">
        update shop_brand
        <set>
            <if test="name!=null and name!=''">
                name = #{name},
            </if>
            <if test="logo!=null and logo!=''">
                logo = #{logo},
            </if>
            <if test="sort!=null">
                sort = #{sort},
            </if>
            <if test="showStatus!=null">
                show_status = #{showStatus}
            </if>
        </set>
        where id = #{id}
    </update>
    <delete id="delete">
        delete
        from shop_brand
        where id = #{id}
    </delete>
    <select id="get" resultMap="BaseResultMap">
        select id, name, sort, show_status, logo
        from shop_brand
        where id = #{id}
    </select>
    <select id="getByPage" resultMap="BaseResultMap">
        select id, name, sort, show_status, logo
        from shop_brand
        <where>
            <if test="params.name!=null">
                name like concat('%',#{params.name} ,'%')
            </if>
        </where>
        order by sort
        limit #{index}, #{pageSize}
    </select>
    <select id="countByPage" resultType="java.lang.Integer">
        select count(*)
        from shop_brand
        <where>
            <if test="params.name!=null">
                name like concat('%',#{params.name} ,'%')
            </if>
        </where>
    </select>


</mapper>

```



### 2.1.9 ShopBrandCategory

```java
package com.jg.pochi.pojo;

import lombok.Data;

import java.io.Serializable;

/**
 * @Author: 杨德石
 * @Date: 2020/11/24 23:33
 * @Version 1.0
 */
@Data
public class ShopBrandCategory implements Serializable {

    /**
     * 编号
     */
    private Long id;
    /**
     * 品牌ID
     */
    private Long brandId;
    /**
     * 分类ID
     */
    private Long categoryId;

}

```





### 2.1.10 ShopBrandCategoryMapper

```java
package com.jg.pochi.mapper;

import com.jg.pochi.pojo.ShopBrandCategory;
import org.springframework.stereotype.Component;

import java.util.List;

/**
 * @Author: 杨德石
 * @Date: 2020/11/8 13:46
 * @Version 1.0
 */
@Component
public interface ShopBrandCategoryMapper {

    /**
     * 批量插入
     * @param brandCategoryList
     */
    void saveBatch(List<ShopBrandCategory> brandCategoryList);

    /**
     * 根据品牌ID删除
     * @param id
     */
    void deleteByBrandId(Long id);

    /**
     * 根据品牌ID查询
     * @param id
     * @return
     */
    List<ShopBrandCategory> getByBrandId(Long id);
}

```



### 2.1.11 ShopBrandCategoryMapper.xml

```java
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jg.pochi.mapper.ShopBrandCategoryMapper">
    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.jg.pochi.pojo.ShopBrandCategory">
        <id column="id" property="id"/>
        <result column="category_id" property="categoryId"/>
        <result column="brand_id" property="brandId"/>
    </resultMap>
    <insert id="saveBatch">
        insert into shop_brand_category(brand_id, category_id) values
        <foreach collection="list" separator="," item="item">
            (#{item.brandId}, #{item.categoryId})
        </foreach>
    </insert>
    <delete id="deleteByBrandId">
        delete
        from shop_brand_category
        where brand_id = #{brandId}
    </delete>
    <select id="getByBrandId" resultMap="BaseResultMap">
        select id, brand_id, category_id
        from shop_brand_category
        where brand_id = #{brandId}
    </select>

</mapper>

```



##  2.2 前端

### 2.2.1 API

在 `api` 下创建文件 `shopBrand.js`，内容如下

```js
import request from '@/utils/request'
var group_name = 'shopBrand'
export default {
  getByPage(page) { // 分页查询
    return request({
      url: `/${group_name}/getByPage`,
      method: 'post',
      data: page
    })
  },
  save(shopBrand) { // 保存
    return request({
      url: `/${group_name}/save`,
      method: 'post',
      data: shopBrand
    })
  },
  get(id) { // 根据id查询
    return request({
      url: `/${group_name}/get/${id}`,
      method: 'get'
    })
  },
  update(shopBrand) { // 更新
    return request({
      url: `/${group_name}/update`,
      method: 'put',
      data: shopBrand
    })
  },
  deleteById(id) { // 根据id删除
    return request({
      url: `/${group_name}/delete`,
      method: 'put',
      data: { id: id }
    })
  }
}

```

### 2.2.2  页面编写

在 `views` 下创建 `base/brand`，并分别创建 `shop-brand-list、shop-brand-add、shop-brand-update、shop-brand-info` 文件 。并在系统配置路由 

#### product-brand-list

```vue
<template>
  <div>
    <!-- 搜索栏 -->
    <div class="search-form">
      <el-form :model="page.params" :inline="true" size="small">
        <el-form-item>
          <el-input v-model="page.params.name" clearable placeholder="品牌名称" />
        </el-form-item>
        <el-form-item>
          <el-button type="primary" icon="el-icon-search" @click="search">查询</el-button>
          <el-button type="warning" icon="el-icon-refresh" @click="page.params = {}">重置</el-button>
        </el-form-item>
      </el-form>
    </div>
    <!-- 搜索栏结束 -->
    <!-- 添加按钮开始 -->
    <div class="button-group">
      <el-button type="primary" size="small" icon="el-icon-plus" @click="toAdd">添加</el-button>
    </div>
    <!-- 添加按钮结束 -->
    <!-- 列表页 -->
    <div class="data-table">
      <el-table
        header-row-class-name="pochi-table-header"
        :data="dataPage.list"
        stripe
        style="width: 100%"
      >
        <el-table-column prop="name" label="品牌名称" />
        <el-table-column prop="showStatus" label="是否显示">
          <template slot-scope="{row}">
            <el-tag v-if="row.showStatus === 1" type="success">是</el-tag>
            <el-tag v-else type="info">否</el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="sort" label="排序" />
        <el-table-column prop="logo" label="logo">
          <template slot-scope="{row}">
            <el-image
              style="width: 50px; height: 50px"
              :src="row.logo"
              :preview-src-list="[row.logo]"
              fit="fill"
            />
          </template>
        </el-table-column>
        <el-table-column label="操作">
          <template slot-scope="{row}">
            <el-button type="text" icon="el-icon-document" @click="toInfo(row.id)">详情</el-button>
            <el-dropdown class="handle-button">
              <span class="el-dropdown-link">
                操作<i class="el-icon-arrow-down el-icon--right" />
              </span>
              <el-dropdown-menu slot="dropdown">
                <el-dropdown-item @click.native="toUpdate(row.id)">
                  <el-button type="text" icon="el-icon-edit">修改</el-button>
                </el-dropdown-item>
                <el-dropdown-item @click.native="toDelete(row.id)">
                  <el-button type="text" icon="el-icon-delete">删除</el-button>
                </el-dropdown-item>
              </el-dropdown-menu>
            </el-dropdown>
          </template>
        </el-table-column>
      </el-table>
    </div>
    <!-- 列表页结束 -->
    <!-- 分页组件开始 -->
    <div class="pageable">
      <el-pagination
        :current-page="page.pageNumber"
        :page-sizes="[10, 20, 30, 50]"
        :page-size="10"
        background
        layout="total, sizes, prev, pager, next, jumper"
        :total="dataPage.totalCount"
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
      />
    </div>
    <!-- 分页组件结束 -->
    <!-- 添加弹窗 -->
    <el-dialog
      title="添加品牌"
      :visible.sync="addDialog"
      width="40%"
    >
      <shop-brand-add @after="getByPage" @close="closeDialog" />
    </el-dialog>
    <!-- 添加弹窗结束 -->
    <!-- 修改弹窗 -->
    <el-dialog
      title="修改品牌"
      :visible.sync="updateDialog"
      width="40%"
    >
      <shop-brand-update :active-id="activeId" @after="getByPage" @close="closeDialog" />
    </el-dialog>
    <!-- 修改弹窗结束 -->
    <!-- 详情弹窗 -->
    <el-dialog
      title="详情品牌"
      :visible.sync="infoDialog"
      width="40%"
    >
      <shop-brand-info :active-id="activeId" />
    </el-dialog>
    <!-- 详情弹窗结束 -->
  </div>
</template>

<script>
import brandApi from '@/api/shop-brand'
import shopBrandAdd from './shop-brand-add'
import shopBrandUpdate from './shop-brand-update'
import shopBrandInfo from './shop-brand-info'
export default {
  components: {
    shopBrandAdd,
    shopBrandUpdate,
    shopBrandInfo
  },
  data() {
    return {
      // 分页对象
      page: {
        // 参数对象
        params: {},
        // 当前页
        pageNumber: 1,
        // 每页条数
        pageSize: 10
      },
      // 数据分页对象
      dataPage: {},
      // 控制添加弹窗
      addDialog: false,
      // 控制修改弹窗
      updateDialog: false,
      // 控制详情弹窗
      infoDialog: false,
      // 当前点击的品牌ID
      activeId: null
    }
  },
  created() {
    this.getByPage()
  },
  methods: {
    // 搜索
    search() {
      this.page.pageNumber = 1
      this.getByPage()
    },
    // 每页显示条数改变触发
    handleSizeChange(val) {
      this.page.pageSize = val
      this.getByPage()
    },
    // 当前页改变时触发
    handleCurrentChange(val) {
      this.page.pageNumber = val
      this.getByPage()
    },
    // 打开添加弹窗
    toAdd() {
      this.addDialog = true
    },
    // 分页查询
    getByPage() {
      brandApi.getByPage(this.page).then(res => {
        this.dataPage = res.data
      })
    },
    // 查看详情
    toInfo(id) {
      this.activeId = id
      this.infoDialog = true
    },
    // 打开修改弹窗
    toUpdate(id) {
      this.activeId = id
      this.updateDialog = true
    },
    // 删除
    toDelete(id) {
      this.$confirm('是否删除该品牌?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'error'
      }).then(() => {
        brandApi.deleteById(id).then(res => {
          this.$message.success(res.msg)
          this.getByPage()
        })
      })
    },
    // 关闭弹窗
    closeDialog() {
      this.addDialog = false
      this.updateDialog = false
      this.infoDialog = false
    }
  }
}
</script>

<style>
</style>

```



#### product-brand-add

```vue
<template>
  <div>
    <el-form :model="shopBrand" label-width="80px" size="small">
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="logo">
            <el-upload
              class="avatar-uploader"
              :action="uploadUrl"
              :show-file-list="false"
              :headers="{Authorization: token}"
              :data="{dir: 'brand'}"
              :on-success="handleAvatarSuccess"
            >
              <img v-if="imageUrl" :src="imageUrl" class="avatar">
              <i v-else class="el-icon-plus avatar-uploader-icon" />
            </el-upload>
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="品牌名称">
            <el-input v-model="shopBrand.name" clearable placeholder="品牌名称" />
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12" :offset="0">
          <el-form-item label="排序">
            <el-input-number v-model="shopBrand.sort" controls-position="right" style="width: 100%" clearable placeholder="品牌名称" />
          </el-form-item>
        </el-col>
        <el-col :span="12" :offset="0">
          <el-form-item label="显示">
            <el-radio-group v-model="shopBrand.showStatus">
              <el-radio :label="1">
                显示
              </el-radio>
              <el-radio :label="0">
                隐藏
              </el-radio>
            </el-radio-group>
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="商品分类">
            <el-select v-model="shopBrand.categoryIds" style="width: 100%" multiple placeholder="请选择分类" clearable filterable>
              <el-option
                v-for="item in categoryList"
                :key="item.id"
                :label="item.name"
                :value="item.id"
              />
            </el-select>
          </el-form-item>
        </el-col>
      </el-row>

      <el-form-item>
        <el-button type="primary" @click="add">添加</el-button>
      </el-form-item>
    </el-form>

  </div>
</template>

<script>
import categoryApi from '@/api/shop-product-category'
import brandApi from '@/api/shop-brand'
import { mapGetters } from 'vuex'
export default {
  data() {
    return {
      // 表单对象
      shopBrand: {},
      // 商品分类列表
      categoryList: [],
      // 上传图片回显
      imageUrl: null,
      // 上传图片路径
      uploadUrl: process.env.VUE_APP_UPLOAD_URL
    }
  },
  computed: {
    ...mapGetters([
      'token'
    ])
  },
  created() {
    this.getAllCategory()
  },
  methods: {
    // 上传成功回显
    handleAvatarSuccess(res, file) {
      this.imageUrl = res.data
      this.shopBrand.logo = this.imageUrl
    },
    // 查询所有二级商品分类
    getAllCategory() {
      categoryApi.getAllSecond().then(res => {
        this.categoryList = res.data
      })
    },
    // 添加
    add() {
      brandApi.save(this.shopBrand).then(res => {
        this.$message.success(res.msg)
        this.$emit('after')
        this.$emit('close')
      })
    }
  }
}
</script>

<style>
  .avatar-uploader .el-upload {
    border: 1px dashed #d9d9d9;
    border-radius: 6px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }
  .avatar-uploader .el-upload:hover {
    border-color: #409EFF;
  }
  .avatar-uploader-icon {
    font-size: 28px;
    color: #8c939d;
    width: 90px;
    height: 90px;
    line-height: 90px;
    text-align: center;
  }
  .avatar {
    width: 90px;
    height: 90px;
    display: block;
  }
</style>

```



#### product-brand-update

```vue
<template>
  <div>
    <el-form :model="shopBrand" label-width="80px" size="small">
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="logo">
            <el-upload
              class="avatar-uploader"
              :action="uploadUrl"
              :show-file-list="false"
              :headers="{Authorization: token}"
              :data="{dir: 'brand'}"
              :on-success="handleAvatarSuccess"
            >
              <img v-if="imageUrl" :src="imageUrl" class="avatar">
              <i v-else class="el-icon-plus avatar-uploader-icon" />
            </el-upload>
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="品牌名称">
            <el-input v-model="shopBrand.name" clearable placeholder="品牌名称" />
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12" :offset="0">
          <el-form-item label="排序">
            <el-input-number v-model="shopBrand.sort" controls-position="right" style="width: 100%" clearable placeholder="品牌名称" />
          </el-form-item>
        </el-col>
        <el-col :span="12" :offset="0">
          <el-form-item label="显示">
            <el-radio-group v-model="shopBrand.showStatus">
              <el-radio :label="1">
                显示
              </el-radio>
              <el-radio :label="0">
                隐藏
              </el-radio>
            </el-radio-group>
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="商品分类">
            <el-select v-model="shopBrand.categoryIds" style="width: 100%" multiple placeholder="请选择分类" clearable filterable>
              <el-option
                v-for="item in categoryList"
                :key="item.id"
                :label="item.name"
                :value="item.id"
              />
            </el-select>
          </el-form-item>
        </el-col>
      </el-row>

      <el-form-item>
        <el-button type="primary" @click="update">修改</el-button>
      </el-form-item>
    </el-form>

  </div>
</template>

<script>
import categoryApi from '@/api/shop-product-category'
import brandApi from '@/api/shop-brand'
import { mapGetters } from 'vuex'
export default {
  props: {
    activeId: {
      type: String,
      default: null
    }
  },
  data() {
    return {
      // 表单对象
      shopBrand: {},
      // 商品分类列表
      categoryList: [],
      // 上传图片回显
      imageUrl: null,
      // 上传图片路径
      uploadUrl: process.env.VUE_APP_UPLOAD_URL
    }
  },
  computed: {
    ...mapGetters([
      'token'
    ])
  },
  watch: {
    activeId: {
      immediate: true,
      handler: function(newVal, oldVal) {
        this.getUpdate(newVal)
      }
    }
  },
  created() {
    this.getAllCategory()
  },
  methods: {
    // 查询回显
    getUpdate(id) {
      brandApi.getUpdate(id).then(res => {
        this.shopBrand = res.data
        if (this.shopBrand.logo) {
          this.imageUrl = this.shopBrand.logo
        }
      })
    },
    // 上传成功回显
    handleAvatarSuccess(res, file) {
      this.imageUrl = res.data
      this.shopBrand.logo = this.imageUrl
    },
    // 查询所有二级商品分类
    getAllCategory() {
      categoryApi.getAllSecond().then(res => {
        this.categoryList = res.data
      })
    },
    // 修改
    update() {
      brandApi.update(this.shopBrand).then(res => {
        this.$message.success(res.msg)
        this.$emit('after')
        this.$emit('close')
      })
    }
  }
}
</script>

<style>
  .avatar-uploader .el-upload {
    border: 1px dashed #d9d9d9;
    border-radius: 6px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }
  .avatar-uploader .el-upload:hover {
    border-color: #409EFF;
  }
  .avatar-uploader-icon {
    font-size: 28px;
    color: #8c939d;
    width: 90px;
    height: 90px;
    line-height: 90px;
    text-align: center;
  }
  .avatar {
    width: 90px;
    height: 90px;
    display: block;
  }
</style>

```



#### product-brand-info

```vue
<template>
  <div>
    <el-form :model="shopBrand" label-width="80px" size="small">
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="品牌名称">
            {{ shopBrand.name }}
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="logo">
            <el-image
              style="width: 100px; height: 100px"
              :src="shopBrand.logo"
              :preview-src-list="[shopBrand.logo]"
              fit="fill"
            />
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="24" :offset="0">
          <el-form-item label="商品分类">
            <el-tag v-for="item in shopBrand.categoryList" :key="item.id" class="category-info" type="info">{{ item.name }}</el-tag>
          </el-form-item>
        </el-col>
      </el-row>
    </el-form>
  </div>
</template>

<script>
import brandApi from '@/api/shop-brand'
export default {
  props: {
    activeId: {
      type: String,
      default: null
    }
  },
  data() {
    return {
      // 回显对象
      shopBrand: {}
    }
  },
  watch: {
    activeId: {
      immediate: true,
      handler: function(newVal, oldVal) {
        this.getById(newVal)
      }
    }
  },
  methods: {
    // 查询回显
    getById(id) {
      brandApi.get(id).then(res => {
        this.shopBrand = res.data
      })
    }
  }
}
</script>

<style scoped>
.category-info {
  margin-right: 10px;
  margin-bottom: 5px;
}
</style>

```

